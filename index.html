<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PLDT Smart Org Design</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
          }
        }
      }
    }
  </script>
  <style>
    .active {
      background-color: #e0f2fe;
    }
    .active img {
      filter: brightness(0) saturate(100%) invert(59%) sepia(98%) saturate(1175%) hue-rotate(184deg) brightness(103%) contrast(101%);
    }
    .org-node {
      position: relative;
      display: inline-block;
      margin: 10px;
      padding: 15px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
      text-align: center;
    }
    .org-node:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .org-level-1 { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); }
    .org-level-2 { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); }
    .org-level-3 { background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%); }
    .org-level-4 { background: linear-gradient(135deg, #d1d5db 0%, #e5e7eb 100%); }
    
    /* Dynamic color classes */
    .org-blue-1 { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); }
    .org-blue-2 { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
    .org-blue-3 { background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%); }
    .org-blue-4 { background: linear-gradient(135deg, #3b82f6 0%, #93c5fd 100%); }
    
    .org-green-1 { background: linear-gradient(135deg, #14532d 0%, #166534 100%); }
    .org-green-2 { background: linear-gradient(135deg, #15803d 0%, #16a34a 100%); }
    .org-green-3 { background: linear-gradient(135deg, #22c55e 0%, #4ade80 100%); }
    .org-green-4 { background: linear-gradient(135deg, #4ade80 0%, #86efac 100%); }
    
    .org-red-1 { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
    .org-red-2 { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }
    .org-red-3 { background: linear-gradient(135deg, #f87171 0%, #fca5a5 100%); }
    .org-red-4 { background: linear-gradient(135deg, #fca5a5 0%, #fecaca 100%); }
    
    .org-purple-1 { background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%); }
    .org-purple-2 { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); }
    .org-purple-3 { background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%); }
    .org-purple-4 { background: linear-gradient(135deg, #c4b5fd 0%, #ddd6fe 100%); }
    
    .org-orange-1 { background: linear-gradient(135deg, #9a3412 0%, #c2410c 100%); }
    .org-orange-2 { background: linear-gradient(135deg, #ea580c 0%, #f97316 100%); }
    .org-orange-3 { background: linear-gradient(135deg, #fb923c 0%, #fdba74 100%); }
    .org-orange-4 { background: linear-gradient(135deg, #fdba74 0%, #fed7aa 100%); }
    
    .org-teal-1 { background: linear-gradient(135deg, #134e4a 0%, #115e59 100%); }
    .org-teal-2 { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); }
    .org-teal-3 { background: linear-gradient(135deg, #2dd4bf 0%, #5eead4 100%); }
    .org-teal-4 { background: linear-gradient(135deg, #5eead4 0%, #99f6e4 100%); }
    
    .org-indigo-1 { background: linear-gradient(135deg, #312e81 0%, #3730a3 100%); }
    .org-indigo-2 { background: linear-gradient(135deg, #4338ca 0%, #4f46e5 100%); }
    .org-indigo-3 { background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); }
    .org-indigo-4 { background: linear-gradient(135deg, #818cf8 0%, #a5b4fc 100%); }
    
    .org-pink-1 { background: linear-gradient(135deg, #831843 0%, #be185d 100%); }
    .org-pink-2 { background: linear-gradient(135deg, #db2777 0%, #ec4899 100%); }
    .org-pink-3 { background: linear-gradient(135deg, #f472b6 0%, #f9a8d4 100%); }
    .org-pink-4 { background: linear-gradient(135deg, #f9a8d4 0%, #fbcfe8 100%); }
    
    .org-gray-1 { background: linear-gradient(135deg, #374151 0%, #4b5563 100%); }
    .org-gray-2 { background: linear-gradient(135deg, #4b5563 0%, #6b7280 100%); }
    .org-gray-3 { background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%); }
    .org-gray-4 { background: linear-gradient(135deg, #9ca3af 0%, #d1d5db 100%); }
    
    /* Drag and Drop Styles */
    .drag-over {
      border: 2px solid #10b981 !important;
      background-color: #f0fdf4 !important;
      transform: scale(1.02);
      transition: all 0.2s ease;
    }
    
    .dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .drop-zone-active {
      border: 2px dashed #10b981 !important;
      background-color: #f0fdf4 !important;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .sub-unit-card {
      transition: all 0.3s ease;
    }
    
    .sub-unit-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .drag-handle {
      cursor: grab;
      user-select: none;
    }
    
    .drag-handle:active {
      cursor: grabbing;
    }
    
    .org-connector {
      position: absolute;
      background: #cbd5e1;
      z-index: -1;
    }
    .org-connector-solid {
      position: absolute;
      background: #475569;
      z-index: -1;
    }
    .org-connector-dashed {
      position: absolute;
      background: repeating-linear-gradient(
        to right,
        #475569 0px,
        #475569 8px,
        transparent 8px,
        transparent 16px
      );
      z-index: -1;
    }
    .org-connector-vertical {
      width: 2px;
    }
    .org-connector-horizontal {
      height: 2px;
    }
    .org-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .org-children {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 30px;
      position: relative;
    }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">
  <!-- Login Screen -->
  <div id="login-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-lg w-80 border border-blue-200">
      <div class="text-center mb-8">
        <img id="login-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-10 sm:h-12 mx-auto mb-4 max-w-full object-contain" alt="Company Logo" />
        <h2 class="text-xl sm:text-2xl font-bold text-blue-900 mb-2">Organization Design Portal</h2>
        <p class="text-blue-600 text-sm">Please enter your credentials to continue</p>
      </div>
      
      <!-- Regular Login Form -->
      <div id="login-form">
        <form onsubmit="login(event)">
          <div class="mb-4">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Username</label>
            <input type="text" id="username" class="w-full px-3 py-2 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
            <div id="access-indicator" class="mt-2 text-sm font-medium hidden">
              <span id="admin-indicator" class="text-purple-600 hidden">ğŸ”‘ Administrator Access Detected</span>
              <span id="viewer-indicator" class="text-blue-600 hidden">ğŸ‘¤ Viewer Access</span>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Password</label>
            <div class="relative">
              <input type="password" id="password" class="w-full px-3 py-2 pr-10 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
              <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-blue-600 hover:text-blue-800">
                <svg id="eye-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <svg id="eye-off-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="w-full bg-blue-900 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition duration-200 font-semibold shadow-md">
            Log In
          </button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="showPasswordReset()" class="text-blue-600 text-sm hover:text-blue-800 underline">
            Reset Password / Request Access
          </button>
        </div>
      </div>

      <!-- Password Reset Form -->
      <div id="reset-form" class="hidden">
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-900 mb-2">Reset Password / Request Access</h3>
          <p class="text-blue-600 text-sm">Enter your username to reset password or request viewer access</p>
        </div>
        <form onsubmit="requestPasswordReset(event)">
          <div class="mb-5">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Request Type</label>
            <select id="request-type" onchange="toggleRequestFields()" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50">
              <option value="reset">Reset Existing Password</option>
              <option value="access">Request New Viewer Access</option>
            </select>
          </div>
          
          <!-- Reset Password Fields -->
          <div id="reset-fields">
            <div class="mb-5">
              <label class="block text-blue-900 text-sm font-semibold mb-2">ID Number</label>
              <input type="text" id="reset-username" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
            </div>
          </div>
          
          <!-- New Access Fields -->
          <div id="access-fields" class="hidden">
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Company Email</label>
              <input type="email" id="company-email" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="your.name@pldt.com.ph">
            </div>
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">ID Number</label>
              <input type="text" id="access-id-number" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Enter your employee ID">
            </div>
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Preferred Password</label>
              <input type="password" id="preferred-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Minimum 8 characters" minlength="8">
            </div>
            <div class="mb-5">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Confirm Password</label>
              <input type="password" id="confirm-preferred-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Confirm your password" minlength="8">
            </div>
          </div>
          
          <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
            Submit Request
          </button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="showLoginForm()" class="text-blue-600 text-sm hover:text-blue-800 underline">
            â† Back to Login
          </button>
        </div>
      </div>

      <!-- Set New Password Form -->
      <div id="new-password-form" class="hidden">
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-900 mb-2">Set New Password</h3>
          <p class="text-blue-600 text-sm">Create your new password</p>
        </div>
        <form onsubmit="setNewPassword(event)">
          <div class="mb-5">
            <label class="block text-blue-900 text-sm font-semibold mb-2">New Password</label>
            <input type="password" id="new-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required minlength="8">
          </div>
          <div class="mb-6">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Confirm Password</label>
            <input type="password" id="confirm-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required minlength="8">
          </div>
          <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
            Set Password
          </button>
        </form>
      </div>

      <div id="login-error" class="mt-4 text-red-600 text-sm text-center hidden bg-red-50 p-3 rounded-lg border border-red-200">
        Invalid credentials. Please try again.
      </div>
      <div id="login-success" class="mt-4 text-green-600 text-sm text-center hidden bg-green-50 p-3 rounded-lg border border-green-200">
        Request submitted successfully!
      </div>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="user-management-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-blue-900">User Management</h3>
        <button onclick="closeUserManagement()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Password Reset Requests -->
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-blue-900 mb-4">ğŸ”‘ Password Reset Requests</h4>
          <div id="reset-requests" class="space-y-3">
            <!-- Reset requests will be populated here -->
          </div>
        </div>

        <!-- Access Requests -->
        <div class="bg-green-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-green-900 mb-4">ğŸ‘¥ New Access Requests</h4>
          <div id="access-requests" class="space-y-3">
            <!-- Access requests will be populated here -->
          </div>
        </div>

        <!-- Approved Users -->
        <div class="bg-gray-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">âœ… Approved Users</h4>
          <div id="approved-users" class="space-y-3">
            <!-- Approved users will be populated here -->
          </div>
        </div>

        <!-- Admin Controls -->
        <div class="bg-purple-50 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-purple-900 mb-4">âš™ï¸ Admin Controls</h4>
          <div class="space-y-3">
            <button onclick="changeAdminPassword()" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 text-sm">
              Change Admin Password
            </button>
            <button onclick="exportUserList()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm">
              Export User List
            </button>
            <button onclick="clearAllRequests()" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 text-sm">
              Clear All Requests
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Job Description Modal -->
  <div id="jd-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 id="jd-title" class="text-xl font-bold"></h3>
        <button onclick="closeJobDescriptionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div id="jd-content" class="prose max-w-none">
        <p class="text-gray-600">Job description content will be displayed here. Upload job description files to populate this section.</p>
      </div>
    </div>
  </div>

  <!-- Organization Units Modal -->
  <div id="org-units-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="org-units-title" class="text-xl font-bold"></h3>
          <nav class="text-sm text-gray-600 mt-1">
            <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
            <span class="mx-2">></span>
            <span id="breadcrumb-category"></span>
            <span class="mx-2">></span>
            <span id="breadcrumb-unit"></span>
          </nav>
        </div>
        <button onclick="closeOrgUnitsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div id="org-units-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Organization units will be populated here -->
      </div>
    </div>
  </div>

  <!-- Sub-Units Modal -->
  <div id="sub-units-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="sub-units-title" class="text-xl font-bold"></h3>
          <nav class="text-sm text-gray-600 mt-1" id="sub-breadcrumb-nav">
            <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
            <span class="mx-2">></span>
            <span id="sub-breadcrumb-category" class="cursor-pointer hover:text-blue-600" onclick="goBackToCategory()"></span>
            <span class="mx-2">></span>
            <span id="sub-breadcrumb-unit" class="cursor-pointer hover:text-blue-600" onclick="goBackToUnits()"></span>
            <span class="mx-2">></span>
            <span id="sub-breadcrumb-orgunit"></span>
          </nav>
        </div>
        <button onclick="closeSubUnitsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div id="sub-units-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Sub-units will be populated here -->
      </div>
    </div>
  </div>

  <!-- Positions Modal -->
  <div id="positions-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="positions-title" class="text-xl font-bold"></h3>
          <nav class="text-sm text-gray-600 mt-1">
            <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
            <span class="mx-2">></span>
            <span id="positions-breadcrumb-category" class="cursor-pointer hover:text-blue-600" onclick="goBackToCategory()"></span>
            <span class="mx-2">></span>
            <span id="positions-breadcrumb-unit" class="cursor-pointer hover:text-blue-600" onclick="goBackToUnits()"></span>
            <span class="mx-2">></span>
            <span id="positions-breadcrumb-org"></span>
          </nav>
        </div>
        <div class="flex items-center space-x-2">

          <button onclick="closePositionsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
      </div>
      <div id="positions-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Positions will be populated here -->
      </div>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div id="category-manager-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-7xl max-h-[90vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-indigo-900">ğŸ—ï¸ Complete Structure Management</h3>
        <button onclick="closeCategoryManager()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- Left Panel: Add New Items -->
        <div class="space-y-6">
          <!-- Add New Category -->
          <div class="bg-green-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-green-900 mb-4">â• Add New Category</h4>
            <form onsubmit="addNewCategory(event)" class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                <input type="text" id="new-category-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., OPERATIONS" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category Color</label>
                <select id="new-category-color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="blue">Blue</option>
                  <option value="green">Green</option>
                  <option value="red">Red</option>
                  <option value="purple">Purple</option>
                  <option value="orange">Orange</option>
                  <option value="teal">Teal</option>
                  <option value="indigo">Indigo</option>
                  <option value="pink">Pink</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                Add Category
              </button>
            </form>
          </div>

          <!-- Add Unit/Sub-Unit -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-blue-900 mb-4">ğŸ¢ Add Unit/Sub-Unit</h4>
            <form onsubmit="addUnitOrSubUnit(event)" class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                <select id="unit-category-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="updateParentOptions()">
                  <!-- Categories will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Unit/Sub-Unit Name</label>
                <input type="text" id="new-unit-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Regional Operations" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Reports To (Parent Unit)</label>
                <select id="parent-unit-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">-- Top Level Unit --</option>
                  <!-- Parent options will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Level</label>
                <select id="unit-level-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="1">Level 1 (Top Level)</option>
                  <option value="2">Level 2</option>
                  <option value="3">Level 3</option>
                  <option value="4">Level 4</option>
                  <option value="5">Level 5</option>
                  <option value="6">Level 6</option>
                  <option value="7">Level 7</option>
                  <option value="8">Level 8</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                Add Unit/Sub-Unit
              </button>
            </form>
          </div>

          <!-- Add Position -->
          <div class="bg-purple-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-purple-900 mb-4">ğŸ‘¤ Add Position</h4>
            <form onsubmit="addPositionToUnit(event)" class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                <select id="position-category-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required onchange="updateUnitOptionsForPosition()">
                  <!-- Categories will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Unit/Sub-Unit</label>
                <select id="position-unit-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                  <option value="">-- Select Unit First --</option>
                  <!-- Unit options will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Position Name</label>
                <input type="text" id="new-position-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., Manager - Regional Operations" required>
              </div>
              <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                Add Position
              </button>
            </form>
          </div>
        </div>

        <!-- Middle Panel: Structure Tree View -->
        <div class="xl:col-span-2">
          <div class="bg-gray-50 p-4 rounded-lg h-full">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-gray-900">ğŸŒ³ Complete Structure Tree</h4>
              <div class="flex space-x-2">
                <button onclick="expandAllStructure()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                  ğŸ“– Expand All
                </button>
                <button onclick="collapseAllStructure()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                  ğŸ“• Collapse All
                </button>
                <button onclick="refreshStructureTree()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                  ğŸ”„ Refresh
                </button>
              </div>
            </div>
            <div id="structure-tree" class="max-h-[60vh] overflow-y-auto bg-white p-4 rounded border">
              <!-- Structure tree will be populated here -->
            </div>
          </div>
        </div>

        <!-- Bottom Panel: Bulk Operations -->
        <div class="bg-orange-50 p-4 rounded-lg xl:col-span-3">
          <h4 class="text-lg font-semibold text-orange-900 mb-4">âš¡ Bulk Operations & Templates</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <input type="file" id="categories-file" accept=".xlsx,.xls" class="hidden" onchange="uploadCategoriesStructure(event)">
            <button onclick="document.getElementById('categories-file').click()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 text-sm">
              ğŸ“ Upload Structure
            </button>
            <button onclick="downloadCompleteTemplate()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 text-sm">
              ğŸ“¥ Complete Template
            </button>
            <button onclick="exportCompleteStructure()" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 text-sm" id="export-categories-btn">
              ğŸ“¤ Export Structure
            </button>
            <button onclick="validateStructureIntegrity()" class="bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 text-sm">
              âœ… Validate Structure
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-app" class="flex h-screen hidden">
    <!-- Sidebar -->
    <div class="w-20 bg-white border-r flex flex-col items-center py-6 space-y-8 shadow-md h-full">
      <button onclick="navigate('home')" id="nav-home" class="p-3 rounded hover:bg-blue-100">
        <img id="home-icon" src="https://img.icons8.com/ios-filled/28/000000/home.png" alt="Home" />
      </button>
      <button onclick="navigate('org')" id="nav-org" class="p-3 rounded hover:bg-blue-100">
        <img id="org-icon" src="https://img.icons8.com/ios-filled/28/000000/organization.png" alt="Org Chart" />
      </button>
      <button onclick="navigate('jd')" id="nav-jd" class="p-3 rounded hover:bg-blue-100">
        <img id="jd-icon" src="https://img.icons8.com/ios-filled/28/000000/resume.png" alt="Job Description" />
      </button>
      <button onclick="navigate('admin')" id="nav-admin" class="p-3 rounded hover:bg-blue-100 hidden">
        <img id="admin-icon" src="https://img.icons8.com/ios-filled/28/000000/admin-settings-male.png" alt="Admin Panel" />
      </button>
      <div class="flex-1"></div>
      <div class="text-center">
        <div class="text-xs text-gray-500 mb-3" id="user-role">Admin</div>
        <button onclick="openUserManagement()" id="nav-user-mgmt" class="p-3 rounded hover:bg-purple-100 mb-2 hidden" title="User Management">
          <img src="https://img.icons8.com/ios-filled/28/000000/user-group-man-man.png" alt="User Management" />
        </button>
        <button onclick="logout()" class="p-3 rounded hover:bg-red-100">
          <img id="logout-icon" src="https://img.icons8.com/ios-filled/28/000000/logout-rounded.png" alt="Logout" />
        </button>
      </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 p-6 overflow-y-auto">
      <!-- Home -->
      <div id="home" class="space-y-8 h-full flex flex-col">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <img id="company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-12 sm:h-16 max-w-full object-contain" alt="Company Logo" />
          <div id="logo-admin-controls" class="hidden space-x-2 flex-wrap">
            <button onclick="openUserManagement()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700">
              ğŸ‘¥ User Management
            </button>
            <div class="flex flex-col space-y-2">
              <div class="flex space-x-1">
                <input type="file" id="logo-file" accept=".png,.jpg,.jpeg,.svg" class="hidden" onchange="uploadLogo(event)">
                <button onclick="document.getElementById('logo-file').click()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                  ğŸ“· Change Logo
                </button>
                <button onclick="removeLogo()" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                  ğŸ—‘ï¸ Remove
                </button>
              </div>
              <div class="flex space-x-1">
                <input type="file" id="home-icon-file" accept=".png,.jpg,.jpeg,.svg" class="hidden" onchange="uploadIcon(event, 'home')">
                <button onclick="document.getElementById('home-icon-file').click()" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                  ğŸ  Home Icon
                </button>
                <button onclick="removeIcon('home')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                  ğŸ—‘ï¸
                </button>
              </div>
              <div class="flex space-x-1">
                <input type="file" id="org-icon-file" accept=".png,.jpg,.jpeg,.svg" class="hidden" onchange="uploadIcon(event, 'org')">
                <button onclick="document.getElementById('org-icon-file').click()" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                  ğŸ¢ Org Icon
                </button>
                <button onclick="removeIcon('org')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                  ğŸ—‘ï¸
                </button>
              </div>
              <div class="flex space-x-1">
                <input type="file" id="jd-icon-file" accept=".png,.jpg,.jpeg,.svg" class="hidden" onchange="uploadIcon(event, 'jd')">
                <button onclick="document.getElementById('jd-icon-file').click()" class="bg-orange-600 text-white px-3 py-1 rounded text-xs hover:bg-orange-700">
                  ğŸ“‹ JD Icon
                </button>
                <button onclick="removeIcon('jd')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                  ğŸ—‘ï¸
                </button>
              </div>
              <div class="flex space-x-1">
                <input type="file" id="logout-icon-file" accept=".png,.jpg,.jpeg,.svg" class="hidden" onchange="uploadIcon(event, 'logout')">
                <button onclick="document.getElementById('logout-icon-file').click()" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                  ğŸšª Logout Icon
                </button>
                <button onclick="removeIcon('logout')" class="bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        </div>
        <h1 class="text-4xl font-bold text-blue-900 text-center mb-6">Organizational Design Portal</h1>
        <div class="flex flex-col space-y-4 max-w-2xl mx-auto w-full">
          <button onclick="navigate('org')" class="block w-full text-left px-6 py-6 rounded-lg bg-gradient-to-r from-red-200 to-orange-200 shadow-md hover:shadow-lg transition-shadow">
            <p class="text-xs uppercase font-medium text-gray-700">Converged View</p>
            <p class="text-xl font-bold text-gray-900 mt-1">Organizational Charts</p>
            <p class="text-gray-600 mt-1 text-sm">View and manage organizational hierarchy with dynamic color mapping</p>
          </button>
          <button onclick="navigate('jd')" class="block w-full text-left px-6 py-6 rounded-lg bg-gradient-to-r from-teal-200 to-green-200 shadow-md hover:shadow-lg transition-shadow">
            <p class="text-xs uppercase font-medium text-gray-700">Database</p>
            <p class="text-xl font-bold text-gray-900 mt-1">Job Description</p>
            <p class="text-gray-600 mt-1 text-sm">Browse positions by category and manage job descriptions</p>
          </button>
        </div>
      </div>

      <!-- Org Chart -->
      <div id="org" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="org-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Organizational Chart</h2>
          </div>
          <div class="flex items-center space-x-2">
            <div id="org-admin-controls" class="space-x-2 hidden">
              <input type="file" id="org-file" accept=".xlsx,.xls,.vsdx,.vsd" class="hidden" onchange="uploadOrgChart(event)">
              <button onclick="document.getElementById('org-file').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                ğŸ“ Upload Org Chart (Excel/Visio)
              </button>
              <button onclick="removeOrgChart()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
                ğŸ—‘ï¸ Remove Org Chart
              </button>
              <button onclick="downloadOrgTemplate()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                ğŸ“¥ Org Template
              </button>
              <button onclick="exportCurrentOrgStructure()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700" id="export-org-btn">
                ğŸ“¤ Export Current Structure
              </button>
              <button onclick="exportStructureWithJDs()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700" id="export-jd-btn">
                ğŸ“‹ Export with JDs
              </button>
              <button onclick="toggleEditMode()" id="edit-mode-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700">
                âœï¸ Edit Mode
              </button>
              <input type="file" id="functions-file" accept=".xlsx,.xls" class="hidden" onchange="uploadFunctions(event)">
              <button onclick="document.getElementById('functions-file').click()" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700">
                ğŸ“‹ Upload Functions/AO
              </button>
              <button onclick="downloadFunctionsTemplate()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">
                ğŸ“¥ Functions Template
              </button>
            </div>
          </div>
        </div>
        
        <div class="w-full">
          <div id="org-chart" class="overflow-x-auto bg-gray-50 p-4 rounded-lg">
            <!-- Dynamic org chart will be generated here -->
          </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div id="admin" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="admin-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Admin Panel</h2>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- User Management Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="text-blue-600 mr-2">ğŸ‘¥</span>
              User Management
            </h3>
            
            <!-- Password Reset Requests -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-800 mb-3 flex items-center justify-between">
                <span>ğŸ”‘ Password Reset Requests</span>
                <span id="reset-count" class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">0</span>
              </h4>
              <div id="admin-reset-requests" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-gray-500 text-sm">No pending reset requests</p>
              </div>
            </div>

            <!-- Access Requests -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-800 mb-3 flex items-center justify-between">
                <span>ğŸ“ New Access Requests</span>
                <span id="access-count" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">0</span>
              </h4>
              <div id="admin-access-requests" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-gray-500 text-sm">No pending access requests</p>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="border-t pt-4">
              <h4 class="font-medium text-gray-800 mb-3">âš¡ Quick Actions</h4>
              <div class="grid grid-cols-2 gap-2">
                <button onclick="refreshUserRequests()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                  ğŸ”„ Refresh
                </button>
                <button onclick="clearAllRequests()" class="bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700">
                  ğŸ—‘ï¸ Clear All
                </button>
                <button onclick="exportUserList()" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
                  ğŸ“¤ Export Users
                </button>
                <button onclick="changeAdminPassword()" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">
                  ğŸ” Change Password
                </button>
              </div>
            </div>
          </div>

          <!-- Approved Users Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
              <span class="flex items-center">
                <span class="text-green-600 mr-2">âœ…</span>
                Approved Users
              </span>
              <span id="approved-count" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            
            <div id="admin-approved-users" class="space-y-2 max-h-80 overflow-y-auto">
              <p class="text-gray-500 text-sm">No approved users</p>
            </div>
          </div>

          <!-- System Statistics -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="text-indigo-600 mr-2">ğŸ“Š</span>
              System Statistics
            </h3>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-blue-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-blue-600" id="total-users">0</div>
                <div class="text-sm text-blue-800">Total Users</div>
              </div>
              <div class="bg-green-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-green-600" id="active-sessions">1</div>
                <div class="text-sm text-green-800">Active Sessions</div>
              </div>
              <div class="bg-purple-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-purple-600" id="total-jds">0</div>
                <div class="text-sm text-purple-800">Job Descriptions</div>
              </div>
              <div class="bg-orange-50 p-4 rounded-lg text-center">
                <div class="text-2xl font-bold text-orange-600" id="org-units">0</div>
                <div class="text-sm text-orange-800">Org Units</div>
              </div>
            </div>
          </div>

          <!-- System Controls -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="text-red-600 mr-2">âš™ï¸</span>
              System Controls
            </h3>
            
            <div class="space-y-3">
              <button onclick="backupSystemData()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm">
                ğŸ’¾ Backup System Data
              </button>
              <button onclick="restoreSystemData()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm">
                ğŸ“¥ Restore System Data
              </button>
              <button onclick="resetSystemToDefaults()" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700 text-sm">
                ğŸ”„ Reset to Defaults
              </button>
              <button onclick="clearAllSystemData()" class="w-full bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 text-sm">
                ğŸ—‘ï¸ Clear All Data
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- JD Database -->
      <div id="jd" class="hidden">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="jd-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Job Descriptions</h2>
          </div>
          <div id="jd-admin-controls" class="space-x-2 hidden">
            <button onclick="openCategoryManager()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">
              ğŸ—ï¸ Manage Categories
            </button>
            <input type="file" id="org-structure-file" accept=".xlsx,.xls" class="hidden" onchange="uploadOrgStructure(event)">
            <button onclick="document.getElementById('org-structure-file').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
              ğŸ“ Upload All Structure
            </button>
            <button onclick="removeAllStructure()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
              ğŸ—‘ï¸ Remove All Structure
            </button>
            <button onclick="downloadStructureTemplate()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
              ğŸ“¥ Full Template
            </button>
            <button onclick="downloadCategoryTemplate('SAMPLE', 'Sample Unit')" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-teal-700">
              ğŸ“‹ Category Template
            </button>
            <input type="file" id="bulk-jd-file" accept=".pdf,.doc,.docx,.txt" multiple class="hidden" onchange="uploadBulkJD(event)">
            <button onclick="document.getElementById('bulk-jd-file').click()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700">
              ğŸ“¦ Upload JD Bulk
            </button>
            <button onclick="removeAllJD()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">
              ğŸ—‘ï¸ Remove All JD
            </button>
          </div>
        </div>
        
        <div id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Categories will be dynamically generated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Job Description Modal -->
  <div id="jd-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 id="jd-title" class="text-xl font-bold"></h3>
        <button onclick="closeJobDescriptionModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div id="jd-content" class="prose max-w-none">
        <p class="text-gray-600">Job description content will be displayed here. Upload job description files to populate this section.</p>
      </div>
    </div>
  </div>

  <!-- Organization Units Modal -->
  <div id="org-units-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="org-units-title" class="text-xl font-bold"></h3>
          <nav class="text-sm text-gray-600 mt-1">
            <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
            <span class="mx-2">></span>
            <span id="breadcrumb-category"></span>
            <span class="mx-2">></span>
            <span id="breadcrumb-unit"></span>
          </nav>
        </div>
        <button onclick="closeOrgUnitsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div id="org-units-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Organization units will be populated here -->
      </div>
    </div>
  </div>

  <!-- Sub-Units Modal -->
  <div id="sub-units-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="sub-units-title" class="text-xl font-bold"></h3>
          <nav class="text-sm text-gray-600 mt-1" id="sub-breadcrumb-nav">
            <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
            <span class="mx-2">></span>
            <span id="sub-breadcrumb-category" class="cursor-pointer hover:text-blue-600" onclick="goBackToCategory()"></span>
            <span class="mx-2">></span>
            <span id="sub-breadcrumb-unit" class="cursor-pointer hover:text-blue-600" onclick="goBackToUnits()"></span>
            <span class="mx-2">></span>
            <span id="sub-breadcrumb-orgunit"></span>
          </nav>
        </div>
        <button onclick="closeSubUnitsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      <div id="sub-units-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Sub-units will be populated here -->
      </div>
    </div>
  </div>

  <!-- Positions Modal -->
  <div id="positions-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-[80vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 id="positions-title" class="text-xl font-bold"></h3>
          <nav class="text-sm text-gray-600 mt-1">
            <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
            <span class="mx-2">></span>
            <span id="positions-breadcrumb-category" class="cursor-pointer hover:text-blue-600" onclick="goBackToCategory()"></span>
            <span class="mx-2">></span>
            <span id="positions-breadcrumb-unit" class="cursor-pointer hover:text-blue-600" onclick="goBackToUnits()"></span>
            <span class="mx-2">></span>
            <span id="positions-breadcrumb-org"></span>
          </nav>
        </div>
        <div class="flex items-center space-x-2">

          <button onclick="closePositionsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
      </div>
      <div id="positions-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Positions will be populated here -->
      </div>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div id="category-manager-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-7xl max-h-[90vh] overflow-y-auto m-4 w-full">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-indigo-900">ğŸ—ï¸ Complete Structure Management</h3>
        <button onclick="closeCategoryManager()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <!-- Left Panel: Add New Items -->
        <div class="space-y-6">
          <!-- Add New Category -->
          <div class="bg-green-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-green-900 mb-4">â• Add New Category</h4>
            <form onsubmit="addNewCategory(event)" class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                <input type="text" id="new-category-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., OPERATIONS" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category Color</label>
                <select id="new-category-color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                  <option value="blue">Blue</option>
                  <option value="green">Green</option>
                  <option value="red">Red</option>
                  <option value="purple">Purple</option>
                  <option value="orange">Orange</option>
                  <option value="teal">Teal</option>
                  <option value="indigo">Indigo</option>
                  <option value="pink">Pink</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                Add Category
              </button>
            </form>
          </div>

          <!-- Add Unit/Sub-Unit -->
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-blue-900 mb-4">ğŸ¢ Add Unit/Sub-Unit</h4>
            <form onsubmit="addUnitOrSubUnit(event)" class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                <select id="unit-category-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="updateParentOptions()">
                  <!-- Categories will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Unit/Sub-Unit Name</label>
                <input type="text" id="new-unit-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Regional Operations" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Reports To (Parent Unit)</label>
                <select id="parent-unit-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">-- Top Level Unit --</option>
                  <!-- Parent options will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Level</label>
                <select id="unit-level-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="1">Level 1 (Top Level)</option>
                  <option value="2">Level 2</option>
                  <option value="3">Level 3</option>
                  <option value="4">Level 4</option>
                  <option value="5">Level 5</option>
                  <option value="6">Level 6</option>
                  <option value="7">Level 7</option>
                  <option value="8">Level 8</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                Add Unit/Sub-Unit
              </button>
            </form>
          </div>

          <!-- Add Position -->
          <div class="bg-purple-50 p-4 rounded-lg">
            <h4 class="text-lg font-semibold text-purple-900 mb-4">ğŸ‘¤ Add Position</h4>
            <form onsubmit="addPositionToUnit(event)" class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                <select id="position-category-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required onchange="updateUnitOptionsForPosition()">
                  <!-- Categories will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Select Unit/Sub-Unit</label>
                <select id="position-unit-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                  <option value="">-- Select Unit First --</option>
                  <!-- Unit options will be populated here -->
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Position Name</label>
                <input type="text" id="new-position-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g., Manager - Regional Operations" required>
              </div>
              <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                Add Position
              </button>
            </form>
          </div>
        </div>

        <!-- Middle Panel: Structure Tree View -->
        <div class="xl:col-span-2">
          <div class="bg-gray-50 p-4 rounded-lg h-full">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-gray-900">ğŸŒ³ Complete Structure Tree</h4>
              <div class="flex space-x-2">
                <button onclick="expandAllStructure()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                  ğŸ“– Expand All
                </button>
                <button onclick="collapseAllStructure()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                  ğŸ“• Collapse All
                </button>
                <button onclick="refreshStructureTree()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                  ğŸ”„ Refresh
                </button>
              </div>
            </div>
            <div id="structure-tree" class="max-h-[60vh] overflow-y-auto bg-white p-4 rounded border">
              <!-- Structure tree will be populated here -->
            </div>
          </div>
        </div>

        <!-- Bottom Panel: Bulk Operations -->
        <div class="bg-orange-50 p-4 rounded-lg xl:col-span-3">
          <h4 class="text-lg font-semibold text-orange-900 mb-4">âš¡ Bulk Operations & Templates</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <input type="file" id="categories-file" accept=".xlsx,.xls" class="hidden" onchange="uploadCategoriesStructure(event)">
            <button onclick="document.getElementById('categories-file').click()" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 text-sm">
              ğŸ“ Upload Structure
            </button>
            <button onclick="downloadCompleteTemplate()" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 text-sm">
              ğŸ“¥ Complete Template
            </button>
            <button onclick="exportCompleteStructure()" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 text-sm" id="export-categories-btn">
              ğŸ“¤ Export Structure
            </button>
            <button onclick="validateStructureIntegrity()" class="bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700 text-sm">
              âœ… Validate Structure
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let userLevel = null;
    let isPreviewMode = false;
    let jobDescriptions = {};
    
    // Standalone Org Chart System with hierarchical structure
    let orgChartData = {
      level0: [
        { Level: 0, Position: 'Board of Directors', Parent: '', Color: 'gray', Id: 'board', ReportsTo: '', FunctionalReportsTo: '' }
      ],
      level0_5: [
        { Level: 0.5, Position: 'Internal Audit', Parent: 'board', Color: 'red', Id: 'internal-audit', ReportsTo: 'board', FunctionalReportsTo: 'ceo' },
        { Level: 0.5, Position: 'Corporate Governance', Parent: 'board', Color: 'red', Id: 'corp-governance', ReportsTo: 'board', FunctionalReportsTo: 'ceo' }
      ],
      level1: [
        { Level: 1, Position: 'President and CEO', Parent: 'board', Color: 'gray', Id: 'ceo', ReportsTo: 'board', FunctionalReportsTo: '' }
      ],
      level2: [],
      subUnits: {}
    };
    
    // Separate org chart management
    let orgChartSubUnits = {};
    let orgStructure = {
      'BUSINESS': {
        'Consumer Business Home': {
          'Regional Operations': ['Manager - Regional Operations', 'Senior Specialist - Customer Relations', 'Analyst - Market Research'],
          'Sales Division': ['Sales Manager', 'Senior Sales Representative', 'Sales Coordinator'],
          'Customer Service': ['Customer Service Manager', 'Senior Customer Service Representative', 'Technical Support Specialist']
        },
        'Consumer Business Wireless': {
          'Mobile Services': ['Manager - Mobile Services', 'Product Manager - Mobile Plans', 'Technical Specialist - Network'],
          'Retail Operations': ['Retail Manager', 'Store Supervisor', 'Sales Associate'],
          'Digital Marketing': ['Digital Marketing Manager', 'Social Media Specialist', 'Content Creator']
        },
        'Home Sales and Development': {
          'Product Development': ['Product Development Manager', 'Senior Product Analyst', 'UX/UI Designer'],
          'Market Research': ['Market Research Manager', 'Research Analyst', 'Data Scientist'],
          'Business Development': ['Business Development Manager', 'Partnership Specialist', 'Strategic Planner']
        },
        'Wireless Sales and Development': {
          'Sales Strategy': ['Sales Strategy Manager', 'Senior Sales Analyst', 'Territory Manager'],
          'Channel Management': ['Channel Manager', 'Partner Relations Specialist', 'Distribution Coordinator'],
          'Revenue Management': ['Revenue Manager', 'Pricing Analyst', 'Financial Analyst']
        },
        'Enterprise Business': {
          'Corporate Solutions': ['Enterprise Sales Manager', 'Solutions Architect', 'Account Manager'],
          'Government Relations': ['Government Relations Manager', 'Policy Analyst', 'Compliance Specialist'],
          'B2B Services': ['B2B Manager', 'Technical Consultant', 'Implementation Specialist']
        }
      },
      'TECHNOLOGY': {
        'Network Group': {
          'Infrastructure': ['Network Infrastructure Manager', 'Senior Network Engineer', 'Systems Administrator'],
          'Operations': ['Network Operations Manager', 'NOC Specialist', 'Field Technician'],
          'Planning': ['Network Planning Manager', 'RF Engineer', 'Capacity Planner']
        },
        'Information Technology': {
          'Software Development': ['IT Manager - Development', 'Senior Software Developer', 'DevOps Engineer'],
          'System Administration': ['Systems Manager', 'Database Administrator', 'Cloud Architect'],
          'IT Support': ['IT Support Manager', 'Help Desk Specialist', 'Technical Support']
        },
        'Cybersecurity': {
          'Security Operations': ['CISO', 'Security Analyst', 'Incident Response Specialist'],
          'Risk Management': ['Risk Manager', 'Compliance Officer', 'Security Auditor'],
          'Security Architecture': ['Security Architect', 'Penetration Tester', 'Security Consultant']
        }
      },
      'SUPPORT': {
        'Finance Group': {
          'Financial Planning': ['Finance Manager', 'Financial Analyst', 'Budget Specialist'],
          'Accounting': ['Accounting Manager', 'Senior Accountant', 'Accounts Payable Specialist'],
          'Treasury': ['Treasury Manager', 'Cash Management Specialist', 'Investment Analyst']
        },
        'People Group': {
          'Human Resources': ['HR Manager', 'HR Business Partner', 'Recruitment Specialist'],
          'Learning & Development': ['L&D Manager', 'Training Specialist', 'Organizational Development'],
          'Compensation & Benefits': ['C&B Manager', 'Compensation Analyst', 'Benefits Administrator']
        },
        'Supply Chain Management and Privacy Office': {
          'Procurement': ['Procurement Manager', 'Senior Buyer', 'Vendor Relations Specialist'],
          'Supply Chain': ['Supply Chain Manager', 'Logistics Coordinator', 'Inventory Analyst'],
          'Privacy Office': ['Privacy Officer', 'Data Protection Specialist', 'Compliance Analyst']
        },
        'Legal and Regulatory': {
          'Legal Affairs': ['Legal Manager', 'Corporate Lawyer', 'Contract Specialist'],
          'Regulatory Compliance': ['Regulatory Manager', 'Compliance Officer', 'Policy Analyst'],
          'Corporate Governance': ['Governance Manager', 'Board Secretary', 'Ethics Officer']
        }
      },
      'GOVERNANCE': {
        'Internal Audit': {
          'Audit Operations': ['Chief Audit Executive', 'Senior Auditor', 'Audit Specialist'],
          'Risk Assessment': ['Risk Assessment Manager', 'Internal Controls Specialist', 'Fraud Investigator'],
          'Compliance Monitoring': ['Compliance Manager', 'Monitoring Specialist', 'Audit Coordinator']
        },
        'Corporate Governance': {
          'Board Relations': ['Corporate Secretary', 'Board Relations Manager', 'Governance Specialist'],
          'Ethics & Compliance': ['Ethics Officer', 'Compliance Manager', 'Policy Developer'],
          'Stakeholder Relations': ['Stakeholder Relations Manager', 'Investor Relations Specialist', 'Communications Manager']
        }
      }
    };
    let currentCategory = '';
    let currentUnit = '';
    let currentOrg = '';
    let pendingUser = null;
    let orgFunctions = {};
    let selectedOrgUnit = null;
    let categoryColors = {
      'BUSINESS': 'blue',
      'TECHNOLOGY': 'blue', 
      'SUPPORT': 'blue',
      'GOVERNANCE': 'blue'
    };

    // User Management System with multi-level admin support
    let userManagement = {
      resetRequests: JSON.parse(localStorage.getItem('resetRequests') || '[]'),
      accessRequests: JSON.parse(localStorage.getItem('accessRequests') || '[]'),
      approvedUsers: JSON.parse(localStorage.getItem('approvedUsers') || '{}'),
      level1Password: localStorage.getItem('level1Password') || 'Hunter542639',
      level2Password: localStorage.getItem('level2Password') || 'PLDT_L2_Admin'
    };

    // Session Management
    function saveSession() {
      if (currentUser) {
        sessionStorage.setItem('currentUser', currentUser);
        sessionStorage.setItem('userLevel', userLevel);
        sessionStorage.setItem('isPreviewMode', isPreviewMode);
      }
    }

    function loadSession() {
      const savedUser = sessionStorage.getItem('currentUser');
      const savedLevel = sessionStorage.getItem('userLevel');
      const savedPreview = sessionStorage.getItem('isPreviewMode');
      
      if (savedUser) {
        currentUser = savedUser;
        userLevel = savedLevel;
        isPreviewMode = savedPreview === 'true';
        
        // Auto-login with saved session
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        setupUserInterface();
        navigate('home');
      }
    }

    function clearSession() {
      sessionStorage.removeItem('currentUser');
      sessionStorage.removeItem('userLevel');
      sessionStorage.removeItem('isPreviewMode');
    }

    // Password visibility toggle
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('password');
      const eyeIcon = document.getElementById('eye-icon');
      const eyeOffIcon = document.getElementById('eye-off-icon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.add('hidden');
        eyeOffIcon.classList.remove('hidden');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('hidden');
        eyeOffIcon.classList.add('hidden');
      }
    }

    // Authentication with multi-level admin support
    function login(event) {
      event.preventDefault();
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value;
      const errorDiv = document.getElementById('login-error');

      let isValid = false;
      let accessLevel = 'viewer';
      let level = null;

      // Check Level 1 Admin (Full Access)
      if (username === 'ntbernal_ADMIN') {
        accessLevel = 'admin';
        level = 'level1';
        isValid = password === 'Hunter542639';
      } 
      // Check Level 2 Admin (Limited Access)
      else if (username === 'ntbernal_LEVEL2') {
        accessLevel = 'admin';
        level = 'level2';
        isValid = password === userManagement.level2Password;
      } 
      // Check your viewer account
      else if (username === 'ntbernal') {
        accessLevel = 'viewer';
        level = 'viewer';
        isValid = password === 'PLDT_HR_OD';
      } 
      // Check approved users
      else if (username && userManagement.approvedUsers[username]) {
        accessLevel = 'viewer';
        level = 'viewer';
        isValid = password === userManagement.approvedUsers[username].password;
      }

      if (isValid) {
        currentUser = accessLevel;
        userLevel = level;
        isPreviewMode = false;
        
        // Save session
        saveSession();
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        setupUserInterface();
        navigate('home');
        errorDiv.classList.add('hidden');
      } else {
        errorDiv.classList.remove('hidden');
        document.getElementById('password').value = '';
      }
    }

    // Setup user interface based on access level
    function setupUserInterface() {
      const roleText = isPreviewMode ? 'Preview Mode' : 
                      (userLevel === 'level1' ? 'Level 1 Admin' : 
                       userLevel === 'level2' ? 'Level 2 Admin' : 'Viewer');
      
      document.getElementById('user-role').textContent = roleText;
      
      // Add preview mode banner if active
      updatePreviewBanner();
      
      // Show/hide controls based on user level and preview mode
      const isLevel1 = userLevel === 'level1' && !isPreviewMode;
      const isLevel2 = (userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode;
      const isAdmin = (userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode;
      
      // Level 1 only controls
      document.getElementById('org-admin-controls').classList.toggle('hidden', !isLevel1);
      document.getElementById('logo-admin-controls').classList.toggle('hidden', !isLevel1);
      document.getElementById('nav-admin').classList.toggle('hidden', !isLevel1);
      document.getElementById('nav-user-mgmt').classList.toggle('hidden', !isLevel1);
      
      // Level 2 and above controls
      const jdControls = document.getElementById('jd-admin-controls');
      if (jdControls) {
        jdControls.classList.toggle('hidden', !isLevel2);
      }
      
      // Show/hide export buttons
      if (isLevel1) {
        showExportButtons();
      } else {
        hideExportButtons();
      }
      
      // Add preview toggle for admins
      if ((userLevel === 'level1' || userLevel === 'level2') && !document.getElementById('preview-toggle')) {
        addPreviewToggle();
      }
    }

    // Add preview mode toggle
    function addPreviewToggle() {
      const sidebar = document.querySelector('.w-20.bg-white.border-r');
      const userSection = sidebar.querySelector('.flex-1').nextElementSibling;
      
      if (!document.getElementById('preview-toggle')) {
        const previewButton = document.createElement('button');
        previewButton.id = 'preview-toggle';
        previewButton.onclick = togglePreviewMode;
        previewButton.className = 'p-3 rounded hover:bg-blue-100 mb-2';
        previewButton.title = isPreviewMode ? 'Exit Preview Mode' : 'Preview as Viewer';
        previewButton.innerHTML = `<img src="https://img.icons8.com/ios-filled/28/000000/${isPreviewMode ? 'admin-settings-male' : 'visible'}.png" alt="Preview Toggle" />`;
        
        userSection.insertBefore(previewButton, userSection.firstChild);
      }
    }

    // Toggle preview mode
    function togglePreviewMode() {
      isPreviewMode = !isPreviewMode;
      saveSession();
      setupUserInterface();
      
      // Update preview button
      const previewButton = document.getElementById('preview-toggle');
      if (previewButton) {
        previewButton.title = isPreviewMode ? 'Exit Preview Mode' : 'Preview as Viewer';
        previewButton.innerHTML = `<img src="https://img.icons8.com/ios-filled/28/000000/${isPreviewMode ? 'admin-settings-male' : 'visible'}.png" alt="Preview Toggle" />`;
      }
    }

    // Update preview mode banner
    function updatePreviewBanner() {
      let banner = document.getElementById('preview-banner');
      
      if (isPreviewMode) {
        if (!banner) {
          banner = document.createElement('div');
          banner.id = 'preview-banner';
          banner.className = 'bg-orange-500 text-white text-center py-2 px-4 font-semibold';
          banner.innerHTML = 'ğŸ‘ï¸ PREVIEW MODE - Viewing as regular user | <button onclick="togglePreviewMode()" class="underline hover:text-orange-200">Exit Preview</button>';
          document.getElementById('main-app').insertBefore(banner, document.getElementById('main-app').firstChild);
        }
      } else {
        if (banner) {
          banner.remove();
        }
      }
    }

    // Real-time access level detection based on username
    document.getElementById('username').addEventListener('input', function() {
      const username = this.value;
      const accessIndicator = document.getElementById('access-indicator');
      const adminIndicator = document.getElementById('admin-indicator');
      const viewerIndicator = document.getElementById('viewer-indicator');
      
      if (username === 'ntbernal_ADMIN') {
        accessIndicator.classList.remove('hidden');
        adminIndicator.classList.remove('hidden');
        adminIndicator.textContent = 'ğŸ”‘ Level 1 Administrator Access Detected';
        viewerIndicator.classList.add('hidden');
      } else if (username === 'ntbernal_LEVEL2') {
        accessIndicator.classList.remove('hidden');
        adminIndicator.classList.remove('hidden');
        adminIndicator.textContent = 'ğŸ”‘ Level 2 Administrator Access Detected';
        viewerIndicator.classList.add('hidden');
      } else if (username.length > 0) {
        accessIndicator.classList.remove('hidden');
        adminIndicator.classList.add('hidden');
        viewerIndicator.classList.remove('hidden');
      } else {
        accessIndicator.classList.add('hidden');
        adminIndicator.classList.add('hidden');
        viewerIndicator.classList.add('hidden');
      }
    });

    // Password Reset Functions
    function showPasswordReset() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('reset-form').classList.remove('hidden');
    }

    function toggleRequestFields() {
      const requestType = document.getElementById('request-type').value;
      const resetFields = document.getElementById('reset-fields');
      const accessFields = document.getElementById('access-fields');
      
      if (requestType === 'access') {
        resetFields.classList.add('hidden');
        accessFields.classList.remove('hidden');
        // Make access fields required
        document.getElementById('company-email').required = true;
        document.getElementById('access-id-number').required = true;
        document.getElementById('preferred-password').required = true;
        document.getElementById('confirm-preferred-password').required = true;
        // Make reset field not required
        document.getElementById('reset-username').required = false;
      } else {
        resetFields.classList.remove('hidden');
        accessFields.classList.add('hidden');
        // Make reset field required
        document.getElementById('reset-username').required = true;
        // Make access fields not required
        document.getElementById('company-email').required = false;
        document.getElementById('access-id-number').required = false;
        document.getElementById('preferred-password').required = false;
        document.getElementById('confirm-preferred-password').required = false;
      }
    }

    function showLoginForm() {
      document.getElementById('reset-form').classList.add('hidden');
      document.getElementById('new-password-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('login-success').classList.add('hidden');
    }

    function requestPasswordReset(event) {
      event.preventDefault();
      const requestType = document.getElementById('request-type').value;

      if (requestType === 'reset') {
        const username = document.getElementById('reset-username').value;
        const request = {
          username: username,
          type: requestType,
          timestamp: new Date().toISOString(),
          id: Date.now()
        };

        userManagement.resetRequests.push(request);
        localStorage.setItem('resetRequests', JSON.stringify(userManagement.resetRequests));
        
        document.getElementById('reset-username').value = '';
      } else {
        // New access request with detailed information
        const email = document.getElementById('company-email').value;
        const idNumber = document.getElementById('access-id-number').value;
        const preferredPassword = document.getElementById('preferred-password').value;
        const confirmPassword = document.getElementById('confirm-preferred-password').value;

        // Validate passwords match
        if (preferredPassword !== confirmPassword) {
          alert('Passwords do not match! Please try again.');
          return;
        }

        // Validate email domain
        if (!email.endsWith('@pldt.com.ph') && !email.endsWith('@smart.com.ph')) {
          alert('Please use your company email address (@pldt.com.ph or @smart.com.ph)');
          return;
        }

        // Check if ID number already exists
        if (userManagement.approvedUsers[idNumber]) {
          alert('This ID number already has an account. Please use the "Reset Password" option instead.');
          return;
        }

        const request = {
          username: idNumber,
          email: email,
          idNumber: idNumber,
          preferredPassword: preferredPassword,
          type: requestType,
          timestamp: new Date().toISOString(),
          id: Date.now()
        };

        userManagement.accessRequests.push(request);
        localStorage.setItem('accessRequests', JSON.stringify(userManagement.accessRequests));
        
        // Clear form
        document.getElementById('company-email').value = '';
        document.getElementById('access-id-number').value = '';
        document.getElementById('preferred-password').value = '';
        document.getElementById('confirm-preferred-password').value = '';
      }

      document.getElementById('login-success').classList.remove('hidden');
      
      setTimeout(() => {
        showLoginForm();
      }, 2000);
    }

    function setNewPassword(event) {
      event.preventDefault();
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        alert('Passwords do not match!');
        return;
      }

      if (pendingUser) {
        userManagement.approvedUsers[pendingUser.username] = {
          password: newPassword,
          approvedDate: new Date().toISOString(),
          type: 'viewer'
        };
        localStorage.setItem('approvedUsers', JSON.stringify(userManagement.approvedUsers));
        
        alert('Password set successfully! You can now log in.');
        pendingUser = null;
        showLoginForm();
      }
    }

    // User Management Modal Functions
    function openUserManagement() {
      document.getElementById('user-management-modal').classList.remove('hidden');
      loadUserManagementData();
    }

    function closeUserManagement() {
      document.getElementById('user-management-modal').classList.add('hidden');
    }

    function loadUserManagementData() {
      // Load reset requests
      const resetContainer = document.getElementById('reset-requests');
      resetContainer.innerHTML = '';
      
      if (userManagement.resetRequests.length === 0) {
        resetContainer.innerHTML = '<p class="text-gray-500 text-sm">No pending reset requests</p>';
      } else {
        userManagement.resetRequests.forEach(request => {
          const div = document.createElement('div');
          div.className = 'bg-white p-3 rounded border';
          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold">${request.username}</p>
                <p class="text-xs text-gray-500">${new Date(request.timestamp).toLocaleString()}</p>
              </div>
              <div class="space-x-2">
                <button onclick="approveReset('${request.username}', ${request.id})" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Approve</button>
                <button onclick="denyRequest('reset', ${request.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Deny</button>
              </div>
            </div>
          `;
          resetContainer.appendChild(div);
        });
      }

      // Load access requests
      const accessContainer = document.getElementById('access-requests');
      accessContainer.innerHTML = '';
      
      if (userManagement.accessRequests.length === 0) {
        accessContainer.innerHTML = '<p class="text-gray-500 text-sm">No pending access requests</p>';
      } else {
        userManagement.accessRequests.forEach(request => {
          const div = document.createElement('div');
          div.className = 'bg-white p-3 rounded border';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold text-sm">ID: ${request.username}</p>
                <p class="text-xs text-blue-600">${request.email}</p>
                <p class="text-xs text-gray-500">${new Date(request.timestamp).toLocaleString()}</p>
              </div>
              <div class="space-x-2 flex-shrink-0">
                <button onclick="approveAccess('${request.username}', ${request.id})" class="bg-green-500 text-white px-2 py-1 rounded text-xs">Approve</button>
                <button onclick="denyRequest('access', ${request.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Deny</button>
              </div>
            </div>
          `;
          accessContainer.appendChild(div);
        });
      }

      // Load approved users
      const approvedContainer = document.getElementById('approved-users');
      approvedContainer.innerHTML = '';
      
      const approvedUsersList = Object.keys(userManagement.approvedUsers);
      if (approvedUsersList.length === 0) {
        approvedContainer.innerHTML = '<p class="text-gray-500 text-sm">No approved users</p>';
      } else {
        approvedUsersList.forEach(username => {
          const user = userManagement.approvedUsers[username];
          const div = document.createElement('div');
          div.className = 'bg-white p-3 rounded border';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-semibold text-sm">ID: ${username}</p>
                ${user.email ? `<p class="text-xs text-blue-600">${user.email}</p>` : ''}
                <p class="text-xs text-gray-500">Approved: ${new Date(user.approvedDate).toLocaleDateString()}</p>
              </div>
              <div class="space-x-2 flex-shrink-0">
                <button onclick="resetUserPassword('${username}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Reset</button>
                <button onclick="removeUser('${username}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Remove</button>
              </div>
            </div>
          `;
          approvedContainer.appendChild(div);
        });
      }
    }

    function approveReset(username, requestId) {
      // Generate temporary access link
      const tempCode = Math.random().toString(36).substring(2, 15);
      alert(`Password reset approved for ${username}. Temporary access code: ${tempCode}\n\nShare this code with the user to set their new password.`);
      
      // Remove from requests
      userManagement.resetRequests = userManagement.resetRequests.filter(r => r.id !== requestId);
      localStorage.setItem('resetRequests', JSON.stringify(userManagement.resetRequests));
      
      // Refresh both modal and admin panel if open
      if (document.getElementById('user-management-modal').classList.contains('hidden') === false) {
        loadUserManagementData();
      }
      if (document.getElementById('admin').classList.contains('hidden') === false) {
        loadAdminData();
      }
    }

    function approveAccess(username, requestId) {
      // Find the request to get the preferred password
      const request = userManagement.accessRequests.find(r => r.id === requestId);
      if (!request) {
        alert('Request not found!');
        return;
      }
      
      // Add to approved users with their preferred password
      userManagement.approvedUsers[username] = {
        password: request.preferredPassword,
        email: request.email,
        idNumber: request.idNumber,
        approvedDate: new Date().toISOString(),
        type: 'viewer'
      };
      localStorage.setItem('approvedUsers', JSON.stringify(userManagement.approvedUsers));
      
      // Remove from requests
      userManagement.accessRequests = userManagement.accessRequests.filter(r => r.id !== requestId);
      localStorage.setItem('accessRequests', JSON.stringify(userManagement.accessRequests));
      
      alert(`Access approved for ID: ${username}\nEmail: ${request.email}\n\nUser can now log in with their ID number and chosen password.`);
      
      // Refresh both modal and admin panel if open
      if (document.getElementById('user-management-modal').classList.contains('hidden') === false) {
        loadUserManagementData();
      }
      if (document.getElementById('admin').classList.contains('hidden') === false) {
        loadAdminData();
      }
    }

    function denyRequest(type, requestId) {
      if (type === 'reset') {
        userManagement.resetRequests = userManagement.resetRequests.filter(r => r.id !== requestId);
        localStorage.setItem('resetRequests', JSON.stringify(userManagement.resetRequests));
      } else {
        userManagement.accessRequests = userManagement.accessRequests.filter(r => r.id !== requestId);
        localStorage.setItem('accessRequests', JSON.stringify(userManagement.accessRequests));
      }
      
      // Refresh both modal and admin panel if open
      if (document.getElementById('user-management-modal').classList.contains('hidden') === false) {
        loadUserManagementData();
      }
      if (document.getElementById('admin').classList.contains('hidden') === false) {
        loadAdminData();
      }
    }

    function resetUserPassword(username) {
      const tempCode = Math.random().toString(36).substring(2, 15);
      alert(`Password reset initiated for ${username}. Temporary code: ${tempCode}\n\nShare this code with the user to set their new password.`);
    }

    function removeUser(username) {
      if (confirm(`Are you sure you want to remove user "${username}"?`)) {
        delete userManagement.approvedUsers[username];
        localStorage.setItem('approvedUsers', JSON.stringify(userManagement.approvedUsers));
        loadUserManagementData();
      }
    }

    function changeAdminPassword() {
      if (userLevel !== 'level1' || isPreviewMode) {
        alert('Password management is only available for Level 1 administrators.');
        return;
      }
      
      const passwordType = prompt('Which password to change?\n1. Level 1 Admin Password\n2. Level 2 Admin Password\n\nEnter 1 or 2:');
      
      if (passwordType === '1') {
        const currentPassword = prompt('Enter current Level 1 admin password:');
        if (currentPassword !== userManagement.level1Password) {
          alert('Incorrect current password!');
          return;
        }
        
        const newPassword = prompt('Enter new Level 1 admin password (minimum 8 characters):');
        if (!newPassword || newPassword.length < 8) {
          alert('Password must be at least 8 characters long!');
          return;
        }
        
        const confirmPassword = prompt('Confirm new Level 1 admin password:');
        if (newPassword !== confirmPassword) {
          alert('Passwords do not match!');
          return;
        }
        
        userManagement.level1Password = newPassword;
        localStorage.setItem('level1Password', newPassword);
        alert('Level 1 admin password changed successfully!');
        
      } else if (passwordType === '2') {
        const currentPassword = prompt('Enter current Level 1 admin password for verification:');
        if (currentPassword !== userManagement.level1Password) {
          alert('Incorrect Level 1 admin password!');
          return;
        }
        
        const newPassword = prompt('Enter new Level 2 admin password (minimum 8 characters):');
        if (!newPassword || newPassword.length < 8) {
          alert('Password must be at least 8 characters long!');
          return;
        }
        
        const confirmPassword = prompt('Confirm new Level 2 admin password:');
        if (newPassword !== confirmPassword) {
          alert('Passwords do not match!');
          return;
        }
        
        userManagement.level2Password = newPassword;
        localStorage.setItem('level2Password', newPassword);
        alert('Level 2 admin password changed successfully!');
      } else {
        alert('Invalid selection. Please enter 1 or 2.');
      }
    }

    function exportUserList() {
      if (currentUser !== 'admin') {
        alert('Export functionality is only available for administrators.');
        return;
      }
      
      const userData = {
        approvedUsers: userManagement.approvedUsers,
        resetRequests: userManagement.resetRequests,
        accessRequests: userManagement.accessRequests,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(userData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'user_management_export.json';
      link.click();
    }

    function clearAllRequests() {
      if (confirm('Are you sure you want to clear all pending requests? This cannot be undone.')) {
        userManagement.resetRequests = [];
        userManagement.accessRequests = [];
        localStorage.setItem('resetRequests', JSON.stringify([]));
        localStorage.setItem('accessRequests', JSON.stringify([]));
        loadUserManagementData();
        alert('All requests cleared successfully!');
      }
    }

    function logout() {
      currentUser = null;
      userLevel = null;
      isPreviewMode = false;
      
      // Clear session
      clearSession();
      
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('password').value = '';
      document.getElementById('username').value = '';
      document.getElementById('login-error').classList.add('hidden');
      
      // Hide all admin controls
      document.getElementById('org-admin-controls').classList.add('hidden');
      document.getElementById('jd-admin-controls').classList.add('hidden');
      document.getElementById('logo-admin-controls').classList.add('hidden');
      document.getElementById('nav-admin').classList.add('hidden');
      document.getElementById('nav-user-mgmt').classList.add('hidden');
      
      // Remove preview elements
      const previewBanner = document.getElementById('preview-banner');
      if (previewBanner) previewBanner.remove();
      
      const previewToggle = document.getElementById('preview-toggle');
      if (previewToggle) previewToggle.remove();
      
      hideExportButtons();
    }

    // Navigation
    function navigate(section) {
      const sections = ['home', 'org', 'jd', 'admin'];
      const navButtons = ['nav-home', 'nav-org', 'nav-jd', 'nav-admin'];

      sections.forEach(s => {
        document.getElementById(s).classList.add('hidden');
      });

      navButtons.forEach(btn => {
        document.getElementById(btn).classList.remove('active');
      });

      document.getElementById(section).classList.remove('hidden');
      document.getElementById('nav-' + section).classList.add('active');
      
      // Render org chart when navigating to org section
      if (section === 'org') {
        renderOrgChart();
      }
      
      // Render categories when navigating to JD section
      if (section === 'jd') {
        renderCategories();
      }
      
      // Load admin data when navigating to admin section
      if (section === 'admin') {
        loadAdminData();
      }
    }

    // New Org Chart Rendering System
    function renderOrgChart() {
      const chartContainer = document.getElementById('org-chart');
      chartContainer.innerHTML = '';
      
      // Create main container
      const mainContainer = document.createElement('div');
      mainContainer.className = 'relative bg-gray-50 p-6 rounded-lg';
      mainContainer.style.minHeight = '600px';
      
      // Create hierarchical levels
      const levelsContainer = document.createElement('div');
      levelsContainer.className = 'space-y-8';
      
      // Level 0 - Board of Directors
      if (orgChartData.level0.length > 0) {
        const level0Container = createLevelContainer('Level 0 - Board of Directors', orgChartData.level0, 'gray');
        levelsContainer.appendChild(level0Container);
      }
      
      // Level 0.5 - Governance Units
      if (orgChartData.level0_5.length > 0) {
        const level05Container = createLevelContainer('Level 0.5 - Governance Units', orgChartData.level0_5, 'red');
        levelsContainer.appendChild(level05Container);
      }
      
      // Level 1 - President and CEO
      if (orgChartData.level1.length > 0) {
        const level1Container = createLevelContainer('Level 1 - President and CEO', orgChartData.level1, 'blue');
        levelsContainer.appendChild(level1Container);
      }
      
      // Level 2 - Direct Reports
      if (orgChartData.level2.length > 0) {
        const level2Container = createLevelContainer('Level 2 - Direct Reports', orgChartData.level2, 'green');
        levelsContainer.appendChild(level2Container);
      }
      
      // Sub-units
      if (Object.keys(orgChartData.subUnits).length > 0) {
        const subUnitsContainer = createSubUnitsContainer();
        levelsContainer.appendChild(subUnitsContainer);
      }
      
      mainContainer.appendChild(levelsContainer);
      
      // Add admin controls if Level 1 admin
      if (userLevel === 'level1' && !isPreviewMode) {
        addOrgChartAdminControls(mainContainer);
      }
      
      chartContainer.appendChild(mainContainer);
    }

    function createLevelContainer(title, nodes, colorScheme) {
      const container = document.createElement('div');
      container.className = 'mb-6';
      
      const header = document.createElement('div');
      header.className = `bg-${colorScheme}-100 p-3 rounded-t-lg border-l-4 border-${colorScheme}-500`;
      header.innerHTML = `
        <h3 class="font-bold text-${colorScheme}-900">${title}</h3>
        <p class="text-sm text-${colorScheme}-700">${nodes.length} position(s)</p>
      `;
      
      const nodesContainer = document.createElement('div');
      nodesContainer.className = 'bg-white p-4 rounded-b-lg border border-t-0 border-gray-200';
      
      const nodesGrid = document.createElement('div');
      nodesGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
      
      nodes.forEach(node => {
        const nodeElement = createOrgChartNode(node);
        nodesGrid.appendChild(nodeElement);
      });
      
      nodesContainer.appendChild(nodesGrid);
      container.appendChild(header);
      container.appendChild(nodesContainer);
      
      return container;
    }

    function createOrgChartNode(node) {
      const nodeDiv = document.createElement('div');
      nodeDiv.className = `bg-gradient-to-r from-${node.Color}-500 to-${node.Color}-600 text-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer relative`;
      nodeDiv.id = `org-node-${node.Id}`;
      
      nodeDiv.innerHTML = `
        <h4 class="font-semibold text-sm mb-2">${node.Position}</h4>
        <div class="text-xs opacity-80">Level ${node.Level}</div>
        ${userLevel === 'level1' && !isPreviewMode ? `
          <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="editOrgNode('${node.Id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-2 py-1 rounded text-xs">
              âœï¸
            </button>
          </div>
        ` : ''}
      `;
      
      // Add click handler for sub-unit management (Level 2 nodes only)
      if (node.Level === 2 && userLevel === 'level1' && !isPreviewMode) {
        nodeDiv.onclick = () => manageSubUnits(node.Id, node.Position);
      }
      
      return nodeDiv;
    }

    function createSubUnitsContainer() {
      const container = document.createElement('div');
      container.className = 'mb-6';
      
      const header = document.createElement('div');
      header.className = 'bg-purple-100 p-3 rounded-t-lg border-l-4 border-purple-500';
      header.innerHTML = `
        <h3 class="font-bold text-purple-900">Sub-Units</h3>
        <p class="text-sm text-purple-700">${Object.keys(orgChartData.subUnits).length} sub-unit group(s)</p>
      `;
      
      const subUnitsContainer = document.createElement('div');
      subUnitsContainer.className = 'bg-white p-4 rounded-b-lg border border-t-0 border-gray-200';
      
      Object.keys(orgChartData.subUnits).forEach(parentId => {
        const parentNode = findNodeById(parentId);
        const subUnits = orgChartData.subUnits[parentId];
        
        if (parentNode && subUnits.length > 0) {
          const subUnitGroup = document.createElement('div');
          subUnitGroup.className = 'mb-4 p-3 bg-gray-50 rounded-lg';
          
          subUnitGroup.innerHTML = `
            <h4 class="font-semibold text-gray-900 mb-2">${parentNode.Position} - Sub-Units</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
              ${subUnits.map(subUnit => `
                <div class="bg-white p-2 rounded border text-sm">
                  <div class="font-medium">${subUnit.Position}</div>
                  <div class="text-xs text-gray-500">Level ${subUnit.Level}</div>
                </div>
              `).join('')}
            </div>
          `;
          
          subUnitsContainer.appendChild(subUnitGroup);
        }
      });
      
      container.appendChild(header);
      container.appendChild(subUnitsContainer);
      
      return container;
    }

    function addOrgChartAdminControls(container) {
      const controlsDiv = document.createElement('div');
      controlsDiv.className = 'mt-6 p-4 bg-blue-50 rounded-lg border-2 border-dashed border-blue-300';
      
      controlsDiv.innerHTML = `
        <h4 class="font-semibold text-blue-900 mb-3">ğŸ“Š Org Chart Management</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <input type="file" id="level2-upload" accept=".xlsx,.xls" class="hidden" onchange="uploadLevel2OrgChart(event)">
          <button onclick="document.getElementById('level2-upload').click()" class="bg-green-600 text-white py-2 px-3 rounded text-sm hover:bg-green-700">
            ğŸ“ Upload Level 2
          </button>
          <button onclick="addLevel2Position()" class="bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700">
            â• Add Level 2
          </button>
          <button onclick="downloadOrgChartTemplate()" class="bg-purple-600 text-white py-2 px-3 rounded text-sm hover:bg-purple-700">
            ğŸ“¥ Template
          </button>
          <button onclick="exportOrgChartData()" class="bg-teal-600 text-white py-2 px-3 rounded text-sm hover:bg-teal-700">
            ğŸ“¤ Export JSON
          </button>
        </div>
      `;
      
      container.appendChild(controlsDiv);
    }

    function findNodeById(id) {
      const allNodes = [
        ...orgChartData.level0,
        ...orgChartData.level0_5,
        ...orgChartData.level1,
        ...orgChartData.level2
      ];
      
      // Also check sub-units
      Object.values(orgChartData.subUnits).forEach(subUnitArray => {
        allNodes.push(...subUnitArray);
      });
      
      return allNodes.find(node => node.Id === id);
    }

    // Org Chart Management Functions
    function uploadLevel2OrgChart(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // Process Level 2 data
          jsonData.forEach(row => {
            const position = row.Position || row['Position Title'];
            const id = row.Id || row.ID || generateId(position);
            const color = row.Color || 'green';
            
            if (position) {
              const newNode = {
                Level: 2,
                Position: position,
                Parent: 'ceo',
                Color: color,
                Id: id,
                ReportsTo: 'ceo',
                FunctionalReportsTo: ''
              };
              
              // Check if already exists
              const exists = orgChartData.level2.find(node => node.Id === id);
              if (!exists) {
                orgChartData.level2.push(newNode);
              }
            }
          });
          
          // Save to localStorage
          localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
          
          renderOrgChart();
          alert(`Level 2 org chart updated! Added ${jsonData.length} positions.`);
        } catch (error) {
          alert('Error reading Excel file. Please check the format.');
        }
      };
      reader.readAsArrayBuffer(file);
      
      // Reset file input
      event.target.value = '';
    }

    function addLevel2Position() {
      const position = prompt('Enter Level 2 position title:');
      if (position && position.trim()) {
        const id = generateId(position);
        const color = prompt('Enter color (blue, green, red, purple, orange, teal, indigo, pink):', 'green') || 'green';
        
        const newNode = {
          Level: 2,
          Position: position.trim(),
          Parent: 'ceo',
          Color: color,
          Id: id,
          ReportsTo: 'ceo',
          FunctionalReportsTo: ''
        };
        
        orgChartData.level2.push(newNode);
        localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
        
        renderOrgChart();
        alert(`Level 2 position "${position}" added successfully!`);
      }
    }

    function manageSubUnits(parentId, parentPosition) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto m-4 w-full">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Manage Sub-Units for ${parentPosition}</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Add Sub-Unit -->
            <div class="bg-green-50 p-4 rounded-lg">
              <h4 class="font-semibold text-green-900 mb-3">â• Add Sub-Unit</h4>
              <form onsubmit="addSubUnit(event, '${parentId}')">
                <div class="mb-3">
                  <label class="block text-sm font-medium mb-1">Position Title</label>
                  <input type="text" id="subunit-position" class="w-full px-3 py-2 border rounded-md" required>
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-medium mb-1">Level</label>
                  <input type="number" id="subunit-level" class="w-full px-3 py-2 border rounded-md" min="3" value="3" required>
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-medium mb-1">Color</label>
                  <select id="subunit-color" class="w-full px-3 py-2 border rounded-md">
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="red">Red</option>
                    <option value="purple">Purple</option>
                    <option value="orange">Orange</option>
                    <option value="teal">Teal</option>
                    <option value="indigo">Indigo</option>
                    <option value="pink">Pink</option>
                  </select>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                  Add Sub-Unit
                </button>
              </form>
            </div>
            
            <!-- Upload Sub-Units -->
            <div class="bg-blue-50 p-4 rounded-lg">
              <h4 class="font-semibold text-blue-900 mb-3">ğŸ“ Upload Sub-Units</h4>
              <input type="file" id="subunit-upload-${parentId}" accept=".xlsx,.xls" class="hidden" onchange="uploadSubUnits(event, '${parentId}')">
              <button onclick="document.getElementById('subunit-upload-${parentId}').click()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 mb-3">
                Upload Excel File
              </button>
              <button onclick="downloadSubUnitTemplate('${parentId}')" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">
                Download Template
              </button>
            </div>
          </div>
          
          <!-- Current Sub-Units -->
          <div class="mt-6">
            <h4 class="font-semibold text-gray-900 mb-3">Current Sub-Units</h4>
            <div id="current-subunits-${parentId}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              ${renderCurrentSubUnits(parentId)}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on background click
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      };
    }

    function renderCurrentSubUnits(parentId) {
      const subUnits = orgChartData.subUnits[parentId] || [];
      
      if (subUnits.length === 0) {
        return '<p class="text-gray-500 col-span-full text-center py-4">No sub-units added yet</p>';
      }
      
      return subUnits.map(subUnit => `
        <div class="bg-white p-3 rounded border">
          <div class="font-medium text-sm">${subUnit.Position}</div>
          <div class="text-xs text-gray-500">Level ${subUnit.Level}</div>
          <div class="mt-2 flex space-x-1">
            <button onclick="editSubUnit('${parentId}', '${subUnit.Id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
              âœï¸
            </button>
            <button onclick="removeSubUnit('${parentId}', '${subUnit.Id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      `).join('');
    }

    function addSubUnit(event, parentId) {
      event.preventDefault();
      
      const position = document.getElementById('subunit-position').value;
      const level = parseInt(document.getElementById('subunit-level').value);
      const color = document.getElementById('subunit-color').value;
      
      const newSubUnit = {
        Level: level,
        Position: position,
        Parent: parentId,
        Color: color,
        Id: generateId(position),
        ReportsTo: parentId,
        FunctionalReportsTo: ''
      };
      
      if (!orgChartData.subUnits[parentId]) {
        orgChartData.subUnits[parentId] = [];
      }
      
      orgChartData.subUnits[parentId].push(newSubUnit);
      localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
      
      // Refresh the sub-units display
      document.getElementById(`current-subunits-${parentId}`).innerHTML = renderCurrentSubUnits(parentId);
      
      // Clear form
      document.getElementById('subunit-position').value = '';
      document.getElementById('subunit-level').value = '3';
      document.getElementById('subunit-color').value = 'blue';
      
      // Refresh main org chart
      renderOrgChart();
      
      alert(`Sub-unit "${position}" added successfully!`);
    }

    function uploadSubUnits(event, parentId) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          if (!orgChartData.subUnits[parentId]) {
            orgChartData.subUnits[parentId] = [];
          }
          
          let addedCount = 0;
          jsonData.forEach(row => {
            const position = row.Position || row['Position Title'];
            const level = row.Level || 3;
            const color = row.Color || 'blue';
            
            if (position) {
              const newSubUnit = {
                Level: level,
                Position: position,
                Parent: parentId,
                Color: color,
                Id: generateId(position),
                ReportsTo: parentId,
                FunctionalReportsTo: ''
              };
              
              orgChartData.subUnits[parentId].push(newSubUnit);
              addedCount++;
            }
          });
          
          localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
          
          // Refresh displays
          document.getElementById(`current-subunits-${parentId}`).innerHTML = renderCurrentSubUnits(parentId);
          renderOrgChart();
          
          alert(`${addedCount} sub-units uploaded successfully!`);
        } catch (error) {
          alert('Error reading Excel file. Please check the format.');
        }
      };
      reader.readAsArrayBuffer(file);
      
      // Reset file input
      event.target.value = '';
    }

    function downloadSubUnitTemplate(parentId) {
      const parentNode = findNodeById(parentId);
      const templateData = [
        { Position: 'Sample Sub-Unit 1', Level: 3, Color: 'blue' },
        { Position: 'Sample Sub-Unit 2', Level: 3, Color: 'green' },
        { Position: 'Sample Sub-Unit 3', Level: 4, Color: 'purple' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sub-Units Template');
      XLSX.writeFile(wb, `${parentNode ? parentNode.Position.replace(/\s+/g, '_') : 'SubUnits'}_Template.xlsx`);
    }

    function editOrgNode(nodeId) {
      const node = findNodeById(nodeId);
      if (!node) return;
      
      const newPosition = prompt('Edit position title:', node.Position);
      if (newPosition && newPosition.trim() && newPosition !== node.Position) {
        node.Position = newPosition.trim();
        localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
        renderOrgChart();
        alert('Position updated successfully!');
      }
    }

    function editSubUnit(parentId, subUnitId) {
      const subUnits = orgChartData.subUnits[parentId] || [];
      const subUnit = subUnits.find(su => su.Id === subUnitId);
      
      if (subUnit) {
        const newPosition = prompt('Edit sub-unit position:', subUnit.Position);
        if (newPosition && newPosition.trim() && newPosition !== subUnit.Position) {
          subUnit.Position = newPosition.trim();
          localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
          
          // Refresh displays
          document.getElementById(`current-subunits-${parentId}`).innerHTML = renderCurrentSubUnits(parentId);
          renderOrgChart();
          
          alert('Sub-unit updated successfully!');
        }
      }
    }

    function removeSubUnit(parentId, subUnitId) {
      if (confirm('Are you sure you want to remove this sub-unit?')) {
        const subUnits = orgChartData.subUnits[parentId] || [];
        const index = subUnits.findIndex(su => su.Id === subUnitId);
        
        if (index > -1) {
          subUnits.splice(index, 1);
          localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
          
          // Refresh displays
          document.getElementById(`current-subunits-${parentId}`).innerHTML = renderCurrentSubUnits(parentId);
          renderOrgChart();
          
          alert('Sub-unit removed successfully!');
        }
      }
    }

    function downloadOrgChartTemplate() {
      const templateData = [
        { Position: 'Chief Operating Officer', Level: 2, Color: 'green', Id: 'coo' },
        { Position: 'Chief Technology Officer', Level: 2, Color: 'blue', Id: 'cto' },
        { Position: 'Chief Financial Officer', Level: 2, Color: 'purple', Id: 'cfo' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Level 2 Template');
      XLSX.writeFile(wb, 'PLDT_Level2_OrgChart_Template.xlsx');
    }

    function exportOrgChartData() {
      if (userLevel !== 'level1' || isPreviewMode) {
        alert('Export functionality is only available for Level 1 administrators.');
        return;
      }
      
      const exportData = {
        level0: orgChartData.level0,
        level0_5: orgChartData.level0_5,
        level1: orgChartData.level1,
        level2: orgChartData.level2,
        subUnits: orgChartData.subUnits,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `PLDT_OrgChart_Export_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      alert('Org chart data exported successfully!');
    }

    function generateId(text) {
      return text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    function findParentElement(parentId) {
      return document.querySelector(`#node-${parentId}`)?.parentElement;
    }

    function addOrgConnectors() {
      // Clear existing connectors
      document.querySelectorAll('.org-connector-solid, .org-connector-dashed').forEach(el => el.remove());
      
      orgChartData.forEach(node => {
        // Draw solid line to direct report
        if (node.ReportsTo) {
          drawConnector(node.Id, node.ReportsTo, 'solid');
        }
        
        // Draw dashed line to functional report
        if (node.FunctionalReportsTo) {
          drawConnector(node.Id, node.FunctionalReportsTo, 'dashed');
        }
      });
    }

    function drawConnector(fromId, toId, lineType) {
      const fromElement = document.getElementById(`node-${fromId}`);
      const toElement = document.getElementById(`node-${toId}`);
      
      if (!fromElement || !toElement) return;
      
      const fromRect = fromElement.getBoundingClientRect();
      const toRect = toElement.getBoundingClientRect();
      const containerRect = document.getElementById('org-chart').getBoundingClientRect();
      
      // Calculate positions relative to the chart container
      const fromX = fromRect.left - containerRect.left + fromRect.width / 2;
      const fromY = fromRect.top - containerRect.top;
      const toX = toRect.left - containerRect.left + toRect.width / 2;
      const toY = toRect.top - containerRect.top + toRect.height;
      
      // Create vertical line from parent
      const verticalLine = document.createElement('div');
      verticalLine.className = `org-connector-${lineType} org-connector-vertical`;
      verticalLine.style.left = `${toX - 1}px`;
      verticalLine.style.top = `${toY}px`;
      verticalLine.style.height = `${Math.abs(fromY - toY) / 2}px`;
      
      // Create horizontal line
      const horizontalLine = document.createElement('div');
      horizontalLine.className = `org-connector-${lineType} org-connector-horizontal`;
      horizontalLine.style.left = `${Math.min(fromX, toX)}px`;
      horizontalLine.style.top = `${toY + Math.abs(fromY - toY) / 2 - 1}px`;
      horizontalLine.style.width = `${Math.abs(fromX - toX)}px`;
      
      // Create vertical line to child
      const verticalLine2 = document.createElement('div');
      verticalLine2.className = `org-connector-${lineType} org-connector-vertical`;
      verticalLine2.style.left = `${fromX - 1}px`;
      verticalLine2.style.top = `${toY + Math.abs(fromY - toY) / 2}px`;
      verticalLine2.style.height = `${Math.abs(fromY - toY) / 2}px`;
      
      // Add lines to chart container
      const chartContainer = document.getElementById('org-chart');
      chartContainer.appendChild(verticalLine);
      chartContainer.appendChild(horizontalLine);
      chartContainer.appendChild(verticalLine2);
    }

    // Org Chart Functions
    function toggleOrgNode(nodeId) {
      const children = document.getElementById(nodeId + '-children');
      if (children) {
        children.classList.toggle('hidden');
      }
    }

    function uploadOrgChart(event) {
      const file = event.target.files[0];
      if (!file) return;

      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.vsdx') || fileName.endsWith('.vsd')) {
        // Handle Visio files
        alert('Visio file detected! Please note:\n\n' +
              'â€¢ Visio files will be processed for basic org chart structure\n' +
              'â€¢ For best results, ensure your Visio diagram has:\n' +
              '  - Clear position titles in text boxes\n' +
              '  - Consistent connector lines for reporting relationships\n' +
              '  - Proper hierarchical layout\n\n' +
              'Processing may take a moment...');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            // Basic Visio processing - extract text content
            processVisioFile(e.target.result);
          } catch (error) {
            alert('Error processing Visio file. For complex diagrams, please export to Excel format using the template structure.');
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        // Handle Excel files
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // Process and update org chart
            updateOrgChart(jsonData);
            renderOrgChart();
            alert('Organizational chart updated successfully!');
          } catch (error) {
            alert('Error reading Excel file. Please check the format.');
          }
        };
        reader.readAsArrayBuffer(file);
      }
    }

    function processVisioFile(arrayBuffer) {
      try {
        // Convert ArrayBuffer to text for basic processing
        const decoder = new TextDecoder('utf-8');
        const text = decoder.decode(arrayBuffer);
        
        // Extract potential position titles (this is a simplified approach)
        const positions = [];
        const textMatches = text.match(/[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*/g) || [];
        
        // Filter for likely position titles
        const positionKeywords = ['Director', 'Manager', 'CEO', 'COO', 'President', 'Vice', 'Senior', 'Chief', 'Head', 'Lead', 'Supervisor', 'Coordinator'];
        const likelyPositions = textMatches.filter(match => 
          positionKeywords.some(keyword => match.includes(keyword)) && match.length > 5
        );
        
        if (likelyPositions.length > 0) {
          // Create basic org structure from detected positions
          const orgData = likelyPositions.map((position, index) => ({
            Level: index === 0 ? 1 : (index < 3 ? 2 : 3),
            Position: position,
            Parent: index === 0 ? '' : (index < 3 ? likelyPositions[0] : likelyPositions[1]),
            Color: 'blue',
            Id: `pos-${index}`,
            ReportsTo: index === 0 ? '' : (index < 3 ? `pos-0` : `pos-1`),
            FunctionalReportsTo: ''
          }));
          
          updateOrgChart(orgData);
          renderOrgChart();
          alert(`Visio file processed! Detected ${likelyPositions.length} positions.\n\nNote: This is a basic extraction. For precise org charts, please use the Excel template format.`);
        } else {
          alert('Could not extract organizational structure from Visio file.\n\nPlease export your Visio diagram to Excel format using our template structure for best results.');
        }
      } catch (error) {
        alert('Error processing Visio file. Please try exporting to Excel format instead.');
      }
    }

    function updateOrgChart(data) {
      orgChartData = data.map((row, index) => ({
        Level: row.Level || 1,
        Position: row.Position || 'Untitled Position',
        Parent: row.Parent || '',
        Color: row.Color || 'blue',
        Id: row.Id || `node-${index}`,
        ReportsTo: row.ReportsTo || row.Parent || '',
        FunctionalReportsTo: row.FunctionalReportsTo || ''
      }));
      // Save to localStorage for persistence
      localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
    }

    function downloadOrgTemplate() {
      const templateData = [
        { Level: 1, Position: 'Board of Directors', Parent: '', Color: 'gray', Id: 'board', ReportsTo: '', FunctionalReportsTo: '' },
        { Level: 2, Position: 'President and CEO', Parent: 'board', Color: 'gray', Id: 'ceo', ReportsTo: 'board', FunctionalReportsTo: '' },
        { Level: 2.5, Position: 'Internal Audit', Parent: 'board', Color: 'red', Id: 'internal-audit', ReportsTo: 'board', FunctionalReportsTo: 'ceo' },
        { Level: 2.5, Position: 'Corporate Governance', Parent: 'board', Color: 'red', Id: 'corp-governance', ReportsTo: 'board', FunctionalReportsTo: 'ceo' },
        { Level: 3, Position: 'PLDT COO', Parent: 'ceo', Color: 'green', Id: 'pldt-coo', ReportsTo: 'ceo', FunctionalReportsTo: '' },
        { Level: 3, Position: 'Smart COO', Parent: 'ceo', Color: 'orange', Id: 'smart-coo', ReportsTo: 'ceo', FunctionalReportsTo: '' },
        { Level: 3, Position: 'Technology Group', Parent: 'ceo', Color: 'purple', Id: 'technology', ReportsTo: 'ceo', FunctionalReportsTo: '' },
        { Level: 4, Position: 'Consumer Business', Parent: 'pldt-coo', Color: 'green', Id: 'consumer', ReportsTo: 'pldt-coo', FunctionalReportsTo: '' },
        { Level: 4, Position: 'Enterprise Business', Parent: 'pldt-coo', Color: 'green', Id: 'enterprise', ReportsTo: 'pldt-coo', FunctionalReportsTo: '' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'OrgChart Template');
      XLSX.writeFile(wb, 'PLDT_OrgChart_Template.xlsx');
    }

    function exportCurrentOrgStructure() {
      if (currentUser !== 'admin') {
        alert('Export functionality is only available for administrators.');
        return;
      }
      
      const exportData = [];
      
      // Export org chart data
      orgChartData.forEach(node => {
        exportData.push({
          Level: node.Level,
          Position: node.Position,
          Parent: node.Parent,
          Color: node.Color,
          Id: node.Id,
          ReportsTo: node.ReportsTo,
          FunctionalReportsTo: node.FunctionalReportsTo,
          Category: determineNodeCategory(node.Position),
          Unit: determineNodeUnit(node.Position),
          OrgUnit: determineNodeOrgUnit(node.Position)
        });
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Current Org Structure');
      XLSX.writeFile(wb, `PLDT_Current_OrgStructure_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      alert('Current organizational structure exported successfully!');
    }

    function exportStructureWithJDs() {
      if (currentUser !== 'admin') {
        alert('Export functionality is only available for administrators.');
        return;
      }
      
      const wb = XLSX.utils.book_new();
      
      // Sheet 1: Org Chart Structure
      const orgChartData_export = orgChartData.map(node => ({
        Level: node.Level,
        Position: node.Position,
        Parent: node.Parent,
        Color: node.Color,
        Id: node.Id,
        ReportsTo: node.ReportsTo,
        FunctionalReportsTo: node.FunctionalReportsTo,
        HasJD: jobDescriptions[node.Position] ? 'Yes' : 'No'
      }));
      
      const ws1 = XLSX.utils.json_to_sheet(orgChartData_export);
      XLSX.utils.book_append_sheet(wb, ws1, 'Org Chart');
      
      // Sheet 2: JD Structure
      const jdStructureData = [];
      Object.keys(orgStructure).forEach(category => {
        Object.keys(orgStructure[category]).forEach(unit => {
          Object.keys(orgStructure[category][unit]).forEach(orgUnit => {
            orgStructure[category][unit][orgUnit].forEach(position => {
              jdStructureData.push({
                Category: category,
                Unit: unit,
                OrgUnit: orgUnit,
                Position: position,
                HasJD: jobDescriptions[position] ? 'Yes' : 'No',
                JDStatus: jobDescriptions[position] ? 'Available' : 'Missing'
              });
            });
          });
        });
      });
      
      const ws2 = XLSX.utils.json_to_sheet(jdStructureData);
      XLSX.utils.book_append_sheet(wb, ws2, 'JD Structure');
      
      // Sheet 3: JD Summary
      const jdSummary = [];
      const totalPositions = jdStructureData.length;
      const positionsWithJD = jdStructureData.filter(pos => pos.HasJD === 'Yes').length;
      const positionsWithoutJD = totalPositions - positionsWithJD;
      
      // Category-wise summary
      Object.keys(orgStructure).forEach(category => {
        let categoryTotal = 0;
        let categoryWithJD = 0;
        
        Object.keys(orgStructure[category]).forEach(unit => {
          Object.keys(orgStructure[category][unit]).forEach(orgUnit => {
            categoryTotal += orgStructure[category][unit][orgUnit].length;
            categoryWithJD += orgStructure[category][unit][orgUnit].filter(pos => jobDescriptions[pos]).length;
          });
        });
        
        jdSummary.push({
          Category: category,
          TotalPositions: categoryTotal,
          WithJD: categoryWithJD,
          WithoutJD: categoryTotal - categoryWithJD,
          CompletionRate: categoryTotal > 0 ? `${Math.round((categoryWithJD / categoryTotal) * 100)}%` : '0%'
        });
      });
      
      // Overall summary
      jdSummary.unshift({
        Category: 'OVERALL SUMMARY',
        TotalPositions: totalPositions,
        WithJD: positionsWithJD,
        WithoutJD: positionsWithoutJD,
        CompletionRate: totalPositions > 0 ? `${Math.round((positionsWithJD / totalPositions) * 100)}%` : '0%'
      });
      
      const ws3 = XLSX.utils.json_to_sheet(jdSummary);
      XLSX.utils.book_append_sheet(wb, ws3, 'JD Summary');
      
      // Sheet 4: Missing JDs List
      const missingJDs = jdStructureData
        .filter(pos => pos.HasJD === 'No')
        .map(pos => ({
          Category: pos.Category,
          Unit: pos.Unit,
          OrgUnit: pos.OrgUnit,
          Position: pos.Position,
          Priority: determinePriority(pos.Position),
          Notes: 'JD Required'
        }));
      
      const ws4 = XLSX.utils.json_to_sheet(missingJDs);
      XLSX.utils.book_append_sheet(wb, ws4, 'Missing JDs');
      
      // Sheet 5: Reporting Lines
      const reportingLines = [];
      orgChartData.forEach(node => {
        if (node.ReportsTo) {
          const parentNode = orgChartData.find(n => n.Id === node.ReportsTo);
          reportingLines.push({
            Position: node.Position,
            ReportsTo: parentNode ? parentNode.Position : node.ReportsTo,
            ReportingType: 'Direct',
            Level: node.Level
          });
        }
        
        if (node.FunctionalReportsTo) {
          const functionalParent = orgChartData.find(n => n.Id === node.FunctionalReportsTo);
          reportingLines.push({
            Position: node.Position,
            ReportsTo: functionalParent ? functionalParent.Position : node.FunctionalReportsTo,
            ReportingType: 'Functional',
            Level: node.Level
          });
        }
      });
      
      const ws5 = XLSX.utils.json_to_sheet(reportingLines);
      XLSX.utils.book_append_sheet(wb, ws5, 'Reporting Lines');
      
      XLSX.writeFile(wb, `PLDT_Complete_Structure_with_JDs_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      alert(`Complete structure exported successfully!\n\nIncludes:\nâ€¢ Org Chart Structure\nâ€¢ JD Structure\nâ€¢ JD Completion Summary\nâ€¢ Missing JDs List\nâ€¢ Reporting Lines\n\nTotal Positions: ${totalPositions}\nWith JDs: ${positionsWithJD}\nCompletion Rate: ${Math.round((positionsWithJD / totalPositions) * 100)}%`);
    }

    function determineNodeCategory(position) {
      if (/Finance|Financial|Accounting|Treasury|Budget/i.test(position)) return 'SUPPORT';
      if (/Technology|IT|Digital|Cyber|Network|Engineering/i.test(position)) return 'TECHNOLOGY';
      if (/Sales|Marketing|Business|Customer|Consumer|Enterprise/i.test(position)) return 'BUSINESS';
      if (/Legal|Compliance|Audit|Governance/i.test(position)) return 'GOVERNANCE';
      if (/HR|Human Resources|People|Talent/i.test(position)) return 'SUPPORT';
      return 'OPERATIONS';
    }

    function determineNodeUnit(position) {
      if (/Consumer/i.test(position)) return 'Consumer Business';
      if (/Enterprise/i.test(position)) return 'Enterprise Business';
      if (/Network/i.test(position)) return 'Network Group';
      if (/Technology|IT/i.test(position)) return 'Technology Group';
      if (/Finance|Financial/i.test(position)) return 'Finance Group';
      if (/HR|Human Resources|People/i.test(position)) return 'People Group';
      if (/Legal/i.test(position)) return 'Legal Group';
      if (/Audit/i.test(position)) return 'Internal Audit';
      return 'General Operations';
    }

    function determineNodeOrgUnit(position) {
      if (/Regional|Area|District/i.test(position)) return 'Regional Operations';
      if (/Sales/i.test(position)) return 'Sales Division';
      if (/Marketing/i.test(position)) return 'Marketing Division';
      if (/Customer/i.test(position)) return 'Customer Service';
      if (/Network/i.test(position)) return 'Network Operations';
      if (/Infrastructure/i.test(position)) return 'Infrastructure';
      if (/Security|Cyber/i.test(position)) return 'Security Operations';
      if (/Financial|Finance/i.test(position)) return 'Financial Planning';
      if (/Accounting/i.test(position)) return 'Accounting';
      if (/HR|Human Resources/i.test(position)) return 'Human Resources';
      if (/Legal/i.test(position)) return 'Legal Affairs';
      if (/Compliance/i.test(position)) return 'Compliance';
      if (/Audit/i.test(position)) return 'Audit Operations';
      return 'General Operations';
    }

    function determinePriority(position) {
      if (/CEO|President|Chief|Director|Head/i.test(position)) return 'High';
      if (/Manager|Supervisor/i.test(position)) return 'Medium';
      return 'Low';
    }

    // Hierarchical Job Description Functions
    function viewOrgUnits(category, unit) {
      currentCategory = category;
      currentUnit = unit;
      
      document.getElementById('org-units-title').textContent = unit + ' - Organization Units';
      document.getElementById('breadcrumb-category').textContent = category;
      document.getElementById('breadcrumb-unit').textContent = unit;
      
      const content = document.getElementById('org-units-content');
      content.innerHTML = '';
      
      // Add sub-unit creation button for admins
      if (currentUser === 'admin') {
        const addSubUnitDiv = document.createElement('div');
        addSubUnitDiv.className = 'bg-green-50 border-2 border-dashed border-green-300 p-4 rounded-lg text-center hover:bg-green-100 cursor-pointer transition-colors';
        addSubUnitDiv.innerHTML = `
          <div class="text-green-600 text-2xl mb-2">â•</div>
          <h4 class="font-semibold text-green-800 mb-1">Add New Sub-Unit</h4>
          <p class="text-sm text-green-600">Create a new organizational sub-unit</p>
        `;
        addSubUnitDiv.onclick = () => showAddSubUnitForm(category, unit);
        content.appendChild(addSubUnitDiv);
      }
      
      if (orgStructure[category] && orgStructure[category][unit]) {
        Object.keys(orgStructure[category][unit]).forEach(orgUnit => {
          const div = document.createElement('div');
          div.className = 'bg-white border border-gray-200 p-4 rounded-lg shadow hover:shadow-md transition-shadow relative group';
          
          // Check if this org unit has sub-units
          const hasSubUnits = typeof orgStructure[category][unit][orgUnit] === 'object' && 
                             !Array.isArray(orgStructure[category][unit][orgUnit]) &&
                             Object.keys(orgStructure[category][unit][orgUnit]).length > 0;
          
          const positionCount = hasSubUnits ? 
            Object.values(orgStructure[category][unit][orgUnit]).reduce((total, subUnit) => {
              return total + (Array.isArray(subUnit) ? subUnit.length : 0);
            }, 0) :
            (Array.isArray(orgStructure[category][unit][orgUnit]) ? orgStructure[category][unit][orgUnit].length : 0);
          
          div.innerHTML = `
            <div class="cursor-pointer" onclick="${hasSubUnits ? `viewSubUnits('${category}', '${unit}', '${orgUnit}')` : `viewPositions('${category}', '${unit}', '${orgUnit}')`}">
              <h4 class="font-semibold text-lg text-blue-900 mb-2 flex items-center">
                ${orgUnit}
                ${hasSubUnits ? '<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Has Sub-Units</span>' : ''}
              </h4>
              <p class="text-sm text-gray-600">${positionCount} positions available</p>
              <div class="mt-2 text-xs text-blue-600">Click to view ${hasSubUnits ? 'sub-units' : 'positions'} â†’</div>
            </div>
            ${currentUser === 'admin' ? `
              <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="flex space-x-1">
                  <button onclick="event.stopPropagation(); addSubUnitToOrgUnit('${category}', '${unit}', '${orgUnit}')" 
                          class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600" 
                          title="Add Sub-Unit">
                    â•
                  </button>
                  <button onclick="event.stopPropagation(); removeOrgUnit('${category}', '${unit}', '${orgUnit}')" 
                          class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" 
                          title="Remove Unit">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            ` : ''}
          `;
          content.appendChild(div);
        });
      } else {
        content.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No organization units found. Upload structure file to populate.</div>';
      }
      
      document.getElementById('org-units-modal').classList.remove('hidden');
    }

    function viewPositions(category, unit, orgUnit, subUnit = null, parentPath = []) {
      currentCategory = category;
      currentUnit = unit;
      currentOrg = orgUnit;
      
      // Build the full path for nested navigation
      let fullPath = [...parentPath];
      if (orgUnit && !fullPath.includes(orgUnit)) {
        fullPath.push(orgUnit);
      }
      if (subUnit) {
        fullPath.push(subUnit);
      }
      
      const pathString = fullPath.join(' > ');
      const title = `${pathString} - Available Positions`;
      document.getElementById('positions-title').textContent = title;
      document.getElementById('positions-breadcrumb-category').textContent = category;
      document.getElementById('positions-breadcrumb-unit').textContent = unit;
      document.getElementById('positions-breadcrumb-org').textContent = pathString;
      
      const content = document.getElementById('positions-content');
      content.innerHTML = '';
      
      let positions = [];
      
      // Get positions using the nested structure helper
      const positionsData = getNestedStructure(category, unit, fullPath);
      
      if (Array.isArray(positionsData)) {
        positions = positionsData;
      } else if (typeof positionsData === 'object' && positionsData !== null) {
        // Check for direct positions at this level
        if (positionsData['_positions']) {
          positions = [...positionsData['_positions']];
        }
        // Also flatten all positions from nested sub-units for display
        const nestedPositions = flattenNestedPositions(positionsData);
        positions = [...positions, ...nestedPositions];
      }
      
      // Add position creation button for Level 2+ admins
      if ((userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode) {
        const addPositionDiv = document.createElement('div');
        addPositionDiv.className = 'bg-green-50 border-2 border-dashed border-green-300 p-4 rounded-lg text-center hover:bg-green-100 cursor-pointer transition-colors';
        addPositionDiv.innerHTML = `
          <div class="text-green-600 text-2xl mb-2">ğŸ‘¤</div>
          <h4 class="font-semibold text-green-800 mb-1">Add New Position</h4>
          <p class="text-sm text-green-600">Create a new position in ${fullPath[fullPath.length - 1]}</p>
        `;
        addPositionDiv.onclick = () => addNestedPosition(category, unit, fullPath);
        content.appendChild(addPositionDiv);
      }
      
      positions.forEach(position => {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-200 p-4 rounded-lg shadow hover:shadow-md transition-shadow relative group';
        
        const hasJD = jobDescriptions[position];
        const statusColor = hasJD ? 'text-green-600' : 'text-orange-600';
        const statusText = hasJD ? 'JD Available' : 'JD Pending';
        
        div.innerHTML = `
          <div class="cursor-pointer" onclick="viewJobDescription('${position}')">
            <h4 class="font-semibold text-lg text-gray-900 mb-2">${position}</h4>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm ${statusColor} font-medium">${statusText}</span>
              <span class="text-xs text-blue-600">Click to view â†’</span>
            </div>
            <div class="text-xs text-gray-500">Level ${fullPath.length} â€¢ ${pathString}</div>
          </div>
          ${(userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode ? `
            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <div class="flex space-x-1">
                <input type="file" id="jd-upload-${position.replace(/\s+/g, '-')}" accept=".pdf,.doc,.docx,.txt" class="hidden" onchange="uploadIndividualJD(event, '${position}')">
                <button onclick="event.stopPropagation(); document.getElementById('jd-upload-${position.replace(/\s+/g, '-')}').click()" 
                        class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" 
                        title="Upload JD">
                  ğŸ“„
                </button>
                ${userLevel === 'level1' ? `
                  <button onclick="event.stopPropagation(); removeNestedPosition('${category}', '${unit}', ${JSON.stringify(fullPath).replace(/"/g, '&quot;')}, '${position}')" 
                          class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" 
                          title="Remove Position">
                    ğŸ—‘ï¸
                  </button>
                ` : ''}
              </div>
            </div>
          ` : ''}
        `;
        content.appendChild(div);
      });
      
      if (positions.length === 0 && (userLevel !== 'level1' && userLevel !== 'level2')) {
        content.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No positions found.</div>';
      }
      
      document.getElementById('org-units-modal').classList.add('hidden');
      document.getElementById('sub-units-modal').classList.add('hidden');
      document.getElementById('positions-modal').classList.remove('hidden');
    }

    function flattenNestedPositions(data) {
      let positions = [];
      if (Array.isArray(data)) {
        positions = [...data];
      } else if (typeof data === 'object' && data !== null) {
        Object.keys(data).forEach(key => {
          if (key === '_positions') {
            // Add direct positions at this level
            if (Array.isArray(data[key])) {
              positions = positions.concat(data[key]);
            }
          } else {
            // Recursively flatten nested positions
            positions = positions.concat(flattenNestedPositions(data[key]));
          }
        });
      }
      return positions;
    }

    function addNestedPosition(category, unit, path) {
      const unitName = path[path.length - 1];
      const positionName = prompt(`Enter new position name for "${unitName}" (Level ${path.length}):`);
      
      if (positionName && positionName.trim()) {
        const trimmedName = positionName.trim();
        const currentData = getNestedStructure(category, unit, path);
        
        if (Array.isArray(currentData)) {
          if (!currentData.includes(trimmedName)) {
            currentData.push(trimmedName);
            setNestedStructure(category, unit, path, currentData);
            
            // Save to localStorage
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`Position "${trimmedName}" added successfully to Level ${path.length}!`);
            viewPositions(category, unit, path[0], path.length > 1 ? path[path.length - 1] : null, path.slice(0, -1));
          } else {
            alert('Position already exists!');
          }
        } else {
          // Convert to array structure first
          setNestedStructure(category, unit, path, [trimmedName]);
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          alert(`Position "${trimmedName}" added successfully to Level ${path.length}!`);
          viewPositions(category, unit, path[0], path.length > 1 ? path[path.length - 1] : null, path.slice(0, -1));
        }
      }
    }

    function removeNestedPosition(category, unit, path, position) {
      const level = path.length;
      if (confirm(`Are you sure you want to remove the position "${position}" from Level ${level}?`)) {
        const currentData = getNestedStructure(category, unit, path);
        
        if (Array.isArray(currentData)) {
          const index = currentData.indexOf(position);
          if (index > -1) {
            currentData.splice(index, 1);
            setNestedStructure(category, unit, path, currentData);
            
            // Also remove job description if exists
            if (jobDescriptions[position]) {
              delete jobDescriptions[position];
              localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
            }
            
            // Save to localStorage
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`Position "${position}" removed successfully!`);
            viewPositions(category, unit, path[0], path.length > 1 ? path[path.length - 1] : null, path.slice(0, -1));
          }
        }
      }
    }

    function addNewPosition(category, unit, orgUnit, subUnit = null) {
      const positionName = prompt(`Enter new position name for ${subUnit || orgUnit}:`);
      
      if (positionName && positionName.trim()) {
        const trimmedName = positionName.trim();
        
        if (subUnit) {
          // Adding to sub-unit
          if (!orgStructure[category][unit][orgUnit][subUnit]) {
            orgStructure[category][unit][orgUnit][subUnit] = [];
          }
          
          if (!orgStructure[category][unit][orgUnit][subUnit].includes(trimmedName)) {
            orgStructure[category][unit][orgUnit][subUnit].push(trimmedName);
          } else {
            alert('Position already exists!');
            return;
          }
        } else {
          // Adding to org unit directly
          if (!Array.isArray(orgStructure[category][unit][orgUnit])) {
            alert('This unit has sub-units. Please add positions to specific sub-units.');
            return;
          }
          
          if (!orgStructure[category][unit][orgUnit].includes(trimmedName)) {
            orgStructure[category][unit][orgUnit].push(trimmedName);
          } else {
            alert('Position already exists!');
            return;
          }
        }
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        
        alert(`Position "${trimmedName}" added successfully!`);
        viewPositions(category, unit, orgUnit, subUnit);
      }
    }

    function removePosition(category, unit, orgUnit, position, subUnit = '') {
      if (confirm(`Are you sure you want to remove the position "${position}"?`)) {
        if (subUnit) {
          // Remove from sub-unit
          const positions = orgStructure[category][unit][orgUnit][subUnit];
          const index = positions.indexOf(position);
          if (index > -1) {
            positions.splice(index, 1);
          }
        } else {
          // Remove from org unit directly
          const positions = orgStructure[category][unit][orgUnit];
          if (Array.isArray(positions)) {
            const index = positions.indexOf(position);
            if (index > -1) {
              positions.splice(index, 1);
            }
          }
        }
        
        // Also remove job description if exists
        if (jobDescriptions[position]) {
          delete jobDescriptions[position];
          localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
        }
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        
        alert(`Position "${position}" removed successfully!`);
        viewPositions(category, unit, orgUnit, subUnit || null);
      }
    }

    function viewJobDescription(title) {
      document.getElementById('jd-title').textContent = title;
      document.getElementById('jd-content').innerHTML = jobDescriptions[title] || 
        '<p class="text-gray-600">Job description not available. Please upload the job description file for this position.</p>';
      document.getElementById('jd-modal').classList.remove('hidden');
    }

    function closeJobDescriptionModal() {
      document.getElementById('jd-modal').classList.add('hidden');
    }

    function closeOrgUnitsModal() {
      document.getElementById('org-units-modal').classList.add('hidden');
    }

    function closePositionsModal() {
      document.getElementById('positions-modal').classList.add('hidden');
    }

    function goBackToCategory() {
      closeOrgUnitsModal();
      closePositionsModal();
      navigate('jd');
    }

    function goBackToUnits() {
      closePositionsModal();
      closeSubUnitsModal();
      viewOrgUnits(currentCategory, currentUnit);
    }

    function buildDynamicBreadcrumb(category, unit, path) {
      const breadcrumbNav = document.getElementById('sub-breadcrumb-nav');
      if (!breadcrumbNav) return;
      
      let breadcrumbHTML = `
        <span onclick="navigate('jd')" class="cursor-pointer hover:text-blue-600">Job Descriptions</span>
        <span class="mx-2">></span>
        <span class="cursor-pointer hover:text-blue-600" onclick="goBackToCategory()">${category}</span>
        <span class="mx-2">></span>
        <span class="cursor-pointer hover:text-blue-600" onclick="goBackToUnits()">${unit}</span>
      `;
      
      // Add each level of the path as clickable breadcrumb
      for (let i = 0; i < path.length; i++) {
        breadcrumbHTML += `<span class="mx-2">></span>`;
        
        if (i === path.length - 1) {
          // Last item is not clickable (current location)
          breadcrumbHTML += `<span class="text-gray-900 font-medium">${path[i]}</span>`;
        } else {
          // Previous levels are clickable
          const clickPath = path.slice(0, i + 1);
          breadcrumbHTML += `<span class="cursor-pointer hover:text-blue-600" onclick="navigateToNestedLevel('${category}', '${unit}', ${JSON.stringify(clickPath).replace(/"/g, '&quot;')})">${path[i]}</span>`;
        }
      }
      
      breadcrumbNav.innerHTML = breadcrumbHTML;
    }

    function navigateToNestedLevel(category, unit, path) {
      const parentPath = path.slice(0, -1);
      const currentLevel = path[path.length - 1];
      
      if (path.length === 1) {
        // Navigate to org units level
        viewOrgUnits(category, unit);
      } else {
        // Navigate to specific sub-unit level
        viewSubUnits(category, unit, currentLevel, parentPath);
      }
    }

    // Sub-Unit Management Functions
    let currentOrgUnit = '';
    let currentPath = []; // Track the current navigation path

    function viewSubUnits(category, unit, orgUnit, parentPath = []) {
      currentCategory = category;
      currentUnit = unit;
      currentOrgUnit = orgUnit;
      currentPath = [...parentPath, orgUnit];
      
      // Build dynamic title and breadcrumb
      const pathString = currentPath.join(' > ');
      document.getElementById('sub-units-title').textContent = pathString + ' - Sub-Units';
      
      // Build dynamic breadcrumb navigation
      buildDynamicBreadcrumb(category, unit, currentPath);
      
      const content = document.getElementById('sub-units-content');
      content.innerHTML = '';
      
      // Add drop zone for drag and drop
      if (currentUser === 'admin') {
        const dropZone = document.createElement('div');
        dropZone.className = 'bg-gray-50 border-2 border-dashed border-gray-300 p-4 rounded-lg text-center mb-4 hidden';
        dropZone.id = 'drop-zone';
        dropZone.innerHTML = `
          <div class="text-gray-400 text-2xl mb-2">ğŸ“</div>
          <p class="text-gray-600">Drop sub-unit here to move it</p>
        `;
        content.appendChild(dropZone);
      }
      
      // Add creation options for admins
      if (currentUser === 'admin') {
        // Add Sub-Unit option
        const addSubUnitDiv = document.createElement('div');
        addSubUnitDiv.className = 'bg-green-50 border-2 border-dashed border-green-300 p-4 rounded-lg text-center hover:bg-green-100 cursor-pointer transition-colors';
        addSubUnitDiv.innerHTML = `
          <div class="text-green-600 text-2xl mb-2">ğŸ¢</div>
          <h4 class="font-semibold text-green-800 mb-1">Add New Sub-Unit</h4>
          <p class="text-sm text-green-600">Create a new sub-unit within ${currentPath[currentPath.length - 1]} (Level ${currentPath.length + 1})</p>
        `;
        addSubUnitDiv.onclick = () => showAddNestedSubUnitForm(category, unit, currentPath);
        content.appendChild(addSubUnitDiv);

        // Add Position option
        const addPositionDiv = document.createElement('div');
        addPositionDiv.className = 'bg-blue-50 border-2 border-dashed border-blue-300 p-4 rounded-lg text-center hover:bg-blue-100 cursor-pointer transition-colors';
        addPositionDiv.innerHTML = `
          <div class="text-blue-600 text-2xl mb-2">ğŸ‘¤</div>
          <h4 class="font-semibold text-blue-800 mb-1">Add New Position</h4>
          <p class="text-sm text-blue-600">Create a new position directly in ${currentPath[currentPath.length - 1]}</p>
        `;
        addPositionDiv.onclick = () => addPositionDirectlyToCurrentLevel(category, unit, currentPath);
        content.appendChild(addPositionDiv);
      }
      
      // Navigate to the correct nested structure
      const currentData = getNestedStructure(category, unit, currentPath);
      
      if (currentData && typeof currentData === 'object' && !Array.isArray(currentData)) {
        // Show direct positions first if they exist
        if (currentData['_positions'] && currentData['_positions'].length > 0) {
          const directPositionsDiv = document.createElement('div');
          directPositionsDiv.className = 'bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4';
          directPositionsDiv.innerHTML = `
            <h4 class="font-semibold text-blue-900 mb-2 flex items-center">
              <span class="text-blue-600 mr-2">ğŸ‘¥</span>
              Direct Positions at Level ${currentPath.length} (${currentData['_positions'].length})
            </h4>
            <div class="text-sm text-gray-600 cursor-pointer hover:text-blue-600" onclick="viewDirectPositions('${category}', '${unit}', ${JSON.stringify(currentPath).replace(/"/g, '&quot;')})">
              ${currentData['_positions'].slice(0, 3).join(', ')}${currentData['_positions'].length > 3 ? '...' : ''}
              <div class="mt-2 text-xs text-blue-600">Click to view all direct positions â†’</div>
            </div>
          `;
          content.appendChild(directPositionsDiv);
        }
        
        // Show sub-units
        Object.keys(currentData).filter(key => key !== '_positions').forEach(subUnit => {
          const div = document.createElement('div');
          div.className = 'bg-white border border-gray-200 p-4 rounded-lg shadow hover:shadow-md transition-shadow relative group';
          
          // Make draggable for admin users
          if (currentUser === 'admin') {
            div.draggable = true;
            div.dataset.subUnit = subUnit;
            div.dataset.sourcePath = JSON.stringify(currentPath);
            div.dataset.category = category;
            div.dataset.unit = unit;
            
            // Add drag event listeners
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);
            div.addEventListener('dragenter', handleDragEnter);
            div.addEventListener('dragleave', handleDragLeave);
          }
          
          const subUnitData = currentData[subUnit];
          const hasNestedSubUnits = typeof subUnitData === 'object' && !Array.isArray(subUnitData) && Object.keys(subUnitData).some(key => key !== '_positions');
          const positionCount = countNestedPositions(subUnitData);
          
          // Check if this level has direct positions (mixed structure)
          const hasDirectPositions = typeof subUnitData === 'object' && subUnitData['_positions'] && subUnitData['_positions'].length > 0;
          
          const depth = currentPath.length;
          const colorIntensity = Math.min(depth, 8); // Support up to 8 levels
          const colorClasses = ['purple-500', 'purple-600', 'purple-700', 'purple-800', 'indigo-600', 'indigo-700', 'indigo-800', 'indigo-900'];
          const bgColorClasses = ['purple-50', 'purple-100', 'purple-200', 'purple-300', 'indigo-50', 'indigo-100', 'indigo-200', 'indigo-300'];
          
          div.innerHTML = `
            <div class="cursor-pointer" onclick="${hasNestedSubUnits ? 
              `viewSubUnits('${category}', '${unit}', '${subUnit}', ${JSON.stringify(currentPath).replace(/"/g, '&quot;')})` : 
              `viewPositions('${category}', '${unit}', '${orgUnit}', '${subUnit}', ${JSON.stringify(currentPath).replace(/"/g, '&quot;')})`}">
              <h4 class="font-semibold text-lg text-${colorClasses[colorIntensity - 1]} mb-2 flex items-center flex-wrap">
                ${currentUser === 'admin' ? '<span class="mr-2 text-gray-400 cursor-move">â‹®â‹®</span>' : ''}
                <span class="flex-1">${subUnit}</span>
                <div class="flex flex-wrap gap-1 ml-2">
                  ${hasNestedSubUnits ? `<span class="text-xs bg-${bgColorClasses[colorIntensity - 1]} text-${colorClasses[colorIntensity - 1]} px-2 py-1 rounded">Has Sub-Units</span>` : ''}
                  ${hasDirectPositions ? `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Direct Positions</span>` : ''}
                  <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Level ${depth + 1}</span>
                </div>
              </h4>
              <p class="text-sm text-gray-600">${positionCount} total positions</p>
              <div class="mt-2 text-xs text-${colorClasses[colorIntensity - 1]}">Click to view ${hasNestedSubUnits ? 'sub-units' : 'positions'} â†’</div>
            </div>
            ${currentUser === 'admin' ? `
              <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <div class="flex flex-wrap gap-1">
                  <button onclick="event.stopPropagation(); showAddNestedSubUnitForm('${category}', '${unit}', ${JSON.stringify([...currentPath, subUnit]).replace(/"/g, '&quot;')})" 
                          class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600" 
                          title="Add Sub-Unit (Level ${depth + 2})">
                    â•
                  </button>
                  <button onclick="event.stopPropagation(); addPositionToNestedSubUnit('${category}', '${unit}', ${JSON.stringify([...currentPath, subUnit]).replace(/"/g, '&quot;')})" 
                          class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" 
                          title="Add Position">
                    ğŸ‘¤
                  </button>
                  <button onclick="event.stopPropagation(); convertSubUnitToPositions('${category}', '${unit}', ${JSON.stringify([...currentPath, subUnit]).replace(/"/g, '&quot;')})" 
                          class="bg-yellow-500 text-white px-2 py-1 rounded text-xs hover:bg-yellow-600" 
                          title="Convert to Positions">
                    ğŸ”„
                  </button>
                  <button onclick="event.stopPropagation(); removeNestedSubUnit('${category}', '${unit}', ${JSON.stringify(currentPath).replace(/"/g, '&quot;')}, '${subUnit}')" 
                          class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" 
                          title="Remove Sub-Unit">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            ` : ''}
          `;
          content.appendChild(div);
        });
      } else if (Array.isArray(currentData)) {
        // This unit has direct positions, show option to convert to sub-units
        if (currentUser === 'admin') {
          const convertDiv = document.createElement('div');
          convertDiv.className = 'bg-yellow-50 border-2 border-dashed border-yellow-300 p-4 rounded-lg text-center hover:bg-yellow-100 cursor-pointer transition-colors';
          convertDiv.innerHTML = `
            <div class="text-yellow-600 text-2xl mb-2">ğŸ”„</div>
            <h4 class="font-semibold text-yellow-800 mb-1">Convert to Sub-Units</h4>
            <p class="text-sm text-yellow-600">This unit has ${currentData.length} direct positions. Convert to sub-unit structure?</p>
          `;
          convertDiv.onclick = () => convertNestedToSubUnits(category, unit, currentPath);
          content.appendChild(convertDiv);
        }
        
        // Show current positions
        const positionsDiv = document.createElement('div');
        positionsDiv.className = 'bg-blue-50 border border-blue-200 p-4 rounded-lg';
        positionsDiv.innerHTML = `
          <h4 class="font-semibold text-blue-900 mb-2">Current Positions (${currentData.length})</h4>
          <div class="text-sm text-gray-600 cursor-pointer hover:text-blue-600" onclick="viewPositions('${category}', '${unit}', '${orgUnit}', null, ${JSON.stringify(parentPath).replace(/"/g, '&quot;')})">
            ${currentData.slice(0, 3).join(', ')}${currentData.length > 3 ? '...' : ''}
            <div class="mt-2 text-xs text-blue-600">Click to view all positions â†’</div>
          </div>
        `;
        content.appendChild(positionsDiv);
      } else {
        content.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">No sub-units found.</div>';
      }
      
      document.getElementById('org-units-modal').classList.add('hidden');
      document.getElementById('sub-units-modal').classList.remove('hidden');
    }

    function closeSubUnitsModal() {
      document.getElementById('sub-units-modal').classList.add('hidden');
    }

    // Helper functions for nested structure management
    function getNestedStructure(category, unit, path) {
      let current = orgStructure[category]?.[unit];
      if (!current) return null;
      
      for (let i = 0; i < path.length; i++) {
        if (current && typeof current === 'object' && current[path[i]]) {
          current = current[path[i]];
        } else {
          return null;
        }
      }
      return current;
    }

    function setNestedStructure(category, unit, path, value) {
      if (!orgStructure[category]) orgStructure[category] = {};
      if (!orgStructure[category][unit]) orgStructure[category][unit] = {};
      
      let current = orgStructure[category][unit];
      
      // Navigate to the parent of the target
      for (let i = 0; i < path.length - 1; i++) {
        if (!current[path[i]]) current[path[i]] = {};
        current = current[path[i]];
      }
      
      // Set the value
      if (path.length > 0) {
        current[path[path.length - 1]] = value;
      } else {
        orgStructure[category][unit] = value;
      }
    }

    function countNestedPositions(data) {
      if (Array.isArray(data)) {
        return data.length;
      } else if (typeof data === 'object' && data !== null) {
        let count = 0;
        Object.keys(data).forEach(key => {
          if (key === '_positions') {
            // Count direct positions at this level
            count += Array.isArray(data[key]) ? data[key].length : 0;
          } else {
            // Count nested positions
            count += countNestedPositions(data[key]);
          }
        });
        return count;
      }
      return 0;
    }

    function showAddNestedSubUnitForm(category, unit, path) {
      const currentLevel = path.length;
      const parentName = path[path.length - 1];
      const subUnitName = prompt(`Enter name for new sub-unit within "${parentName}" (Level ${currentLevel + 1}):`);
      
      if (subUnitName && subUnitName.trim()) {
        const trimmedName = subUnitName.trim();
        
        // Get current parent data
        const parentData = getNestedStructure(category, unit, path);
        
        if (parentData) {
          // Convert to sub-unit structure if it's currently an array
          if (Array.isArray(parentData)) {
            const positions = [...parentData];
            const newStructure = {
              '_positions': positions, // Preserve existing positions
              [trimmedName]: {} // New sub-unit as object for further nesting
            };
            setNestedStructure(category, unit, path, newStructure);
          } else if (typeof parentData === 'object') {
            // Already has sub-units, just add new one
            const updatedParent = { ...parentData, [trimmedName]: {} };
            setNestedStructure(category, unit, path, updatedParent);
          } else {
            // Initialize as sub-unit structure
            setNestedStructure(category, unit, path, { [trimmedName]: {} });
          }
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`Sub-unit "${trimmedName}" added successfully at Level ${currentLevel + 1}!`);
          
          // Refresh current view
          viewSubUnits(category, unit, path[0], path.slice(1));
        }
      }
    }

    function addPositionDirectlyToCurrentLevel(category, unit, path) {
      const currentLevel = path.length;
      const unitName = path[path.length - 1];
      const positionName = prompt(`Enter position name for "${unitName}" (Level ${currentLevel}):`);
      
      if (positionName && positionName.trim()) {
        const trimmedName = positionName.trim();
        const currentData = getNestedStructure(category, unit, path);
        
        // Convert to mixed structure if needed (both sub-units and positions)
        if (typeof currentData === 'object' && !Array.isArray(currentData)) {
          // Already has sub-units, add positions array
          if (!currentData['_positions']) {
            currentData['_positions'] = [];
          }
          if (!currentData['_positions'].includes(trimmedName)) {
            currentData['_positions'].push(trimmedName);
            setNestedStructure(category, unit, path, currentData);
            
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            alert(`Position "${trimmedName}" added directly to Level ${currentLevel}!`);
            
            // Refresh current view
            const parentPath = path.slice(0, -1);
            viewSubUnits(category, unit, path[0], parentPath.slice(1));
          } else {
            alert('Position already exists at this level!');
          }
        } else if (Array.isArray(currentData)) {
          // Already positions array, just add to it
          if (!currentData.includes(trimmedName)) {
            currentData.push(trimmedName);
            setNestedStructure(category, unit, path, currentData);
            
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            alert(`Position "${trimmedName}" added to Level ${currentLevel}!`);
            
            // Refresh current view
            const parentPath = path.slice(0, -1);
            viewSubUnits(category, unit, path[0], parentPath.slice(1));
          } else {
            alert('Position already exists!');
          }
        } else {
          // Initialize as positions array
          setNestedStructure(category, unit, path, [trimmedName]);
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          alert(`Position "${trimmedName}" added to Level ${currentLevel}!`);
          
          // Refresh current view
          const parentPath = path.slice(0, -1);
          viewSubUnits(category, unit, path[0], parentPath.slice(1));
        }
      }
    }

    function addNestedSubUnit(category, unit, path) {
      const subUnitName = path[path.length - 1];
      const parentPath = path.slice(0, -1);
      
      // Get parent structure
      const parentData = getNestedStructure(category, unit, parentPath);
      
      if (parentData) {
        // Convert to sub-unit structure if it's currently an array
        if (Array.isArray(parentData)) {
          const positions = [...parentData];
          const newStructure = {
            '_positions': positions, // Use _positions for direct positions
            [subUnitName]: {} // Initialize as empty object to allow further nesting
          };
          setNestedStructure(category, unit, parentPath, newStructure);
        } else if (typeof parentData === 'object') {
          // Already has sub-units, just add new one
          const updatedParent = { ...parentData, [subUnitName]: {} }; // Initialize as object for nesting
          setNestedStructure(category, unit, parentPath, updatedParent);
        } else {
          // Initialize as sub-unit structure
          setNestedStructure(category, unit, parentPath, { [subUnitName]: {} });
        }
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        
        alert(`Sub-unit "${subUnitName}" added successfully at Level ${path.length}!`);
        
        // Refresh current view
        viewSubUnits(category, unit, parentPath[0] || path[0], parentPath.slice(1));
      }
    }

    // Drag and Drop Variables
    let draggedElement = null;
    let draggedData = null;

    // Drag and Drop Event Handlers
    function handleDragStart(e) {
      draggedElement = e.target;
      draggedData = {
        subUnit: e.target.dataset.subUnit,
        sourcePath: JSON.parse(e.target.dataset.sourcePath),
        category: e.target.dataset.category,
        unit: e.target.dataset.unit
      };
      
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.outerHTML);
      
      // Show drop zones
      showDropZones();
    }

    function handleDragEnd(e) {
      e.target.style.opacity = '1';
      draggedElement = null;
      draggedData = null;
      
      // Hide drop zones
      hideDropZones();
      
      // Remove drag indicators
      document.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      if (e.target !== draggedElement && e.target.dataset.subUnit) {
        e.target.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      e.target.classList.remove('drag-over');
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      e.target.classList.remove('drag-over');
      
      if (draggedElement !== e.target && draggedData) {
        const targetSubUnit = e.target.dataset.subUnit;
        const targetPath = JSON.parse(e.target.dataset.sourcePath || '[]');
        const targetCategory = e.target.dataset.category;
        const targetUnit = e.target.dataset.unit;
        
        if (targetSubUnit && targetCategory && targetUnit) {
          moveSubUnit(draggedData, {
            subUnit: targetSubUnit,
            path: targetPath,
            category: targetCategory,
            unit: targetUnit
          });
        }
      }
      
      return false;
    }

    function showDropZones() {
      const dropZone = document.getElementById('drop-zone');
      if (dropZone) {
        dropZone.classList.remove('hidden');
        dropZone.addEventListener('dragover', handleDropZoneDragOver);
        dropZone.addEventListener('drop', handleDropZoneDrop);
      }
      
      // Highlight potential drop targets
      document.querySelectorAll('[data-sub-unit]').forEach(el => {
        if (el !== draggedElement) {
          el.style.border = '2px dashed #10b981';
          el.style.backgroundColor = '#f0fdf4';
        }
      });
    }

    function hideDropZones() {
      const dropZone = document.getElementById('drop-zone');
      if (dropZone) {
        dropZone.classList.add('hidden');
        dropZone.removeEventListener('dragover', handleDropZoneDragOver);
        dropZone.removeEventListener('drop', handleDropZoneDrop);
      }
      
      // Remove drop target highlighting
      document.querySelectorAll('[data-sub-unit]').forEach(el => {
        el.style.border = '';
        el.style.backgroundColor = '';
      });
    }

    function handleDropZoneDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDropZoneDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      if (draggedData) {
        // Move to current level (extract from parent)
        extractSubUnit(draggedData);
      }
      
      return false;
    }

    function moveSubUnit(source, target) {
      if (confirm(`Move "${source.subUnit}" into "${target.subUnit}"?`)) {
        // Get source data
        const sourceData = getNestedStructure(source.category, source.unit, [...source.sourcePath, source.subUnit]);
        
        if (sourceData) {
          // Add to target location
          const targetParentPath = [...target.path, target.subUnit];
          const targetParentData = getNestedStructure(target.category, target.unit, targetParentPath);
          
          if (targetParentData && typeof targetParentData === 'object') {
            // Convert target to sub-unit structure if it's an array
            if (Array.isArray(targetParentData)) {
              const newTargetStructure = {
                'Main': [...targetParentData],
                [source.subUnit]: sourceData
              };
              setNestedStructure(target.category, target.unit, targetParentPath, newTargetStructure);
            } else {
              // Add to existing sub-unit structure
              const updatedTarget = { ...targetParentData, [source.subUnit]: sourceData };
              setNestedStructure(target.category, target.unit, targetParentPath, updatedTarget);
            }
            
            // Remove from source location
            const sourceParentData = getNestedStructure(source.category, source.unit, source.sourcePath);
            if (sourceParentData && typeof sourceParentData === 'object') {
              delete sourceParentData[source.subUnit];
              setNestedStructure(source.category, source.unit, source.sourcePath, sourceParentData);
            }
            
            // Save changes
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`"${source.subUnit}" moved successfully into "${target.subUnit}"!`);
            
            // Refresh current view
            viewSubUnits(currentCategory, currentUnit, currentPath[0], currentPath.slice(1));
          }
        }
      }
    }

    function extractSubUnit(source) {
      if (confirm(`Extract "${source.subUnit}" to current level?`)) {
        // Get source data
        const sourceData = getNestedStructure(source.category, source.unit, [...source.sourcePath, source.subUnit]);
        
        if (sourceData) {
          // Add to current level
          const currentData = getNestedStructure(currentCategory, currentUnit, currentPath);
          if (currentData && typeof currentData === 'object') {
            const updatedCurrent = { ...currentData, [source.subUnit]: sourceData };
            setNestedStructure(currentCategory, currentUnit, currentPath, updatedCurrent);
            
            // Remove from source location
            const sourceParentData = getNestedStructure(source.category, source.unit, source.sourcePath);
            if (sourceParentData && typeof sourceParentData === 'object') {
              delete sourceParentData[source.subUnit];
              setNestedStructure(source.category, source.unit, source.sourcePath, sourceParentData);
            }
            
            // Save changes
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`"${source.subUnit}" extracted to current level successfully!`);
            
            // Refresh current view
            viewSubUnits(currentCategory, currentUnit, currentPath[0], currentPath.slice(1));
          }
        }
      }
    }

    function convertSubUnitToPositions(category, unit, path) {
      const subUnitName = path[path.length - 1];
      const level = path.length;
      
      if (confirm(`Convert "${subUnitName}" (Level ${level}) to direct positions? All nested sub-units will be flattened.`)) {
        const subUnitData = getNestedStructure(category, unit, path);
        
        if (subUnitData) {
          // Flatten all nested positions
          const allPositions = flattenNestedPositions(subUnitData);
          
          // Replace with flattened positions array
          setNestedStructure(category, unit, path, allPositions);
          
          // Save changes
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`"${subUnitName}" converted to ${allPositions.length} direct positions successfully!`);
          
          // Refresh current view
          const parentPath = path.slice(0, -1);
          viewSubUnits(category, unit, parentPath[0] || path[0], parentPath.slice(1));
        }
      }
    }

    function addPositionToNestedSubUnit(category, unit, path) {
      const subUnitName = path[path.length - 1];
      const positionName = prompt(`Enter position name for "${subUnitName}":`);
      
      if (positionName && positionName.trim()) {
        const trimmedName = positionName.trim();
        const currentData = getNestedStructure(category, unit, path);
        
        if (Array.isArray(currentData)) {
          if (!currentData.includes(trimmedName)) {
            currentData.push(trimmedName);
            setNestedStructure(category, unit, path, currentData);
            
            // Save to localStorage
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`Position "${trimmedName}" added to "${subUnitName}" successfully!`);
            
            // Refresh current view
            const parentPath = path.slice(0, -1);
            viewSubUnits(category, unit, parentPath[0] || path[0], parentPath.slice(1));
          } else {
            alert('Position already exists in this sub-unit!');
          }
        } else if (typeof currentData === 'object') {
          // Add to _positions array for mixed structure
          if (!currentData['_positions']) {
            currentData['_positions'] = [];
          }
          if (!currentData['_positions'].includes(trimmedName)) {
            currentData['_positions'].push(trimmedName);
            setNestedStructure(category, unit, path, currentData);
            
            // Save to localStorage
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`Position "${trimmedName}" added to "${subUnitName}" successfully!`);
            
            // Refresh current view
            const parentPath = path.slice(0, -1);
            viewSubUnits(category, unit, parentPath[0] || path[0], parentPath.slice(1));
          } else {
            alert('Position already exists in this sub-unit!');
          }
        } else {
          alert('Cannot add position to this sub-unit. It may contain nested sub-units.');
        }
      }
    }

    function viewDirectPositions(category, unit, path) {
      const currentData = getNestedStructure(category, unit, path);
      const directPositions = currentData['_positions'] || [];
      
      if (directPositions.length === 0) {
        alert('No direct positions found at this level.');
        return;
      }
      
      // Use the existing positions modal to show direct positions
      const pathString = path.join(' > ');
      document.getElementById('positions-title').textContent = `${pathString} - Direct Positions`;
      document.getElementById('positions-breadcrumb-category').textContent = category;
      document.getElementById('positions-breadcrumb-unit').textContent = unit;
      document.getElementById('positions-breadcrumb-org').textContent = pathString;
      
      const content = document.getElementById('positions-content');
      content.innerHTML = '';
      
      // Add position creation button for admins
      if (currentUser === 'admin') {
        const addPositionDiv = document.createElement('div');
        addPositionDiv.className = 'bg-green-50 border-2 border-dashed border-green-300 p-4 rounded-lg text-center hover:bg-green-100 cursor-pointer transition-colors';
        addPositionDiv.innerHTML = `
          <div class="text-green-600 text-2xl mb-2">ğŸ‘¤</div>
          <h4 class="font-semibold text-green-800 mb-1">Add New Direct Position</h4>
          <p class="text-sm text-green-600">Create a new position directly at Level ${path.length}</p>
        `;
        addPositionDiv.onclick = () => addDirectPosition(category, unit, path);
        content.appendChild(addPositionDiv);
      }
      
      directPositions.forEach(position => {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-200 p-4 rounded-lg shadow hover:shadow-md transition-shadow relative group';
        
        const hasJD = jobDescriptions[position];
        const statusColor = hasJD ? 'text-green-600' : 'text-orange-600';
        const statusText = hasJD ? 'JD Available' : 'JD Pending';
        
        div.innerHTML = `
          <div class="cursor-pointer" onclick="viewJobDescription('${position}')">
            <h4 class="font-semibold text-lg text-gray-900 mb-2">${position}</h4>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm ${statusColor} font-medium">${statusText}</span>
              <span class="text-xs text-blue-600">Click to view â†’</span>
            </div>
            <div class="text-xs text-gray-500">Direct Position â€¢ Level ${path.length} â€¢ ${pathString}</div>
          </div>
          ${currentUser === 'admin' ? `
            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <div class="flex space-x-1">
                <input type="file" id="jd-upload-${position.replace(/\s+/g, '-')}" accept=".pdf,.doc,.docx,.txt" class="hidden" onchange="uploadIndividualJD(event, '${position}')">
                <button onclick="event.stopPropagation(); document.getElementById('jd-upload-${position.replace(/\s+/g, '-')}').click()" 
                        class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" 
                        title="Upload JD">
                  ğŸ“„
                </button>
                <button onclick="event.stopPropagation(); removeDirectPosition('${category}', '${unit}', ${JSON.stringify(path).replace(/"/g, '&quot;')}, '${position}')" 
                        class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" 
                        title="Remove Position">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          ` : ''}
        `;
        content.appendChild(div);
      });
      
      document.getElementById('sub-units-modal').classList.add('hidden');
      document.getElementById('positions-modal').classList.remove('hidden');
    }

    function addDirectPosition(category, unit, path) {
      const pathString = path.join(' > ');
      const positionName = prompt(`Enter new direct position name for "${pathString}" (Level ${path.length}):`);
      
      if (positionName && positionName.trim()) {
        const trimmedName = positionName.trim();
        const currentData = getNestedStructure(category, unit, path);
        
        if (!currentData['_positions']) {
          currentData['_positions'] = [];
        }
        
        if (!currentData['_positions'].includes(trimmedName)) {
          currentData['_positions'].push(trimmedName);
          setNestedStructure(category, unit, path, currentData);
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`Direct position "${trimmedName}" added successfully to Level ${path.length}!`);
          viewDirectPositions(category, unit, path);
        } else {
          alert('Position already exists at this level!');
        }
      }
    }

    function removeDirectPosition(category, unit, path, position) {
      const level = path.length;
      if (confirm(`Are you sure you want to remove the direct position "${position}" from Level ${level}?`)) {
        const currentData = getNestedStructure(category, unit, path);
        
        if (currentData['_positions']) {
          const index = currentData['_positions'].indexOf(position);
          if (index > -1) {
            currentData['_positions'].splice(index, 1);
            setNestedStructure(category, unit, path, currentData);
            
            // Also remove job description if exists
            if (jobDescriptions[position]) {
              delete jobDescriptions[position];
              localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
            }
            
            // Save to localStorage
            localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
            
            alert(`Direct position "${position}" removed successfully!`);
            viewDirectPositions(category, unit, path);
          }
        }
      }
    }

    function removeNestedSubUnit(category, unit, parentPath, subUnitName) {
      const fullPath = [...parentPath, subUnitName];
      const level = fullPath.length;
      
      if (confirm(`Are you sure you want to remove the Level ${level} sub-unit "${subUnitName}"? This will also remove all nested sub-units and positions within it.`)) {
        const parentData = getNestedStructure(category, unit, parentPath);
        
        if (parentData && typeof parentData === 'object') {
          delete parentData[subUnitName];
          
          // If no sub-units left, convert back to array
          const remainingSubUnits = Object.keys(parentData);
          if (remainingSubUnits.length === 0) {
            setNestedStructure(category, unit, parentPath, []);
          } else if (remainingSubUnits.length === 1 && remainingSubUnits[0] === 'Main') {
            // Only 'Main' left, convert back to direct positions
            setNestedStructure(category, unit, parentPath, parentData['Main']);
          } else {
            setNestedStructure(category, unit, parentPath, parentData);
          }
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`Sub-unit "${subUnitName}" removed successfully!`);
          
          // Refresh current view
          viewSubUnits(category, unit, parentPath[0] || 'root', parentPath.slice(1));
        }
      }
    }

    function convertNestedToSubUnits(category, unit, path) {
      const unitName = path[path.length - 1];
      if (confirm(`Convert "${unitName}" to use sub-units? Current positions will be moved to a "Main" sub-unit.`)) {
        const currentPositions = getNestedStructure(category, unit, path);
        
        if (Array.isArray(currentPositions)) {
          const newStructure = {
            'Main': [...currentPositions]
          };
          setNestedStructure(category, unit, path, newStructure);
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`"${unitName}" converted to sub-unit structure successfully!`);
          
          // Refresh current view
          const parentPath = path.slice(0, -1);
          viewSubUnits(category, unit, path[0], parentPath.slice(1));
        }
      }
    }

    function showAddSubUnitForm(category, unit, orgUnit = null) {
      const subUnitName = prompt(orgUnit ? 
        `Enter name for new sub-unit within "${orgUnit}":` : 
        `Enter name for new organizational unit within "${unit}":`
      );
      
      if (subUnitName && subUnitName.trim()) {
        if (orgUnit) {
          // Adding sub-unit to existing org unit
          addSubUnitToOrgUnit(category, unit, orgUnit, subUnitName.trim());
        } else {
          // Adding new org unit
          addNewOrgUnit(category, unit, subUnitName.trim());
        }
      }
    }

    function addSubUnitToOrgUnit(category, unit, orgUnit, subUnitName = null) {
      if (!subUnitName) {
        subUnitName = prompt(`Enter name for new sub-unit within "${orgUnit}":`);
      }
      
      if (subUnitName && subUnitName.trim()) {
        const trimmedName = subUnitName.trim();
        
        // Initialize structure if needed
        if (!orgStructure[category]) orgStructure[category] = {};
        if (!orgStructure[category][unit]) orgStructure[category][unit] = {};
        
        const currentOrgUnit = orgStructure[category][unit][orgUnit];
        
        // Convert to sub-unit structure if it's currently an array
        if (Array.isArray(currentOrgUnit)) {
          const positions = [...currentOrgUnit];
          orgStructure[category][unit][orgUnit] = {
            'Main': positions,
            [trimmedName]: []
          };
        } else if (typeof currentOrgUnit === 'object') {
          // Already has sub-units, just add new one
          orgStructure[category][unit][orgUnit][trimmedName] = [];
        } else {
          // Initialize as sub-unit structure
          orgStructure[category][unit][orgUnit] = {
            [trimmedName]: []
          };
        }
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        
        alert(`Sub-unit "${trimmedName}" added successfully!`);
        
        // Refresh current view
        if (document.getElementById('sub-units-modal').classList.contains('hidden') === false) {
          viewSubUnits(category, unit, orgUnit);
        } else {
          viewOrgUnits(category, unit);
        }
      }
    }

    function addNewOrgUnit(category, unit, orgUnitName) {
      if (!orgStructure[category]) orgStructure[category] = {};
      if (!orgStructure[category][unit]) orgStructure[category][unit] = {};
      
      if (orgStructure[category][unit][orgUnitName]) {
        alert('Organization unit already exists!');
        return;
      }
      
      orgStructure[category][unit][orgUnitName] = [];
      
      // Save to localStorage
      localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
      
      alert(`Organization unit "${orgUnitName}" added successfully!`);
      viewOrgUnits(category, unit);
    }

    function removeSubUnit(category, unit, orgUnit, subUnit) {
      if (confirm(`Are you sure you want to remove the sub-unit "${subUnit}"? This will also remove all positions within it.`)) {
        if (orgStructure[category] && orgStructure[category][unit] && orgStructure[category][unit][orgUnit]) {
          delete orgStructure[category][unit][orgUnit][subUnit];
          
          // If no sub-units left, convert back to array
          const remainingSubUnits = Object.keys(orgStructure[category][unit][orgUnit]);
          if (remainingSubUnits.length === 0) {
            orgStructure[category][unit][orgUnit] = [];
          } else if (remainingSubUnits.length === 1 && remainingSubUnits[0] === 'Main') {
            // Only 'Main' left, convert back to direct positions
            orgStructure[category][unit][orgUnit] = orgStructure[category][unit][orgUnit]['Main'];
          }
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`Sub-unit "${subUnit}" removed successfully!`);
          viewSubUnits(category, unit, orgUnit);
        }
      }
    }

    function removeOrgUnit(category, unit, orgUnit) {
      if (confirm(`Are you sure you want to remove the organizational unit "${orgUnit}"? This will also remove all sub-units and positions within it.`)) {
        if (orgStructure[category] && orgStructure[category][unit]) {
          delete orgStructure[category][unit][orgUnit];
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`Organizational unit "${orgUnit}" removed successfully!`);
          viewOrgUnits(category, unit);
        }
      }
    }

    function convertToSubUnits(category, unit, orgUnit) {
      if (confirm(`Convert "${orgUnit}" to use sub-units? Current positions will be moved to a "Main" sub-unit.`)) {
        const currentPositions = orgStructure[category][unit][orgUnit];
        
        orgStructure[category][unit][orgUnit] = {
          'Main': Array.isArray(currentPositions) ? currentPositions : []
        };
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        
        alert(`"${orgUnit}" converted to sub-unit structure successfully!`);
        viewSubUnits(category, unit, orgUnit);
      }
    }

    function addPositionToSubUnit(category, unit, orgUnit, subUnit) {
      const positionName = prompt(`Enter position name for "${subUnit}":`);
      
      if (positionName && positionName.trim()) {
        const trimmedName = positionName.trim();
        
        if (!orgStructure[category][unit][orgUnit][subUnit]) {
          orgStructure[category][unit][orgUnit][subUnit] = [];
        }
        
        if (!orgStructure[category][unit][orgUnit][subUnit].includes(trimmedName)) {
          orgStructure[category][unit][orgUnit][subUnit].push(trimmedName);
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          alert(`Position "${trimmedName}" added to "${subUnit}" successfully!`);
          viewSubUnits(category, unit, orgUnit);
        } else {
          alert('Position already exists in this sub-unit!');
        }
      }
    }

    function uploadOrgStructure(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // Process and update org structure
          updateOrgStructure(jsonData);
          alert('Organization structure updated successfully!');
        } catch (error) {
          alert('Error reading Excel file. Please check the format.');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function updateOrgStructure(data) {
      // Reset structure
      orgStructure = { 'BUSINESS': {}, 'TECHNOLOGY': {}, 'SUPPORT': {}, 'GOVERNANCE': {} };
      
      data.forEach(row => {
        const category = row.Category;
        const unit = row.Unit;
        const orgUnit = row.OrgUnit;
        const position = row.Position;
        
        if (!orgStructure[category]) orgStructure[category] = {};
        if (!orgStructure[category][unit]) orgStructure[category][unit] = {};
        if (!orgStructure[category][unit][orgUnit]) orgStructure[category][unit][orgUnit] = [];
        
        if (position && !orgStructure[category][unit][orgUnit].includes(position)) {
          orgStructure[category][unit][orgUnit].push(position);
        }
      });
    }

    function downloadStructureTemplate() {
      const templateData = [
        { Category: 'BUSINESS', Unit: 'Consumer Business Home', OrgUnit: 'Regional Operations', Position: 'Manager - Regional Operations' },
        { Category: 'BUSINESS', Unit: 'Consumer Business Home', OrgUnit: 'Regional Operations', Position: 'Senior Specialist - Customer Relations' },
        { Category: 'BUSINESS', Unit: 'Consumer Business Home', OrgUnit: 'Sales Division', Position: 'Sales Manager' },
        { Category: 'TECHNOLOGY', Unit: 'Network Group', OrgUnit: 'Infrastructure', Position: 'Network Infrastructure Manager' },
        { Category: 'SUPPORT', Unit: 'Finance Group', OrgUnit: 'Financial Planning', Position: 'Finance Manager' },
        { Category: 'GOVERNANCE', Unit: 'Internal Audit', OrgUnit: 'Audit Operations', Position: 'Chief Audit Executive' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Org Structure Template');
      XLSX.writeFile(wb, 'PLDT_OrgStructure_Template.xlsx');
    }

    function uploadPositionJD(event) {
      const files = event.target.files;
      if (!files.length) return;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileName = file.name.replace(/\.[^/.]+$/, "");
          jobDescriptions[fileName] = `<div class="whitespace-pre-wrap">${e.target.result}</div>`;
          // Save to localStorage for persistence
          localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
        };
        reader.readAsText(file);
      });

      alert(`${files.length} job description(s) uploaded successfully!`);
      // Refresh the positions view to show updated status
      if (currentCategory && currentUnit && currentOrg) {
        viewPositions(currentCategory, currentUnit, currentOrg);
      }
    }

    function uploadBulkJD(event) {
      const files = event.target.files;
      if (!files.length) return;

      let uploadedCount = 0;
      let matchedCount = 0;
      let unmatchedFiles = [];

      // Get all available positions from current structure
      const allPositions = [];
      Object.keys(orgStructure).forEach(category => {
        Object.keys(orgStructure[category]).forEach(unit => {
          Object.keys(orgStructure[category][unit]).forEach(orgUnit => {
            orgStructure[category][unit][orgUnit].forEach(position => {
              allPositions.push(position);
            });
          });
        });
      });

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileName = file.name.replace(/\.[^/.]+$/, "");
          
          // Try to match filename with positions using fuzzy matching
          let matchedPosition = findBestPositionMatch(fileName, allPositions);
          
          if (matchedPosition) {
            jobDescriptions[matchedPosition] = `<div class="whitespace-pre-wrap">${e.target.result}</div>`;
            matchedCount++;
          } else {
            // Store with original filename if no match found
            jobDescriptions[fileName] = `<div class="whitespace-pre-wrap">${e.target.result}</div>`;
            unmatchedFiles.push(fileName);
          }
          
          uploadedCount++;
          
          // Show results when all files are processed
          if (uploadedCount === files.length) {
            localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
            
            let message = `Bulk upload completed!\n\n`;
            message += `ğŸ“ Total files processed: ${uploadedCount}\n`;
            message += `âœ… Auto-matched to positions: ${matchedCount}\n`;
            message += `âš ï¸ Stored with original names: ${unmatchedFiles.length}\n`;
            
            if (unmatchedFiles.length > 0) {
              message += `\nUnmatched files:\n${unmatchedFiles.slice(0, 5).join('\n')}`;
              if (unmatchedFiles.length > 5) {
                message += `\n... and ${unmatchedFiles.length - 5} more`;
              }
              message += `\n\nTip: Name files exactly like position titles for auto-matching!`;
            }
            
            alert(message);
            
            // Refresh current view if in positions modal
            if (currentCategory && currentUnit && currentOrg) {
              viewPositions(currentCategory, currentUnit, currentOrg);
            }
          }
        };
        reader.readAsText(file);
      });
      
      // Reset file input
      event.target.value = '';
    }

    // Category-specific upload functions
    function showCategoryUploadButtons() {
      // Show all category upload buttons for admin
      const categories = [
        'Consumer-Business-Home', 'Consumer-Business-Wireless', 'Home-Sales-and-Development',
        'Wireless-Sales-and-Development', 'Enterprise-Business', 'Network-Group',
        'Information-Technology', 'Cybersecurity', 'Finance-Group', 'People-Group',
        'Supply-Chain-Management-and-Privacy-Office', 'Legal-and-Regulatory',
        'Internal-Audit', 'Corporate-Governance'
      ];
      
      categories.forEach(category => {
        const uploadDiv = document.getElementById(`admin-upload-${category}`);
        if (uploadDiv) {
          uploadDiv.classList.remove('hidden');
        }
      });
    }

    function showExportButtons() {
      // Show export buttons for admin
      const exportButtons = [
        'export-org-btn',
        'export-jd-btn', 
        'export-categories-btn'
      ];
      
      exportButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.classList.remove('hidden');
        }
      });
    }

    function hideExportButtons() {
      // Hide export buttons for viewers
      const exportButtons = [
        'export-org-btn',
        'export-jd-btn',
        'export-categories-btn'
      ];
      
      exportButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.classList.add('hidden');
        }
      });
    }

    function uploadCategoryStructure(event, category, unit) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // Process and update specific category structure
          updateCategoryStructure(jsonData, category, unit);
          alert(`Structure for ${unit} updated successfully!`);
        } catch (error) {
          alert('Error reading Excel file. Please check the format.');
        }
      };
      reader.readAsArrayBuffer(file);
      
      // Reset file input
      event.target.value = '';
    }

    function updateCategoryStructure(data, category, unit) {
      // Initialize category and unit if they don't exist
      if (!orgStructure[category]) orgStructure[category] = {};
      if (!orgStructure[category][unit]) orgStructure[category][unit] = {};
      
      // Clear existing data for this specific unit
      orgStructure[category][unit] = {};
      
      data.forEach(row => {
        const orgUnit = row.OrgUnit || row['Organization Unit'] || row['Org Unit'];
        const position = row.Position || row['Position Title'] || row['Job Title'];
        
        if (orgUnit && position) {
          if (!orgStructure[category][unit][orgUnit]) {
            orgStructure[category][unit][orgUnit] = [];
          }
          
          if (!orgStructure[category][unit][orgUnit].includes(position)) {
            orgStructure[category][unit][orgUnit].push(position);
          }
        }
      });
      
      // Save to localStorage for persistence
      localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
    }

    function downloadCategoryTemplate(category, unit) {
      const templateData = [
        { OrgUnit: 'Sample Department 1', Position: 'Manager - Sample Department 1' },
        { OrgUnit: 'Sample Department 1', Position: 'Senior Specialist - Sample Area' },
        { OrgUnit: 'Sample Department 1', Position: 'Analyst - Sample Function' },
        { OrgUnit: 'Sample Department 2', Position: 'Manager - Sample Department 2' },
        { OrgUnit: 'Sample Department 2', Position: 'Senior Representative - Sample Role' },
        { OrgUnit: 'Sample Department 2', Position: 'Coordinator - Sample Activity' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Structure Template');
      XLSX.writeFile(wb, `${unit.replace(/\s+/g, '_')}_Structure_Template.xlsx`);
    }

    // Logo Upload Function
    function uploadLogo(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        // Update all logo instances
        document.getElementById('company-logo').src = e.target.result;
        document.getElementById('org-company-logo').src = e.target.result;
        document.getElementById('jd-company-logo').src = e.target.result;
        document.getElementById('admin-company-logo').src = e.target.result;
        document.getElementById('login-logo').src = e.target.result;
        // Store in localStorage for persistence
        localStorage.setItem('companyLogo', e.target.result);
        alert('Logo updated successfully!');
      };
      reader.readAsDataURL(file);
    }

    // Icon Upload Function
    function uploadIcon(event, iconType) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        // Update the specific icon
        const iconElement = document.getElementById(iconType + '-icon');
        iconElement.src = e.target.result;
        // Remove any filter effects to show the custom icon properly
        iconElement.style.filter = 'none';
        // Store in localStorage for persistence
        localStorage.setItem(iconType + 'Icon', e.target.result);
        alert(`${iconType.charAt(0).toUpperCase() + iconType.slice(1)} icon updated successfully!`);
      };
      reader.readAsDataURL(file);
    }

    // Logo Removal Function
    function removeLogo() {
      if (confirm('Are you sure you want to remove the custom logo and restore the default?')) {
        const defaultLogo = 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png';
        document.getElementById('company-logo').src = defaultLogo;
        document.getElementById('org-company-logo').src = defaultLogo;
        document.getElementById('jd-company-logo').src = defaultLogo;
        document.getElementById('admin-company-logo').src = defaultLogo;
        document.getElementById('login-logo').src = defaultLogo;
        localStorage.removeItem('companyLogo');
        alert('Logo removed successfully! Default logo restored.');
      }
    }

    // Icon Removal Function
    function removeIcon(iconType) {
      if (confirm(`Are you sure you want to remove the custom ${iconType} icon and restore the default?`)) {
        const defaultIcons = {
          'home': 'https://img.icons8.com/ios-filled/28/000000/home.png',
          'org': 'https://img.icons8.com/ios-filled/28/000000/organization.png',
          'jd': 'https://img.icons8.com/ios-filled/28/000000/resume.png',
          'logout': 'https://img.icons8.com/ios-filled/28/000000/logout-rounded.png'
        };
        
        const iconElement = document.getElementById(iconType + '-icon');
        iconElement.src = defaultIcons[iconType];
        // Restore filter for default icons when active
        iconElement.style.filter = '';
        localStorage.removeItem(iconType + 'Icon');
        alert(`${iconType.charAt(0).toUpperCase() + iconType.slice(1)} icon removed successfully! Default icon restored.`);
      }
    }

    // Org Chart Removal Function
    function removeOrgChart() {
      if (confirm('Are you sure you want to remove the current organizational chart and restore the default structure?')) {
        orgChartData = [
          { Level: 1, Position: 'Board of Directors', Parent: '', Color: 'gray', Id: 'board', ReportsTo: '', FunctionalReportsTo: '' },
          { Level: 2, Position: 'President and CEO', Parent: 'board', Color: 'gray', Id: 'ceo', ReportsTo: 'board', FunctionalReportsTo: '' },
          { Level: 2.5, Position: 'Internal Audit', Parent: 'board', Color: 'red', Id: 'internal-audit', ReportsTo: 'board', FunctionalReportsTo: 'ceo' },
          { Level: 2.5, Position: 'Corporate Governance', Parent: 'board', Color: 'red', Id: 'corp-governance', ReportsTo: 'board', FunctionalReportsTo: 'ceo' },
          { Level: 3, Position: 'PLDT COO', Parent: 'ceo', Color: 'green', Id: 'pldt-coo', ReportsTo: 'ceo', FunctionalReportsTo: '' },
          { Level: 3, Position: 'Smart COO', Parent: 'ceo', Color: 'orange', Id: 'smart-coo', ReportsTo: 'ceo', FunctionalReportsTo: '' },
          { Level: 3, Position: 'Technology Group', Parent: 'ceo', Color: 'purple', Id: 'technology', ReportsTo: 'ceo', FunctionalReportsTo: '' },
          { Level: 3, Position: 'People Group', Parent: 'ceo', Color: 'teal', Id: 'people', ReportsTo: 'ceo', FunctionalReportsTo: '' },
          { Level: 3, Position: 'Finance & Corporate Sustainability', Parent: 'ceo', Color: 'indigo', Id: 'finance', ReportsTo: 'ceo', FunctionalReportsTo: '' },
          { Level: 4, Position: 'Consumer Business', Parent: 'pldt-coo', Color: 'green', Id: 'consumer', ReportsTo: 'pldt-coo', FunctionalReportsTo: '' },
          { Level: 4, Position: 'Enterprise Business', Parent: 'pldt-coo', Color: 'green', Id: 'enterprise', ReportsTo: 'pldt-coo', FunctionalReportsTo: '' },
          { Level: 4, Position: 'Mobile Services', Parent: 'smart-coo', Color: 'orange', Id: 'mobile', ReportsTo: 'smart-coo', FunctionalReportsTo: '' },
          { Level: 4, Position: 'Network Operations', Parent: 'smart-coo', Color: 'orange', Id: 'network', ReportsTo: 'smart-coo', FunctionalReportsTo: '' },
          { Level: 4, Position: 'IT Operations', Parent: 'technology', Color: 'purple', Id: 'it-ops', ReportsTo: 'technology', FunctionalReportsTo: '' },
          { Level: 4, Position: 'Digital Innovation', Parent: 'technology', Color: 'purple', Id: 'digital', ReportsTo: 'technology', FunctionalReportsTo: '' }
        ];
        localStorage.removeItem('orgChartData');
        renderOrgChart();
        alert('Organizational chart removed successfully! Default structure restored.');
      }
    }

    // Structure Removal Functions
    function removeAllStructure() {
      if (confirm('Are you sure you want to remove all organizational structure data? This will reset all categories to default.')) {
        orgStructure = {
          'BUSINESS': {
            'Consumer Business Home': {
              'Regional Operations': ['Manager - Regional Operations', 'Senior Specialist - Customer Relations', 'Analyst - Market Research'],
              'Sales Division': ['Sales Manager', 'Senior Sales Representative', 'Sales Coordinator'],
              'Customer Service': ['Customer Service Manager', 'Senior Customer Service Representative', 'Technical Support Specialist']
            },
            'Consumer Business Wireless': {
              'Mobile Services': ['Manager - Mobile Services', 'Product Manager - Mobile Plans', 'Technical Specialist - Network'],
              'Retail Operations': ['Retail Manager', 'Store Supervisor', 'Sales Associate'],
              'Digital Marketing': ['Digital Marketing Manager', 'Social Media Specialist', 'Content Creator']
            },
            'Home Sales and Development': {
              'Product Development': ['Product Development Manager', 'Senior Product Analyst', 'UX/UI Designer'],
              'Market Research': ['Market Research Manager', 'Research Analyst', 'Data Scientist'],
              'Business Development': ['Business Development Manager', 'Partnership Specialist', 'Strategic Planner']
            },
            'Wireless Sales and Development': {
              'Sales Strategy': ['Sales Strategy Manager', 'Senior Sales Analyst', 'Territory Manager'],
              'Channel Management': ['Channel Manager', 'Partner Relations Specialist', 'Distribution Coordinator'],
              'Revenue Management': ['Revenue Manager', 'Pricing Analyst', 'Financial Analyst']
            },
            'Enterprise Business': {
              'Corporate Solutions': ['Enterprise Sales Manager', 'Solutions Architect', 'Account Manager'],
              'Government Relations': ['Government Relations Manager', 'Policy Analyst', 'Compliance Specialist'],
              'B2B Services': ['B2B Manager', 'Technical Consultant', 'Implementation Specialist']
            }
          },
          'TECHNOLOGY': {
            'Network Group': {
              'Infrastructure': ['Network Infrastructure Manager', 'Senior Network Engineer', 'Systems Administrator'],
              'Operations': ['Network Operations Manager', 'NOC Specialist', 'Field Technician'],
              'Planning': ['Network Planning Manager', 'RF Engineer', 'Capacity Planner']
            },
            'Information Technology': {
              'Software Development': ['IT Manager - Development', 'Senior Software Developer', 'DevOps Engineer'],
              'System Administration': ['Systems Manager', 'Database Administrator', 'Cloud Architect'],
              'IT Support': ['IT Support Manager', 'Help Desk Specialist', 'Technical Support']
            },
            'Cybersecurity': {
              'Security Operations': ['CISO', 'Security Analyst', 'Incident Response Specialist'],
              'Risk Management': ['Risk Manager', 'Compliance Officer', 'Security Auditor'],
              'Security Architecture': ['Security Architect', 'Penetration Tester', 'Security Consultant']
            }
          },
          'SUPPORT': {
            'Finance Group': {
              'Financial Planning': ['Finance Manager', 'Financial Analyst', 'Budget Specialist'],
              'Accounting': ['Accounting Manager', 'Senior Accountant', 'Accounts Payable Specialist'],
              'Treasury': ['Treasury Manager', 'Cash Management Specialist', 'Investment Analyst']
            },
            'People Group': {
              'Human Resources': ['HR Manager', 'HR Business Partner', 'Recruitment Specialist'],
              'Learning & Development': ['L&D Manager', 'Training Specialist', 'Organizational Development'],
              'Compensation & Benefits': ['C&B Manager', 'Compensation Analyst', 'Benefits Administrator']
            },
            'Supply Chain Management and Privacy Office': {
              'Procurement': ['Procurement Manager', 'Senior Buyer', 'Vendor Relations Specialist'],
              'Supply Chain': ['Supply Chain Manager', 'Logistics Coordinator', 'Inventory Analyst'],
              'Privacy Office': ['Privacy Officer', 'Data Protection Specialist', 'Compliance Analyst']
            },
            'Legal and Regulatory': {
              'Legal Affairs': ['Legal Manager', 'Corporate Lawyer', 'Contract Specialist'],
              'Regulatory Compliance': ['Regulatory Manager', 'Compliance Officer', 'Policy Analyst'],
              'Corporate Governance': ['Governance Manager', 'Board Secretary', 'Ethics Officer']
            }
          },
          'GOVERNANCE': {
            'Internal Audit': {
              'Audit Operations': ['Chief Audit Executive', 'Senior Auditor', 'Audit Specialist'],
              'Risk Assessment': ['Risk Assessment Manager', 'Internal Controls Specialist', 'Fraud Investigator'],
              'Compliance Monitoring': ['Compliance Manager', 'Monitoring Specialist', 'Audit Coordinator']
            },
            'Corporate Governance': {
              'Board Relations': ['Corporate Secretary', 'Board Relations Manager', 'Governance Specialist'],
              'Ethics & Compliance': ['Ethics Officer', 'Compliance Manager', 'Policy Developer'],
              'Stakeholder Relations': ['Stakeholder Relations Manager', 'Investor Relations Specialist', 'Communications Manager']
            }
          }
        };
        localStorage.removeItem('orgStructure');
        alert('All organizational structure removed successfully! Default structure restored.');
      }
    }

    function removeCategoryStructure(category, unit) {
      if (confirm(`Are you sure you want to remove the structure for "${unit}" in ${category}?`)) {
        if (orgStructure[category] && orgStructure[category][unit]) {
          delete orgStructure[category][unit];
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          alert(`Structure for "${unit}" removed successfully!`);
        }
      }
    }

    function removeAllJD() {
      if (confirm('Are you sure you want to remove all job descriptions? This cannot be undone.')) {
        jobDescriptions = {};
        localStorage.removeItem('jobDescriptions');
        alert('All job descriptions removed successfully!');
        // Refresh current view if in positions modal
        if (currentCategory && currentUnit && currentOrg) {
          viewPositions(currentCategory, currentUnit, currentOrg);
        }
      }
    }

    function removePositionJD() {
      if (currentCategory && currentUnit && currentOrg) {
        const positions = orgStructure[currentCategory][currentUnit][currentOrg];
        if (positions && positions.length > 0) {
          let positionsWithJD = positions.filter(pos => jobDescriptions[pos]);
          if (positionsWithJD.length === 0) {
            alert('No job descriptions found for positions in this organization unit.');
            return;
          }
          
          let positionList = positionsWithJD.map((pos, index) => `${index + 1}. ${pos}`).join('\n');
          let selection = prompt(`Select position to remove JD from:\n${positionList}\n\nEnter the number (1-${positionsWithJD.length}):`);
          
          if (selection && !isNaN(selection)) {
            let index = parseInt(selection) - 1;
            if (index >= 0 && index < positionsWithJD.length) {
              let selectedPosition = positionsWithJD[index];
              if (confirm(`Remove job description for "${selectedPosition}"?`)) {
                delete jobDescriptions[selectedPosition];
                localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
                alert(`Job description for "${selectedPosition}" removed successfully!`);
                viewPositions(currentCategory, currentUnit, currentOrg);
              }
            } else {
              alert('Invalid selection.');
            }
          }
        }
      }
    }

    // Edit Mode Functions
    let editMode = false;

    function toggleEditMode() {
      editMode = !editMode;
      const btn = document.getElementById('edit-mode-btn');
      
      if (editMode) {
        btn.textContent = 'ğŸ’¾ Save Changes';
        btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
        enableEditMode();
      } else {
        btn.textContent = 'âœï¸ Edit Mode';
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        disableEditMode();
        alert('Changes saved successfully!');
      }
    }

    function enableEditMode() {
      // Make org chart nodes editable
      const orgNodes = document.querySelectorAll('.org-node');
      orgNodes.forEach(node => {
        node.contentEditable = true;
        node.style.border = '2px dashed #3b82f6';
        node.title = 'Click to edit this position';
      });

      // Make job description items editable
      const jdItems = document.querySelectorAll('#jd .bg-gray-100');
      jdItems.forEach(item => {
        item.contentEditable = true;
        item.style.border = '2px dashed #3b82f6';
        item.title = 'Click to edit this job title';
      });
    }

    function disableEditMode() {
      // Disable editing for org chart nodes
      const orgNodes = document.querySelectorAll('.org-node');
      orgNodes.forEach(node => {
        node.contentEditable = false;
        node.style.border = 'none';
        node.title = '';
      });

      // Disable editing for job description items
      const jdItems = document.querySelectorAll('#jd .bg-gray-100');
      jdItems.forEach(item => {
        item.contentEditable = false;
        item.style.border = 'none';
        item.title = '';
      });
    }

    // Individual JD Upload Functions
    function uploadIndividualJD(event, position) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        jobDescriptions[position] = `<div class="whitespace-pre-wrap">${e.target.result}</div>`;
        localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
        alert(`Job description for "${position}" uploaded successfully!`);
        
        // Refresh the positions view to show updated status
        if (currentCategory && currentUnit && currentOrg) {
          viewPositions(currentCategory, currentUnit, currentOrg);
        }
      };
      reader.readAsText(file);
      
      // Reset file input
      event.target.value = '';
    }

    function removeIndividualJD(position) {
      if (confirm(`Remove job description for "${position}"?`)) {
        delete jobDescriptions[position];
        localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
        alert(`Job description for "${position}" removed successfully!`);
        
        // Refresh the positions view to show updated status
        if (currentCategory && currentUnit && currentOrg) {
          viewPositions(currentCategory, currentUnit, currentOrg);
        }
      }
    }

    // Smart matching function for bulk uploads
    function findBestPositionMatch(fileName, positions) {
      // Clean filename for matching
      const cleanFileName = fileName.toLowerCase()
        .replace(/[_-]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();

      // Try exact match first
      let exactMatch = positions.find(pos => 
        pos.toLowerCase() === cleanFileName
      );
      if (exactMatch) return exactMatch;

      // Try partial matches
      let partialMatches = positions.filter(pos => {
        const cleanPos = pos.toLowerCase();
        const fileWords = cleanFileName.split(' ');
        const posWords = cleanPos.split(' ');
        
        // Check if most words match
        let matchCount = 0;
        fileWords.forEach(word => {
          if (word.length > 2 && posWords.some(posWord => posWord.includes(word) || word.includes(posWord))) {
            matchCount++;
          }
        });
        
        return matchCount >= Math.min(fileWords.length * 0.6, posWords.length * 0.6);
      });

      // Return best partial match
      if (partialMatches.length === 1) {
        return partialMatches[0];
      } else if (partialMatches.length > 1) {
        // Return the one with most similar length
        return partialMatches.reduce((best, current) => 
          Math.abs(current.length - cleanFileName.length) < Math.abs(best.length - cleanFileName.length) 
            ? current : best
        );
      }

      return null;
    }

    // Load saved data and session on page load
    window.addEventListener('load', function() {
      // Load session first
      loadSession();
      
      const savedLogo = localStorage.getItem('companyLogo');
      if (savedLogo) {
        document.getElementById('company-logo').src = savedLogo;
        document.getElementById('org-company-logo').src = savedLogo;
        document.getElementById('jd-company-logo').src = savedLogo;
        document.getElementById('admin-company-logo').src = savedLogo;
        document.getElementById('login-logo').src = savedLogo;
      }

      // Load saved icons
      const iconTypes = ['home', 'org', 'jd', 'logout'];
      iconTypes.forEach(iconType => {
        const savedIcon = localStorage.getItem(iconType + 'Icon');
        if (savedIcon) {
          const iconElement = document.getElementById(iconType + '-icon');
          iconElement.src = savedIcon;
          // Remove filter to show custom icon properly
          iconElement.style.filter = 'none';
        }
      });

      // Load saved job descriptions
      const savedJD = localStorage.getItem('jobDescriptions');
      if (savedJD) {
        try {
          jobDescriptions = JSON.parse(savedJD);
        } catch (error) {
          console.log('Error loading saved job descriptions');
        }
      }

      // Load saved org chart data
      const savedOrgChart = localStorage.getItem('orgChartData');
      if (savedOrgChart) {
        try {
          orgChartData = JSON.parse(savedOrgChart);
        } catch (error) {
          console.log('Error loading saved org chart data');
        }
      }

      // Load saved organization structure
      const savedOrgStructure = localStorage.getItem('orgStructure');
      if (savedOrgStructure) {
        try {
          orgStructure = JSON.parse(savedOrgStructure);
        } catch (error) {
          console.log('Error loading saved organization structure');
        }
      }

      // Load saved organizational functions
      const savedOrgFunctions = localStorage.getItem('orgFunctions');
      if (savedOrgFunctions) {
        try {
          orgFunctions = JSON.parse(savedOrgFunctions);
        } catch (error) {
          console.log('Error loading saved organizational functions');
        }
      }

      // Load saved category colors
      const savedCategoryColors = localStorage.getItem('categoryColors');
      if (savedCategoryColors) {
        try {
          categoryColors = JSON.parse(savedCategoryColors);
        } catch (error) {
          console.log('Error loading saved category colors');
        }
      }

      // Load saved user management data
      const savedLevel1Password = localStorage.getItem('level1Password');
      if (savedLevel1Password) {
        userManagement.level1Password = savedLevel1Password;
      }
      
      const savedLevel2Password = localStorage.getItem('level2Password');
      if (savedLevel2Password) {
        userManagement.level2Password = savedLevel2Password;
      }

      // Initial render of categories
      renderCategories();
    });



    // Show functions in popup
    function showOrgFunctions(node) {
      const unitFunctions = orgFunctions[node.Id] || orgFunctions[node.Position];
      
      let content = `<h3 class="text-lg font-bold text-blue-900 mb-4">${node.Position} - Functions & AO</h3>`;
      
      if (!unitFunctions) {
        content += `
          <div class="text-center text-gray-500 py-8">
            <div class="text-4xl mb-2">ğŸ“‹</div>
            <p class="mb-2">No functions/AO data available</p>
            <p class="text-sm">Upload functions file to populate this data</p>
          </div>
        `;
      } else {
        // Core Functions
        if (unitFunctions.functions && unitFunctions.functions.length > 0) {
          content += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                <span class="text-blue-600 mr-2">ğŸ¯</span>
                Core Functions
              </h4>
              <div class="space-y-1">
          `;
          unitFunctions.functions.forEach(func => {
            content += `<div class="bg-blue-50 p-2 rounded text-sm">${func}</div>`;
          });
          content += '</div></div>';
        }

        // Administrative Orders
        if (unitFunctions.administrativeOrders && unitFunctions.administrativeOrders.length > 0) {
          content += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                <span class="text-green-600 mr-2">ğŸ“œ</span>
                Administrative Orders
              </h4>
              <div class="space-y-1">
          `;
          unitFunctions.administrativeOrders.forEach(ao => {
            content += `
              <div class="bg-green-50 p-2 rounded text-sm">
                <div class="font-medium">${ao.number || 'AO Number'}</div>
                <div class="text-gray-700">${ao.title || ao.description || 'Administrative Order'}</div>
                ${ao.date ? `<div class="text-xs text-gray-500">Date: ${ao.date}</div>` : ''}
              </div>
            `;
          });
          content += '</div></div>';
        }

        // Key Responsibilities
        if (unitFunctions.responsibilities && unitFunctions.responsibilities.length > 0) {
          content += `
            <div class="mb-4">
              <h4 class="font-semibold text-gray-900 mb-2 flex items-center">
                <span class="text-purple-600 mr-2">âœ…</span>
                Key Responsibilities
              </h4>
              <div class="space-y-1">
          `;
          unitFunctions.responsibilities.forEach(resp => {
            content += `<div class="bg-purple-50 p-2 rounded text-sm">${resp}</div>`;
          });
          content += '</div></div>';
        }
      }
      
      // Create and show popup
      const popup = document.createElement('div');
      popup.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      popup.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-2xl max-h-[70vh] overflow-y-auto m-4 w-full">
          <div class="flex justify-between items-center mb-4">
            <div></div>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
          </div>
          ${content}
        </div>
      `;
      
      // Close on background click
      popup.onclick = (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      };
      
      document.body.appendChild(popup);
    }

    // Org Unit Selection for Functions
    function selectOrgUnit(node) {
      // Clear previous selection
      clearOrgSelection();
      
      // Highlight selected node
      const nodeElement = document.getElementById(`node-${node.Id}`);
      nodeElement.style.border = '3px solid #f59e0b';
      nodeElement.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.5)';
      
      selectedOrgUnit = node;
      
      // Update info panel
      document.getElementById('selected-unit-name').textContent = node.Position;
      document.getElementById('selected-unit-info').classList.remove('hidden');
      
      // Load and display functions
      displayOrgFunctions(node);
    }

    function clearOrgSelection() {
      if (selectedOrgUnit) {
        const nodeElement = document.getElementById(`node-${selectedOrgUnit.Id}`);
        if (nodeElement) {
          nodeElement.style.border = '';
          nodeElement.style.boxShadow = '';
        }
      }
      selectedOrgUnit = null;
      document.getElementById('selected-unit-info').classList.add('hidden');
    }

    function displayOrgFunctions(node) {
      const functionsContent = document.getElementById('functions-content');
      const unitFunctions = orgFunctions[node.Id] || orgFunctions[node.Position];
      
      if (!unitFunctions) {
        functionsContent.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <div class="text-4xl mb-2">ğŸ“‹</div>
            <p class="mb-2">No functions/AO data available for</p>
            <p class="font-semibold">${node.Position}</p>
            <p class="text-sm mt-2">Upload functions file to populate this data</p>
          </div>
        `;
        return;
      }

      let html = '';
      
      // Core Functions
      if (unitFunctions.functions && unitFunctions.functions.length > 0) {
        html += `
          <div class="mb-6">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <span class="text-blue-600 mr-2">ğŸ¯</span>
              Core Functions
            </h4>
            <div class="space-y-2">
        `;
        unitFunctions.functions.forEach(func => {
          html += `
            <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-400">
              <p class="text-sm text-gray-800">${func}</p>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // Administrative Orders
      if (unitFunctions.administrativeOrders && unitFunctions.administrativeOrders.length > 0) {
        html += `
          <div class="mb-6">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <span class="text-green-600 mr-2">ğŸ“œ</span>
              Administrative Orders
            </h4>
            <div class="space-y-2">
        `;
        unitFunctions.administrativeOrders.forEach(ao => {
          html += `
            <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-400">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="font-medium text-sm text-gray-900">${ao.number || 'AO Number'}</p>
                  <p class="text-sm text-gray-700 mt-1">${ao.title || ao.description || 'Administrative Order'}</p>
                  ${ao.date ? `<p class="text-xs text-gray-500 mt-1">Date: ${ao.date}</p>` : ''}
                </div>
                ${ao.status ? `<span class="text-xs px-2 py-1 rounded ${ao.status === 'Active' ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}">${ao.status}</span>` : ''}
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // Key Responsibilities
      if (unitFunctions.responsibilities && unitFunctions.responsibilities.length > 0) {
        html += `
          <div class="mb-6">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <span class="text-purple-600 mr-2">âœ…</span>
              Key Responsibilities
            </h4>
            <div class="space-y-2">
        `;
        unitFunctions.responsibilities.forEach(resp => {
          html += `
            <div class="bg-purple-50 p-3 rounded-lg border-l-4 border-purple-400">
              <p class="text-sm text-gray-800">${resp}</p>
            </div>
          `;
        });
        html += '</div></div>';
      }

      // Reporting Structure
      if (unitFunctions.reporting) {
        html += `
          <div class="mb-6">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <span class="text-orange-600 mr-2">ğŸ¢</span>
              Reporting Structure
            </h4>
            <div class="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-400">
              ${unitFunctions.reporting.reportsTo ? `<p class="text-sm text-gray-800 mb-2"><strong>Reports To:</strong> ${unitFunctions.reporting.reportsTo}</p>` : ''}
              ${unitFunctions.reporting.manages && unitFunctions.reporting.manages.length > 0 ? `
                <p class="text-sm text-gray-800 mb-1"><strong>Manages:</strong></p>
                <ul class="text-sm text-gray-700 ml-4 list-disc">
                  ${unitFunctions.reporting.manages.map(unit => `<li>${unit}</li>`).join('')}
                </ul>
              ` : ''}
            </div>
          </div>
        `;
      }

      if (html === '') {
        html = `
          <div class="text-center text-gray-500 py-8">
            <div class="text-4xl mb-2">ğŸ“‹</div>
            <p>No detailed function data available for ${node.Position}</p>
          </div>
        `;
      }

      functionsContent.innerHTML = html;
    }

    // Functions Upload
    function uploadFunctions(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // Process and update functions data
          updateOrgFunctions(jsonData);
          alert('Organizational functions updated successfully!');
        } catch (error) {
          alert('Error reading Excel file. Please check the format.');
        }
      };
      reader.readAsArrayBuffer(file);
      
      // Reset file input
      event.target.value = '';
    }

    function updateOrgFunctions(data) {
      orgFunctions = {};
      
      data.forEach(row => {
        const unitId = row.UnitId || row['Unit ID'];
        const unitName = row.UnitName || row['Unit Name'] || row.Position;
        const functionType = row.Type || row.FunctionType || 'function';
        const description = row.Description || row.Function || row.Content;
        const aoNumber = row.AONumber || row['AO Number'];
        const aoTitle = row.AOTitle || row['AO Title'];
        const aoDate = row.AODate || row['AO Date'];
        const aoStatus = row.AOStatus || row['AO Status'] || 'Active';
        const reportsTo = row.ReportsTo || row['Reports To'];
        const manages = row.Manages || row['Manages'];

        const key = unitId || unitName;
        if (!key) return;

        if (!orgFunctions[key]) {
          orgFunctions[key] = {
            functions: [],
            administrativeOrders: [],
            responsibilities: [],
            reporting: {}
          };
        }

        if (functionType.toLowerCase() === 'function' && description) {
          orgFunctions[key].functions.push(description);
        } else if (functionType.toLowerCase() === 'ao' || functionType.toLowerCase() === 'administrative_order') {
          orgFunctions[key].administrativeOrders.push({
            number: aoNumber,
            title: aoTitle,
            description: description,
            date: aoDate,
            status: aoStatus
          });
        } else if (functionType.toLowerCase() === 'responsibility' && description) {
          orgFunctions[key].responsibilities.push(description);
        } else if (functionType.toLowerCase() === 'reporting') {
          if (reportsTo) orgFunctions[key].reporting.reportsTo = reportsTo;
          if (manages) {
            orgFunctions[key].reporting.manages = manages.split(',').map(s => s.trim());
          }
        }
      });

      // Save to localStorage
      localStorage.setItem('orgFunctions', JSON.stringify(orgFunctions));
    }

    function downloadFunctionsTemplate() {
      const templateData = [
        { UnitId: 'ceo', UnitName: 'President and CEO', Type: 'function', Description: 'Provide strategic leadership and direction for the organization' },
        { UnitId: 'ceo', UnitName: 'President and CEO', Type: 'function', Description: 'Oversee all business operations and ensure organizational goals are met' },
        { UnitId: 'ceo', UnitName: 'President and CEO', Type: 'responsibility', Description: 'Report to Board of Directors on company performance' },
        { UnitId: 'ceo', UnitName: 'President and CEO', Type: 'responsibility', Description: 'Ensure compliance with regulatory requirements' },
        { UnitId: 'ceo', UnitName: 'President and CEO', Type: 'ao', AONumber: 'AO-2024-001', AOTitle: 'Organizational Restructuring', Description: 'Implementation of new organizational structure', AODate: '2024-01-15', AOStatus: 'Active' },
        { UnitId: 'ceo', UnitName: 'President and CEO', Type: 'reporting', ReportsTo: 'Board of Directors', Manages: 'PLDT COO, Smart COO, Technology Group, People Group, Finance Group' },
        { UnitId: 'technology', UnitName: 'Technology Group', Type: 'function', Description: 'Manage all technology infrastructure and systems' },
        { UnitId: 'technology', UnitName: 'Technology Group', Type: 'function', Description: 'Drive digital transformation initiatives' },
        { UnitId: 'technology', UnitName: 'Technology Group', Type: 'ao', AONumber: 'AO-2024-002', AOTitle: 'IT Security Enhancement', Description: 'Strengthening cybersecurity measures', AODate: '2024-02-01', AOStatus: 'Active' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Functions Template');
      XLSX.writeFile(wb, 'PLDT_OrgFunctions_Template.xlsx');
    }

    // Category Management Functions
    function renderCategories() {
      const container = document.getElementById('categories-container');
      container.innerHTML = '';
      
      Object.keys(orgStructure).forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'space-y-4';
        
        const color = categoryColors[category] || 'blue';
        const colorClass = `bg-${color}-900`;
        
        categoryDiv.innerHTML = `
          <div class="${colorClass} text-white p-4 rounded-lg text-center relative">
            <h3 class="font-bold text-lg">${category}</h3>

          </div>
          <div class="space-y-2">
            ${Object.keys(orgStructure[category]).map(unit => `
              <div class="bg-gray-100 p-3 rounded hover:bg-gray-200 relative group">
                <div class="cursor-pointer" onclick="viewOrgUnits('${category}', '${unit}')">${unit}</div>

              </div>
            `).join('')}
          </div>
        `;
        
        container.appendChild(categoryDiv);
      });
    }

    function openCategoryManager() {
      document.getElementById('category-manager-modal').classList.remove('hidden');
      loadCategoryManager();
    }

    function closeCategoryManager() {
      document.getElementById('category-manager-modal').classList.add('hidden');
    }

    function loadCategoryManager() {
      // Populate all category select dropdowns
      const categorySelects = ['unit-category-select', 'position-category-select'];
      categorySelects.forEach(selectId => {
        const categorySelect = document.getElementById(selectId);
        categorySelect.innerHTML = '';
        Object.keys(orgStructure).forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      });

      // Initialize parent options and structure tree
      updateParentOptions();
      refreshStructureTree();
    }

    // Update parent unit options based on selected category
    function updateParentOptions() {
      const categorySelect = document.getElementById('unit-category-select');
      const parentSelect = document.getElementById('parent-unit-select');
      const selectedCategory = categorySelect.value;
      
      parentSelect.innerHTML = '<option value="">-- Top Level Unit --</option>';
      
      if (selectedCategory && orgStructure[selectedCategory]) {
        // Get all units in the selected category for parent options
        const allUnits = getAllUnitsInCategory(selectedCategory);
        allUnits.forEach(unitPath => {
          const option = document.createElement('option');
          option.value = JSON.stringify(unitPath);
          option.textContent = unitPath.join(' > ') + ` (Level ${unitPath.length})`;
          parentSelect.appendChild(option);
        });
      }
    }

    // Update unit options for position assignment
    function updateUnitOptionsForPosition() {
      const categorySelect = document.getElementById('position-category-select');
      const unitSelect = document.getElementById('position-unit-select');
      const selectedCategory = categorySelect.value;
      
      unitSelect.innerHTML = '<option value="">-- Select Unit First --</option>';
      
      if (selectedCategory && orgStructure[selectedCategory]) {
        const allUnits = getAllUnitsInCategory(selectedCategory);
        allUnits.forEach(unitPath => {
          const option = document.createElement('option');
          option.value = JSON.stringify(unitPath);
          option.textContent = unitPath.join(' > ') + ` (Level ${unitPath.length})`;
          unitSelect.appendChild(option);
        });
      }
    }

    // Get all units and sub-units in a category as paths
    function getAllUnitsInCategory(category) {
      const units = [];
      
      function traverseUnits(data, currentPath = []) {
        if (typeof data === 'object' && !Array.isArray(data)) {
          Object.keys(data).forEach(key => {
            if (key !== '_positions') {
              const newPath = [...currentPath, key];
              units.push(newPath);
              traverseUnits(data[key], newPath);
            }
          });
        }
      }
      
      if (orgStructure[category]) {
        traverseUnits(orgStructure[category]);
      }
      
      return units;
    }

    // Add unit or sub-unit with proper hierarchy
    function addUnitOrSubUnit(event) {
      event.preventDefault();
      
      const category = document.getElementById('unit-category-select').value;
      const unitName = document.getElementById('new-unit-name').value.trim();
      const parentPath = document.getElementById('parent-unit-select').value;
      const level = parseInt(document.getElementById('unit-level-select').value);
      
      if (!category || !unitName) {
        alert('Please fill in all required fields.');
        return;
      }
      
      // Initialize category if it doesn't exist
      if (!orgStructure[category]) {
        orgStructure[category] = {};
      }
      
      let targetPath = [];
      
      if (parentPath) {
        // Adding as sub-unit
        try {
          targetPath = JSON.parse(parentPath);
        } catch (e) {
          alert('Invalid parent selection.');
          return;
        }
      }
      
      // Add the new unit name to the path
      const fullPath = [...targetPath, unitName];
      
      // Check if unit already exists
      if (getNestedStructure(category, null, fullPath)) {
        alert('Unit already exists at this location!');
        return;
      }
      
      // Create the unit structure
      if (targetPath.length === 0) {
        // Top level unit
        orgStructure[category][unitName] = {};
      } else {
        // Sub-unit - need to navigate to parent and add
        let current = orgStructure[category];
        
        // Navigate to parent
        for (let i = 0; i < targetPath.length; i++) {
          if (!current[targetPath[i]]) {
            current[targetPath[i]] = {};
          }
          current = current[targetPath[i]];
        }
        
        // Add new unit
        current[unitName] = {};
      }
      
      // Save to localStorage
      localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
      
      // Reset form
      document.getElementById('new-unit-name').value = '';
      document.getElementById('parent-unit-select').value = '';
      document.getElementById('unit-level-select').value = '1';
      
      // Refresh displays
      updateParentOptions();
      refreshStructureTree();
      renderCategories();
      
      alert(`Unit "${unitName}" added successfully at Level ${fullPath.length}!`);
    }

    // Add position to selected unit
    function addPositionToUnit(event) {
      event.preventDefault();
      
      const category = document.getElementById('position-category-select').value;
      const unitPath = document.getElementById('position-unit-select').value;
      const positionName = document.getElementById('new-position-name').value.trim();
      
      if (!category || !unitPath || !positionName) {
        alert('Please fill in all required fields.');
        return;
      }
      
      let path;
      try {
        path = JSON.parse(unitPath);
      } catch (e) {
        alert('Invalid unit selection.');
        return;
      }
      
      // Get current unit data
      const currentData = getNestedStructure(category, null, path);
      
      if (!currentData) {
        alert('Selected unit not found.');
        return;
      }
      
      // Add position to the unit
      if (typeof currentData === 'object' && !Array.isArray(currentData)) {
        // Unit has sub-units, add to _positions
        if (!currentData['_positions']) {
          currentData['_positions'] = [];
        }
        if (!currentData['_positions'].includes(positionName)) {
          currentData['_positions'].push(positionName);
        } else {
          alert('Position already exists in this unit!');
          return;
        }
      } else if (Array.isArray(currentData)) {
        // Unit has direct positions
        if (!currentData.includes(positionName)) {
          currentData.push(positionName);
        } else {
          alert('Position already exists in this unit!');
          return;
        }
      } else {
        // Initialize as positions array
        setNestedStructure(category, null, path, [positionName]);
      }
      
      // Save to localStorage
      localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
      
      // Reset form
      document.getElementById('new-position-name').value = '';
      document.getElementById('position-unit-select').value = '';
      
      // Refresh displays
      refreshStructureTree();
      
      alert(`Position "${positionName}" added successfully to ${path.join(' > ')}!`);
    }

    // Refresh the structure tree display
    function refreshStructureTree() {
      const treeContainer = document.getElementById('structure-tree');
      treeContainer.innerHTML = '';
      
      Object.keys(orgStructure).forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'mb-4';
        
        const color = categoryColors[category] || 'blue';
        
        categoryDiv.innerHTML = `
          <div class="flex items-center justify-between p-3 bg-${color}-100 rounded-lg mb-2">
            <div class="flex items-center">
              <button onclick="toggleCategoryTree('${category}')" class="mr-2 text-${color}-600 hover:text-${color}-800">
                <span id="toggle-${category}">ğŸ“</span>
              </button>
              <h5 class="font-bold text-${color}-900">${category}</h5>
              <span class="ml-2 text-xs bg-${color}-200 text-${color}-800 px-2 py-1 rounded">
                ${Object.keys(orgStructure[category]).length} units
              </span>
            </div>
            <button onclick="removeCategory('${category}')" class="text-red-600 hover:text-red-800 text-sm" title="Remove Category">
              ğŸ—‘ï¸
            </button>
          </div>
          <div id="category-tree-${category}" class="ml-4 hidden">
            ${generateCategoryTree(category, orgStructure[category], [])}
          </div>
        `;
        
        treeContainer.appendChild(categoryDiv);
      });
    }

    // Generate tree structure for a category
    function generateCategoryTree(category, data, currentPath) {
      let html = '';
      
      if (typeof data === 'object' && !Array.isArray(data)) {
        Object.keys(data).forEach(key => {
          if (key === '_positions') {
            // Show direct positions
            if (data[key].length > 0) {
              html += `
                <div class="ml-4 mb-2">
                  <div class="flex items-center text-purple-700">
                    <span class="mr-2">ğŸ‘¥</span>
                    <span class="text-sm font-medium">Direct Positions (${data[key].length})</span>
                  </div>
                  <div class="ml-6 text-xs text-gray-600">
                    ${data[key].slice(0, 3).join(', ')}${data[key].length > 3 ? '...' : ''}
                  </div>
                </div>
              `;
            }
          } else {
            const newPath = [...currentPath, key];
            const hasSubUnits = typeof data[key] === 'object' && !Array.isArray(data[key]) && 
                              Object.keys(data[key]).some(k => k !== '_positions');
            const positionCount = countNestedPositions(data[key]);
            
            html += `
              <div class="mb-2">
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded border-l-4 border-blue-400">
                  <div class="flex items-center">
                    <button onclick="toggleUnitTree('${category}', '${JSON.stringify(newPath).replace(/"/g, '&quot;')}')" class="mr-2 text-blue-600 hover:text-blue-800">
                      <span id="toggle-unit-${category}-${newPath.join('-')}">${hasSubUnits ? 'ğŸ“' : 'ğŸ“„'}</span>
                    </button>
                    <span class="font-medium text-gray-900">${key}</span>
                    <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                      Level ${newPath.length} â€¢ ${positionCount} positions
                    </span>
                  </div>
                  <div class="flex space-x-1">
                    <button onclick="editUnit('${category}', '${JSON.stringify(newPath).replace(/"/g, '&quot;')}')" 
                            class="text-blue-600 hover:text-blue-800 text-xs" title="Edit Unit">
                      âœï¸
                    </button>
                    <button onclick="removeUnit('${category}', '${JSON.stringify(newPath).replace(/"/g, '&quot;')}')" 
                            class="text-red-600 hover:text-red-800 text-xs" title="Remove Unit">
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </div>
                <div id="unit-tree-${category}-${newPath.join('-')}" class="ml-4 hidden">
                  ${generateCategoryTree(category, data[key], newPath)}
                </div>
              </div>
            `;
          }
        });
      } else if (Array.isArray(data)) {
        // Direct positions
        html += `
          <div class="ml-4 mb-2">
            <div class="flex items-center text-green-700">
              <span class="mr-2">ğŸ‘¥</span>
              <span class="text-sm font-medium">Positions (${data.length})</span>
            </div>
            <div class="ml-6 text-xs text-gray-600">
              ${data.slice(0, 3).join(', ')}${data.length > 3 ? '...' : ''}
            </div>
          </div>
        `;
      }
      
      return html;
    }

    // Toggle category tree visibility
    function toggleCategoryTree(category) {
      const treeDiv = document.getElementById(`category-tree-${category}`);
      const toggleIcon = document.getElementById(`toggle-${category}`);
      
      if (treeDiv.classList.contains('hidden')) {
        treeDiv.classList.remove('hidden');
        toggleIcon.textContent = 'ğŸ“‚';
      } else {
        treeDiv.classList.add('hidden');
        toggleIcon.textContent = 'ğŸ“';
      }
    }

    // Toggle unit tree visibility
    function toggleUnitTree(category, pathJson) {
      const path = JSON.parse(pathJson);
      const treeDiv = document.getElementById(`unit-tree-${category}-${path.join('-')}`);
      const toggleIcon = document.getElementById(`toggle-unit-${category}-${path.join('-')}`);
      
      if (treeDiv && treeDiv.classList.contains('hidden')) {
        treeDiv.classList.remove('hidden');
        toggleIcon.textContent = 'ğŸ“‚';
      } else if (treeDiv) {
        treeDiv.classList.add('hidden');
        toggleIcon.textContent = 'ğŸ“';
      }
    }

    // Expand all structure
    function expandAllStructure() {
      document.querySelectorAll('[id^="category-tree-"], [id^="unit-tree-"]').forEach(el => {
        el.classList.remove('hidden');
      });
      document.querySelectorAll('[id^="toggle-"]').forEach(el => {
        if (el.textContent === 'ğŸ“' || el.textContent === 'ğŸ“„') {
          el.textContent = 'ğŸ“‚';
        }
      });
    }

    // Collapse all structure
    function collapseAllStructure() {
      document.querySelectorAll('[id^="category-tree-"], [id^="unit-tree-"]').forEach(el => {
        el.classList.add('hidden');
      });
      document.querySelectorAll('[id^="toggle-"]').forEach(el => {
        if (el.textContent === 'ğŸ“‚') {
          el.textContent = el.id.includes('category') ? 'ğŸ“' : 'ğŸ“„';
        }
      });
    }

    // Edit unit name
    function editUnit(category, pathJson) {
      const path = JSON.parse(pathJson);
      const currentName = path[path.length - 1];
      const newName = prompt(`Edit unit name:`, currentName);
      
      if (newName && newName.trim() && newName.trim() !== currentName) {
        const trimmedName = newName.trim();
        
        // Get parent path
        const parentPath = path.slice(0, -1);
        
        // Get current unit data
        const unitData = getNestedStructure(category, null, path);
        
        if (unitData) {
          // Remove old unit
          removeUnitFromStructure(category, path);
          
          // Add with new name
          const newPath = [...parentPath, trimmedName];
          setNestedStructure(category, null, newPath, unitData);
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          
          // Refresh displays
          refreshStructureTree();
          renderCategories();
          
          alert(`Unit renamed from "${currentName}" to "${trimmedName}" successfully!`);
        }
      }
    }

    // Remove unit from structure
    function removeUnit(category, pathJson) {
      const path = JSON.parse(pathJson);
      const unitName = path[path.length - 1];
      
      if (confirm(`Are you sure you want to remove "${unitName}" and all its sub-units and positions?`)) {
        removeUnitFromStructure(category, path);
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        
        // Refresh displays
        refreshStructureTree();
        renderCategories();
        updateParentOptions();
        
        alert(`Unit "${unitName}" removed successfully!`);
      }
    }

    // Helper function to remove unit from structure
    function removeUnitFromStructure(category, path) {
      if (path.length === 1) {
        // Top level unit
        delete orgStructure[category][path[0]];
      } else {
        // Nested unit
        const parentPath = path.slice(0, -1);
        const parentData = getNestedStructure(category, null, parentPath);
        if (parentData && typeof parentData === 'object') {
          delete parentData[path[path.length - 1]];
        }
      }
    }

    // Download complete template
    function downloadCompleteTemplate() {
      const templateData = [
        { Category: 'BUSINESS', Color: 'blue', Level: 1, Unit: 'Consumer Business Home', ParentUnit: '', Position: '' },
        { Category: 'BUSINESS', Color: 'blue', Level: 2, Unit: 'Regional Operations', ParentUnit: 'Consumer Business Home', Position: '' },
        { Category: 'BUSINESS', Color: 'blue', Level: 2, Unit: 'Sales Division', ParentUnit: 'Consumer Business Home', Position: '' },
        { Category: 'BUSINESS', Color: 'blue', Level: 3, Unit: 'Field Sales', ParentUnit: 'Regional Operations > Sales Division', Position: '' },
        { Category: 'BUSINESS', Color: 'blue', Level: 0, Unit: 'Regional Operations', ParentUnit: '', Position: 'Manager - Regional Operations' },
        { Category: 'BUSINESS', Color: 'blue', Level: 0, Unit: 'Regional Operations', ParentUnit: '', Position: 'Senior Specialist - Customer Relations' },
        { Category: 'BUSINESS', Color: 'blue', Level: 0, Unit: 'Sales Division', ParentUnit: '', Position: 'Sales Manager' },
        { Category: 'TECHNOLOGY', Color: 'purple', Level: 1, Unit: 'Network Group', ParentUnit: '', Position: '' },
        { Category: 'TECHNOLOGY', Color: 'purple', Level: 2, Unit: 'Infrastructure', ParentUnit: 'Network Group', Position: '' },
        { Category: 'TECHNOLOGY', Color: 'purple', Level: 0, Unit: 'Infrastructure', ParentUnit: '', Position: 'Network Infrastructure Manager' },
        { Category: 'SUPPORT', Color: 'green', Level: 1, Unit: 'Finance Group', ParentUnit: '', Position: '' },
        { Category: 'SUPPORT', Color: 'green', Level: 0, Unit: 'Finance Group', ParentUnit: '', Position: 'Finance Manager' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Complete Structure Template');
      XLSX.writeFile(wb, 'PLDT_Complete_Structure_Template.xlsx');
    }

    // Export complete structure
    function exportCompleteStructure() {
      if (currentUser !== 'admin') {
        alert('Export functionality is only available for administrators.');
        return;
      }
      
      const exportData = [];
      
      Object.keys(orgStructure).forEach(category => {
        const color = categoryColors[category] || 'blue';
        
        // Export structure recursively
        function exportStructureRecursive(data, currentPath = [], level = 1) {
          if (typeof data === 'object' && !Array.isArray(data)) {
            Object.keys(data).forEach(key => {
              if (key === '_positions') {
                // Export direct positions
                data[key].forEach(position => {
                  exportData.push({
                    Category: category,
                    Color: color,
                    Level: 0, // 0 indicates position
                    Unit: currentPath.join(' > '),
                    ParentUnit: currentPath.slice(0, -1).join(' > '),
                    Position: position
                  });
                });
              } else {
                const newPath = [...currentPath, key];
                // Export unit
                exportData.push({
                  Category: category,
                  Color: color,
                  Level: level,
                  Unit: key,
                  ParentUnit: currentPath.join(' > '),
                  Position: ''
                });
                // Recurse into sub-units
                exportStructureRecursive(data[key], newPath, level + 1);
              }
            });
          } else if (Array.isArray(data)) {
            // Export positions
            data.forEach(position => {
              exportData.push({
                Category: category,
                Color: color,
                Level: 0, // 0 indicates position
                Unit: currentPath.join(' > '),
                ParentUnit: currentPath.slice(0, -1).join(' > '),
                Position: position
              });
            });
          }
        }
        
        exportStructureRecursive(orgStructure[category]);
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Complete Structure');
      XLSX.writeFile(wb, `PLDT_Complete_Structure_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      alert('Complete structure exported successfully!');
    }

    // Validate structure integrity
    function validateStructureIntegrity() {
      const issues = [];
      let totalUnits = 0;
      let totalPositions = 0;
      
      Object.keys(orgStructure).forEach(category => {
        if (!categoryColors[category]) {
          issues.push(`Category "${category}" has no color assigned`);
        }
        
        function validateRecursive(data, path = []) {
          if (typeof data === 'object' && !Array.isArray(data)) {
            Object.keys(data).forEach(key => {
              if (key === '_positions') {
                if (Array.isArray(data[key])) {
                  totalPositions += data[key].length;
                  // Check for duplicate positions
                  const duplicates = data[key].filter((pos, index) => data[key].indexOf(pos) !== index);
                  if (duplicates.length > 0) {
                    issues.push(`Duplicate positions in ${path.join(' > ')}: ${duplicates.join(', ')}`);
                  }
                }
              } else {
                totalUnits++;
                const newPath = [...path, key];
                if (key.trim() === '') {
                  issues.push(`Empty unit name at ${path.join(' > ')}`);
                }
                validateRecursive(data[key], newPath);
              }
            });
          } else if (Array.isArray(data)) {
            totalPositions += data.length;
            // Check for duplicate positions
            const duplicates = data.filter((pos, index) => data.indexOf(pos) !== index);
            if (duplicates.length > 0) {
              issues.push(`Duplicate positions in ${path.join(' > ')}: ${duplicates.join(', ')}`);
            }
          }
        }
        
        validateRecursive(orgStructure[category], [category]);
      });
      
      let message = `Structure Validation Results:\n\n`;
      message += `ğŸ“Š Statistics:\n`;
      message += `â€¢ Categories: ${Object.keys(orgStructure).length}\n`;
      message += `â€¢ Total Units: ${totalUnits}\n`;
      message += `â€¢ Total Positions: ${totalPositions}\n\n`;
      
      if (issues.length === 0) {
        message += `âœ… No issues found! Structure is valid.`;
      } else {
        message += `âš ï¸ Issues Found (${issues.length}):\n\n`;
        issues.slice(0, 10).forEach((issue, index) => {
          message += `${index + 1}. ${issue}\n`;
        });
        if (issues.length > 10) {
          message += `... and ${issues.length - 10} more issues`;
        }
      }
      
      alert(message);
    }

    function addNewCategory(event) {
      event.preventDefault();
      const categoryName = document.getElementById('new-category-name').value.toUpperCase();
      const categoryColor = document.getElementById('new-category-color').value;
      
      if (orgStructure[categoryName]) {
        alert('Category already exists!');
        return;
      }
      
      orgStructure[categoryName] = {};
      categoryColors[categoryName] = categoryColor;
      
      // Save to localStorage
      localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
      localStorage.setItem('categoryColors', JSON.stringify(categoryColors));
      
      // Reset form
      document.getElementById('new-category-name').value = '';
      document.getElementById('new-category-color').value = 'blue';
      
      // Refresh displays
      loadCategoryManager();
      renderCategories();
      
      alert(`Category "${categoryName}" added successfully!`);
    }

    function addUnitToCategory(event) {
      event.preventDefault();
      const category = document.getElementById('unit-category-select').value;
      const unitName = document.getElementById('new-unit-name').value;
      
      if (orgStructure[category][unitName]) {
        alert('Unit already exists in this category!');
        return;
      }
      
      orgStructure[category][unitName] = {};
      
      // Save to localStorage
      localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
      
      // Reset form
      document.getElementById('new-unit-name').value = '';
      
      // Refresh displays
      loadCategoryManager();
      renderCategories();
      
      alert(`Unit "${unitName}" added to ${category} successfully!`);
    }

    function removeCategory(category) {
      if (confirm(`Are you sure you want to remove the entire "${category}" category? This will delete all units and positions within it.`)) {
        delete orgStructure[category];
        delete categoryColors[category];
        
        // Save to localStorage
        localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
        localStorage.setItem('categoryColors', JSON.stringify(categoryColors));
        
        // Refresh displays
        loadCategoryManager();
        renderCategories();
        
        alert(`Category "${category}" removed successfully!`);
      }
    }

    function uploadCategoriesStructure(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          // Process categories data
          jsonData.forEach(row => {
            const category = row.Category;
            const color = row.Color || 'blue';
            const unit = row.Unit;
            
            if (category) {
              if (!orgStructure[category]) {
                orgStructure[category] = {};
              }
              if (!categoryColors[category]) {
                categoryColors[category] = color;
              }
              if (unit && !orgStructure[category][unit]) {
                orgStructure[category][unit] = {};
              }
            }
          });
          
          // Save to localStorage
          localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
          localStorage.setItem('categoryColors', JSON.stringify(categoryColors));
          
          // Refresh displays
          loadCategoryManager();
          renderCategories();
          
          alert('Categories structure uploaded successfully!');
        } catch (error) {
          alert('Error reading Excel file. Please check the format.');
        }
      };
      reader.readAsArrayBuffer(file);
      
      // Reset file input
      event.target.value = '';
    }

    function downloadCategoriesTemplate() {
      const templateData = [
        { Category: 'BUSINESS', Color: 'blue', Unit: 'Consumer Business Home' },
        { Category: 'BUSINESS', Color: 'blue', Unit: 'Consumer Business Wireless' },
        { Category: 'BUSINESS', Color: 'blue', Unit: 'Enterprise Business' },
        { Category: 'TECHNOLOGY', Color: 'purple', Unit: 'Network Group' },
        { Category: 'TECHNOLOGY', Color: 'purple', Unit: 'Information Technology' },
        { Category: 'SUPPORT', Color: 'green', Unit: 'Finance Group' },
        { Category: 'SUPPORT', Color: 'green', Unit: 'People Group' },
        { Category: 'GOVERNANCE', Color: 'orange', Unit: 'Internal Audit' },
        { Category: 'OPERATIONS', Color: 'teal', Unit: 'Regional Operations' },
        { Category: 'OPERATIONS', Color: 'teal', Unit: 'Field Operations' }
      ];

      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Categories Template');
      XLSX.writeFile(wb, 'PLDT_Categories_Template.xlsx');
    }

    function exportCurrentStructure() {
      if (currentUser !== 'admin') {
        alert('Export functionality is only available for administrators.');
        return;
      }
      
      const exportData = [];
      
      Object.keys(orgStructure).forEach(category => {
        const color = categoryColors[category] || 'blue';
        Object.keys(orgStructure[category]).forEach(unit => {
          exportData.push({
            Category: category,
            Color: color,
            Unit: unit,
            UnitsCount: Object.keys(orgStructure[category][unit]).length
          });
        });
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Current Structure');
      XLSX.writeFile(wb, 'PLDT_Current_Structure_Export.xlsx');
    }

    // Admin Panel Functions
    function loadAdminData() {
      loadAdminUserRequests();
      loadAdminApprovedUsers();
      updateSystemStatistics();
    }

    function loadAdminUserRequests() {
      // Load reset requests
      const resetContainer = document.getElementById('admin-reset-requests');
      const resetCount = document.getElementById('reset-count');
      
      resetContainer.innerHTML = '';
      
      if (userManagement.resetRequests.length === 0) {
        resetContainer.innerHTML = '<p class="text-gray-500 text-sm">No pending reset requests</p>';
        resetCount.textContent = '0';
      } else {
        resetCount.textContent = userManagement.resetRequests.length;
        userManagement.resetRequests.forEach(request => {
          const div = document.createElement('div');
          div.className = 'bg-red-50 p-3 rounded border border-red-200';
          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <p class="font-medium text-sm">${request.username}</p>
                <p class="text-xs text-gray-500">${new Date(request.timestamp).toLocaleDateString()}</p>
              </div>
              <div class="flex space-x-1">
                <button onclick="approveReset('${request.username}', ${request.id})" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">âœ“</button>
                <button onclick="denyRequest('reset', ${request.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">âœ—</button>
              </div>
            </div>
          `;
          resetContainer.appendChild(div);
        });
      }

      // Load access requests
      const accessContainer = document.getElementById('admin-access-requests');
      const accessCount = document.getElementById('access-count');
      
      accessContainer.innerHTML = '';
      
      if (userManagement.accessRequests.length === 0) {
        accessContainer.innerHTML = '<p class="text-gray-500 text-sm">No pending access requests</p>';
        accessCount.textContent = '0';
      } else {
        accessCount.textContent = userManagement.accessRequests.length;
        userManagement.accessRequests.forEach(request => {
          const div = document.createElement('div');
          div.className = 'bg-green-50 p-3 rounded border border-green-200';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-medium text-sm">ID: ${request.username}</p>
                <p class="text-xs text-blue-600">${request.email}</p>
                <p class="text-xs text-gray-500">${new Date(request.timestamp).toLocaleDateString()}</p>
              </div>
              <div class="flex space-x-1 flex-shrink-0">
                <button onclick="approveAccess('${request.username}', ${request.id})" class="bg-green-500 text-white px-2 py-1 rounded text-xs hover:bg-green-600">âœ“</button>
                <button onclick="denyRequest('access', ${request.id})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">âœ—</button>
              </div>
            </div>
          `;
          accessContainer.appendChild(div);
        });
      }
    }

    function loadAdminApprovedUsers() {
      const approvedContainer = document.getElementById('admin-approved-users');
      const approvedCount = document.getElementById('approved-count');
      
      approvedContainer.innerHTML = '';
      
      const approvedUsersList = Object.keys(userManagement.approvedUsers);
      approvedCount.textContent = approvedUsersList.length;
      
      if (approvedUsersList.length === 0) {
        approvedContainer.innerHTML = '<p class="text-gray-500 text-sm">No approved users</p>';
      } else {
        approvedUsersList.forEach(username => {
          const user = userManagement.approvedUsers[username];
          const div = document.createElement('div');
          div.className = 'bg-blue-50 p-3 rounded border border-blue-200';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <p class="font-medium text-sm">ID: ${username}</p>
                ${user.email ? `<p class="text-xs text-blue-600">${user.email}</p>` : ''}
                <p class="text-xs text-gray-500">Approved: ${new Date(user.approvedDate).toLocaleDateString()}</p>
              </div>
              <div class="flex space-x-1 flex-shrink-0">
                <button onclick="resetUserPassword('${username}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600" title="Reset Password">ğŸ”‘</button>
                <button onclick="removeUser('${username}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600" title="Remove User">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
          approvedContainer.appendChild(div);
        });
      }
    }

    function updateSystemStatistics() {
      // Update total users
      document.getElementById('total-users').textContent = Object.keys(userManagement.approvedUsers).length;
      
      // Update total job descriptions
      document.getElementById('total-jds').textContent = Object.keys(jobDescriptions).length;
      
      // Update org units count
      let orgUnitsCount = 0;
      Object.keys(orgStructure).forEach(category => {
        Object.keys(orgStructure[category]).forEach(unit => {
          orgUnitsCount += Object.keys(orgStructure[category][unit]).length;
        });
      });
      document.getElementById('org-units').textContent = orgUnitsCount;
    }

    function refreshUserRequests() {
      loadAdminUserRequests();
      loadAdminApprovedUsers();
      updateSystemStatistics();
      alert('User data refreshed successfully!');
    }

    function backupSystemData() {
      if (currentUser !== 'admin') {
        alert('Backup functionality is only available for administrators.');
        return;
      }
      
      const backupData = {
        userManagement: userManagement,
        jobDescriptions: jobDescriptions,
        orgChartData: orgChartData,
        orgStructure: orgStructure,
        orgFunctions: orgFunctions,
        categoryColors: categoryColors,
        backupDate: new Date().toISOString(),
        version: '1.0'
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `PLDT_System_Backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      alert('System backup downloaded successfully!');
    }

    function restoreSystemData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backupData = JSON.parse(e.target.result);
            
            if (confirm('This will restore all system data from the backup file. Current data will be overwritten. Continue?')) {
              // Restore all data
              if (backupData.userManagement) {
                userManagement = backupData.userManagement;
                localStorage.setItem('resetRequests', JSON.stringify(userManagement.resetRequests));
                localStorage.setItem('accessRequests', JSON.stringify(userManagement.accessRequests));
                localStorage.setItem('approvedUsers', JSON.stringify(userManagement.approvedUsers));
                localStorage.setItem('adminPassword', userManagement.adminPassword);
              }
              
              if (backupData.jobDescriptions) {
                jobDescriptions = backupData.jobDescriptions;
                localStorage.setItem('jobDescriptions', JSON.stringify(jobDescriptions));
              }
              
              if (backupData.orgChartData) {
                orgChartData = backupData.orgChartData;
                localStorage.setItem('orgChartData', JSON.stringify(orgChartData));
              }
              
              if (backupData.orgStructure) {
                orgStructure = backupData.orgStructure;
                localStorage.setItem('orgStructure', JSON.stringify(orgStructure));
              }
              
              if (backupData.orgFunctions) {
                orgFunctions = backupData.orgFunctions;
                localStorage.setItem('orgFunctions', JSON.stringify(orgFunctions));
              }
              
              if (backupData.categoryColors) {
                categoryColors = backupData.categoryColors;
                localStorage.setItem('categoryColors', JSON.stringify(categoryColors));
              }
              
              alert('System data restored successfully! Please refresh the page.');
              location.reload();
            }
          } catch (error) {
            alert('Error reading backup file. Please check the file format.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function resetSystemToDefaults() {
      if (confirm('This will reset all system data to default values. This cannot be undone. Continue?')) {
        // Clear all localStorage
        localStorage.clear();
        
        // Reset all variables to defaults
        userManagement = {
          resetRequests: [],
          accessRequests: [],
          approvedUsers: {},
          adminPassword: 'Hunter542639'
        };
        
        jobDescriptions = {};
        
        orgChartData = [
          { Level: 1, Position: 'Board of Directors', Parent: '', Color: 'gray', Id: 'board' },
          { Level: 2, Position: 'President and CEO', Parent: 'board', Color: 'gray', Id: 'ceo' },
          { Level: 3, Position: 'PLDT COO', Parent: 'ceo', Color: 'green', Id: 'pldt-coo' },
          { Level: 3, Position: 'Smart COO', Parent: 'ceo', Color: 'orange', Id: 'smart-coo' },
          { Level: 3, Position: 'Technology Group', Parent: 'ceo', Color: 'purple', Id: 'technology' },
          { Level: 3, Position: 'People Group', Parent: 'ceo', Color: 'teal', Id: 'people' },
          { Level: 3, Position: 'Finance & Corporate Sustainability', Parent: 'ceo', Color: 'indigo', Id: 'finance' }
        ];
        
        // Reset org structure to default
        orgStructure = {
          'BUSINESS': {
            'Consumer Business Home': {
              'Regional Operations': ['Manager - Regional Operations', 'Senior Specialist - Customer Relations'],
              'Sales Division': ['Sales Manager', 'Senior Sales Representative']
            }
          },
          'TECHNOLOGY': {
            'Network Group': {
              'Infrastructure': ['Network Infrastructure Manager', 'Senior Network Engineer'],
              'Operations': ['Network Operations Manager', 'NOC Specialist']
            }
          },
          'SUPPORT': {
            'Finance Group': {
              'Financial Planning': ['Finance Manager', 'Financial Analyst'],
              'Accounting': ['Accounting Manager', 'Senior Accountant']
            }
          },
          'GOVERNANCE': {
            'Internal Audit': {
              'Audit Operations': ['Chief Audit Executive', 'Senior Auditor']
            }
          }
        };
        
        orgFunctions = {};
        categoryColors = {
          'BUSINESS': 'blue',
          'TECHNOLOGY': 'blue', 
          'SUPPORT': 'blue',
          'GOVERNANCE': 'blue'
        };
        
        alert('System reset to defaults successfully! Please refresh the page.');
        location.reload();
      }
    }

    function clearAllSystemData() {
      if (confirm('This will permanently delete ALL system data including users, job descriptions, and organizational data. This cannot be undone. Continue?')) {
        if (confirm('Are you absolutely sure? This will delete everything and cannot be recovered.')) {
          localStorage.clear();
          alert('All system data cleared successfully! Please refresh the page.');
          location.reload();
        }
      }
    }

    // Close modals when clicking outside
    document.getElementById('jd-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeJobDescriptionModal();
      }
    });

    document.getElementById('org-units-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeOrgUnitsModal();
      }
    });

    document.getElementById('positions-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closePositionsModal();
      }
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d535fac06a088f',t:'MTc1NDg4ODg2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
