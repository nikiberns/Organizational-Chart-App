<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PLDT Smart Org Design</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
          }
        }
      }
    }
  </script>
  <style>
    .active {
      background-color: #e0f2fe;
    }
    .active img {
      filter: brightness(0) saturate(100%) invert(59%) sepia(98%) saturate(1175%) hue-rotate(184deg) brightness(103%) contrast(101%);
    }
    
    /* Formal Org Chart Styles */
    .org-node {
      position: absolute;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      user-select: none;
      border-radius: 4px;
    }
    
    .org-node:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .org-node-selected {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5) !important;
      z-index: 100;
    }
    
    /* Box Types */
    .org-unit-box {
      border: 2px solid #374151;
      background: white;
    }
    
    .position-box {
      border: 2px dashed #374151;
      background: white;
    }
    
    /* Colors */
    .color-white { background: white; border-color: #374151; }
    .color-red { background: #fef2f2; border-color: #dc2626; }
    .color-green { background: #f0fdf4; border-color: #16a34a; }
    
    /* Box Sizes */
    .size-small { width: 120px; height: 60px; font-size: 11px; padding: 8px; }
    .size-medium { width: 160px; height: 80px; font-size: 12px; padding: 12px; }
    .size-large { width: 200px; height: 100px; font-size: 14px; padding: 16px; }
    
    /* Connection Lines - All Black */
    .org-connection-line {
      position: absolute;
      background: #000000;
      z-index: 1;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .org-connection-line:hover {
      background: #dc2626;
      box-shadow: 0 0 4px rgba(220, 38, 38, 0.5);
    }
    
    .org-connection-vertical {
      width: 2px;
    }
    
    .org-connection-horizontal {
      height: 2px;
    }
    
    .org-connection-point {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #000000;
      border-radius: 50%;
      z-index: 2;
      transform: translate(-50%, -50%);
      border: 2px solid white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .org-connection-point:hover {
      background: #dc2626;
      transform: translate(-50%, -50%) scale(1.2);
    }
    
    /* Custom Connection Lines - All Black */
    .org-connection-custom {
      position: absolute;
      background: #000000;
      z-index: 1;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .org-connection-custom:hover {
      background: #dc2626;
      box-shadow: 0 0 4px rgba(220, 38, 38, 0.5);
    }
    
    .org-connection-custom.org-connection-vertical {
      width: 2px;
    }
    
    .org-connection-custom.org-connection-horizontal {
      height: 2px;
    }
    
    /* Dotted Line Styles */
    .org-connection-dotted {
      background: repeating-linear-gradient(
        to right,
        #000000 0px,
        #000000 4px,
        transparent 4px,
        transparent 8px
      );
    }
    
    .org-connection-dotted.org-connection-vertical {
      background: repeating-linear-gradient(
        to bottom,
        #000000 0px,
        #000000 4px,
        transparent 4px,
        transparent 8px
      );
    }
    
    .org-connection-dotted:hover {
      background: repeating-linear-gradient(
        to right,
        #dc2626 0px,
        #dc2626 4px,
        transparent 4px,
        transparent 8px
      );
    }
    
    .org-connection-dotted.org-connection-vertical:hover {
      background: repeating-linear-gradient(
        to bottom,
        #dc2626 0px,
        #dc2626 4px,
        transparent 4px,
        transparent 8px
      );
    }
    
    .org-connection-custom-point {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #000000;
      border-radius: 50%;
      z-index: 2;
      transform: translate(-50%, -50%);
      border: 2px solid white;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .org-connection-custom-point:hover {
      background: #dc2626;
      transform: translate(-50%, -50%) scale(1.2);
    }
    
    /* Connection Mode Styles */
    .connection-mode-active {
      border: 3px dashed #3b82f6 !important;
      animation: pulse 2s infinite;
    }
    
    .connection-start-selected {
      border: 3px solid #10b981 !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3) !important;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Connection Anchor Points */
    .connection-anchor {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #3b82f6;
      border: 2px solid white;
      border-radius: 50%;
      cursor: crosshair;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .connection-anchor:hover {
      background: #2563eb;
      transform: scale(1.3);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .connection-anchor.active {
      background: #10b981;
      opacity: 1;
      animation: pulse-anchor 1.5s infinite;
    }
    
    .org-node:hover .connection-anchor,
    .connection-mode-active .connection-anchor {
      opacity: 1;
    }
    
    .connection-anchor.top { top: -6px; left: 50%; transform: translateX(-50%); }
    .connection-anchor.bottom { bottom: -6px; left: 50%; transform: translateX(-50%); }
    .connection-anchor.left { left: -6px; top: 50%; transform: translateY(-50%); }
    .connection-anchor.right { right: -6px; top: 50%; transform: translateY(-50%); }
    
    @keyframes pulse-anchor {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1.3);
      }
      50% { 
        opacity: 0.7; 
        transform: scale(1.1);
      }
    }
    
    /* Org Chart Canvas */
    .org-canvas {
      position: relative;
      background: #f9fafb;
      background-image: 
        linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 800px;
      overflow: auto;
    }
    
    /* Tab Navigation */
    .org-tab {
      padding: 12px 20px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: none;
      font-weight: 500;
      position: relative;
    }
    
    .org-tab:hover {
      background: #f3f4f6;
    }
    
    .org-tab.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .org-tab:first-child {
      border-top-left-radius: 8px;
    }
    
    .org-tab:last-child {
      border-top-right-radius: 8px;
    }
    
    /* Smooth Transitions */
    .org-page-transition {
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.4s ease;
    }
    
    .org-page-transition.active {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Expandable Node Indicator */
    .expandable-indicator {
      position: absolute;
      bottom: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    
    .expandable-indicator:hover {
      background: #2563eb;
      transform: scale(1.1);
    }
    
    /* Tab close button */
    .tab-close {
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    
    .tab-close:hover {
      background: rgba(239, 68, 68, 0.8);
      color: white;
    }
    
    /* Line Style Selector */
    .line-style-selector {
      display: inline-flex;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .line-style-option {
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      border-right: 1px solid #d1d5db;
    }
    
    .line-style-option:last-child {
      border-right: none;
    }
    
    .line-style-option:hover {
      background: #f3f4f6;
    }
    
    .line-style-option.active {
      background: #3b82f6;
      color: white;
    }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">
  <!-- Login Screen -->
  <div id="login-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-lg w-80 border border-blue-200">
      <div class="text-center mb-8">
        <img id="login-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-10 sm:h-12 mx-auto mb-4 max-w-full object-contain" alt="Company Logo" />
        <h2 class="text-xl sm:text-2xl font-bold text-blue-900 mb-2">Organization Design Portal</h2>
        <p class="text-blue-600 text-sm">Please enter your credentials to continue</p>
      </div>
      
      <!-- Regular Login Form -->
      <div id="login-form">
        <form onsubmit="login(event)">
          <div class="mb-4">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Username</label>
            <input type="text" id="username" class="w-full px-3 py-2 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
            <div id="access-indicator" class="mt-2 text-sm font-medium hidden">
              <span id="admin-indicator" class="text-purple-600 hidden">üîë Administrator Access Detected</span>
              <span id="viewer-indicator" class="text-blue-600 hidden">üë§ Viewer Access</span>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Password</label>
            <div class="relative">
              <input type="password" id="password" class="w-full px-3 py-2 pr-10 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
              <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-blue-600 hover:text-blue-800">
                <svg id="eye-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <svg id="eye-off-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="w-full bg-blue-900 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition duration-200 font-semibold shadow-md">
            Log In
          </button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="showPasswordReset()" class="text-blue-600 text-sm hover:text-blue-800 underline">
            Reset Password / Request Access
          </button>
        </div>
      </div>

      <!-- Password Reset Form -->
      <div id="reset-form" class="hidden">
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-900 mb-2">Reset Password / Request Access</h3>
          <p class="text-blue-600 text-sm">Enter your username to reset password or request viewer access</p>
        </div>
        <form onsubmit="requestPasswordReset(event)">
          <div class="mb-5">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Request Type</label>
            <select id="request-type" onchange="toggleRequestFields()" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50">
              <option value="reset">Reset Existing Password</option>
              <option value="access">Request New Viewer Access</option>
            </select>
          </div>
          
          <!-- Reset Password Fields -->
          <div id="reset-fields">
            <div class="mb-5">
              <label class="block text-blue-900 text-sm font-semibold mb-2">ID Number</label>
              <input type="text" id="reset-username" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
            </div>
          </div>
          
          <!-- New Access Fields -->
          <div id="access-fields" class="hidden">
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Company Email</label>
              <input type="email" id="company-email" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="your.name@pldt.com.ph">
            </div>
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">ID Number</label>
              <input type="text" id="access-id-number" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Enter your employee ID">
            </div>
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Preferred Password</label>
              <input type="password" id="preferred-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Minimum 8 characters" minlength="8">
            </div>
            <div class="mb-5">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Confirm Password</label>
              <input type="password" id="confirm-preferred-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Confirm your password" minlength="8">
            </div>
          </div>
          
          <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
            Submit Request
          </button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="showLoginForm()" class="text-blue-600 text-sm hover:text-blue-800 underline">
            ‚Üê Back to Login
          </button>
        </div>
      </div>

      <div id="login-error" class="mt-4 text-red-600 text-sm text-center hidden bg-red-50 p-3 rounded-lg border border-red-200">
        Invalid credentials. Please try again.
      </div>
      <div id="login-success" class="mt-4 text-green-600 text-sm text-center hidden bg-green-50 p-3 rounded-lg border border-green-200">
        Request submitted successfully!
      </div>
    </div>
  </div>

  <!-- Add Node Modal -->
  <div id="add-node-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add New Node</h3>
        <button onclick="closeAddNodeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <form onsubmit="createNewOrgNode(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text" id="new-node-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reports To</label>
            <select id="new-node-parent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">-- Top Level --</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Level (for positioning only)</label>
            <select id="new-node-level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="0">Level 0 (Board)</option>
              <option value="0.5">Level 0.5 (Board Support)</option>
              <option value="1">Level 1 (CEO)</option>
              <option value="2" selected>Level 2 (C-Suite)</option>
              <option value="3">Level 3 (Directors)</option>
              <option value="4">Level 4 (Managers)</option>
              <option value="5">Level 5 (Supervisors)</option>
              <option value="6">Level 6 (Team Leads)</option>
              <option value="7">Level 7 (Senior Staff)</option>
              <option value="8">Level 8 (Staff)</option>
              <option value="9">Level 9 (Associates)</option>
              <option value="10">Level 10 (Entry Level)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="new-node-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="org-unit">Organization Unit (Solid Box)</option>
              <option value="position">Position (Dotted Box)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
            <select id="new-node-color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="white">White</option>
              <option value="red">Red</option>
              <option value="green">Green</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
            <select id="new-node-size" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeAddNodeModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Add Node
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Node Properties Modal -->
  <div id="node-properties-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Node Properties</h3>
        <button onclick="closeNodePropertiesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <form onsubmit="updateNodeProperties(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text" id="prop-node-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reports To</label>
            <select id="prop-node-parent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">-- Top Level --</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Level (for positioning only)</label>
            <select id="prop-node-level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="0">Level 0 (Board)</option>
              <option value="0.5">Level 0.5 (Board Support)</option>
              <option value="1">Level 1 (CEO)</option>
              <option value="2">Level 2 (C-Suite)</option>
              <option value="3">Level 3 (Directors)</option>
              <option value="4">Level 4 (Managers)</option>
              <option value="5">Level 5 (Supervisors)</option>
              <option value="6">Level 6 (Team Leads)</option>
              <option value="7">Level 7 (Senior Staff)</option>
              <option value="8">Level 8 (Staff)</option>
              <option value="9">Level 9 (Associates)</option>
              <option value="10">Level 10 (Entry Level)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="prop-node-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="org-unit">Organization Unit (Solid Box)</option>
              <option value="position">Position (Dotted Box)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
            <select id="prop-node-color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="white">White</option>
              <option value="red">Red</option>
              <option value="green">Green</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
            <select id="prop-node-size" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="deleteSelectedNode()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
            Delete
          </button>
          <button type="button" onclick="closeNodePropertiesModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Update
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-app" class="flex h-screen hidden">
    <!-- Sidebar -->
    <div class="w-20 bg-white border-r flex flex-col items-center py-6 space-y-8 shadow-md h-full">
      <button onclick="navigate('home')" id="nav-home" class="p-3 rounded hover:bg-blue-100">
        <img id="home-icon" src="https://img.icons8.com/ios-filled/28/000000/home.png" alt="Home" />
      </button>
      <button onclick="navigate('org')" id="nav-org" class="p-3 rounded hover:bg-blue-100">
        <img id="org-icon" src="https://img.icons8.com/ios-filled/28/000000/organization.png" alt="Org Chart" />
      </button>
      <button onclick="navigate('jd')" id="nav-jd" class="p-3 rounded hover:bg-blue-100">
        <img id="jd-icon" src="https://img.icons8.com/ios-filled/28/000000/resume.png" alt="Job Description" />
      </button>
      <button onclick="navigate('admin')" id="nav-admin" class="p-3 rounded hover:bg-blue-100 hidden">
        <img id="admin-icon" src="https://img.icons8.com/ios-filled/28/000000/admin-settings-male.png" alt="Admin Panel" />
      </button>
      <div class="flex-1"></div>
      <div class="text-center">
        <div class="text-xs text-gray-500 mb-3" id="user-role">Admin</div>
        <button onclick="logout()" class="p-3 rounded hover:bg-red-100">
          <img id="logout-icon" src="https://img.icons8.com/ios-filled/28/000000/logout-rounded.png" alt="Logout" />
        </button>
      </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 p-6 overflow-y-auto">
      <!-- Home -->
      <div id="home" class="space-y-8 h-full flex flex-col">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <img id="company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-12 sm:h-16 max-w-full object-contain" alt="Company Logo" />
        </div>
        <h1 class="text-4xl font-bold text-blue-900 text-center mb-6">Organizational Design Portal</h1>
        <div class="flex flex-col space-y-4 max-w-2xl mx-auto w-full">
          <button onclick="navigate('org')" class="block w-full text-left px-6 py-6 rounded-lg bg-gradient-to-r from-red-200 to-orange-200 shadow-md hover:shadow-lg transition-shadow">
            <p class="text-xs uppercase font-medium text-gray-700">Converged View</p>
            <p class="text-xl font-bold text-gray-900 mt-1">Organizational Charts</p>
            <p class="text-gray-600 mt-1 text-sm">View and manage organizational hierarchy with formal chart structure</p>
          </button>
          <button onclick="navigate('jd')" class="block w-full text-left px-6 py-6 rounded-lg bg-gradient-to-r from-teal-200 to-green-200 shadow-md hover:shadow-lg transition-shadow">
            <p class="text-xs uppercase font-medium text-gray-700">Database</p>
            <p class="text-xl font-bold text-gray-900 mt-1">Job Description</p>
            <p class="text-gray-600 mt-1 text-sm">Browse positions by category and manage job descriptions</p>
          </button>
        </div>
      </div>

      <!-- Org Chart -->
      <div id="org" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="org-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Organizational Chart</h2>
          </div>
          <div class="flex items-center space-x-2">
            <div id="org-admin-controls" class="space-x-2 hidden">
              <button onclick="toggleEditMode()" id="edit-mode-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700">
                ‚úèÔ∏è Edit Mode
              </button>
            </div>
          </div>
        </div>
        
        <!-- Org Chart Tabs -->
        <div class="mb-4">
          <div class="flex border-b overflow-x-auto" id="org-tabs">
            <div class="org-tab active" onclick="switchOrgTab('main')">Main Structure</div>
          </div>
        </div>
        
        <!-- Org Chart Container -->
        <div class="w-full">
          <div id="org-chart-container" class="bg-white border rounded-lg overflow-hidden">
            <!-- Toolbar -->
            <div id="org-toolbar" class="bg-gray-50 border-b p-3 flex items-center justify-between hidden">
              <div class="flex items-center space-x-2 flex-wrap">
                <!-- Quick Add Buttons -->
                <div class="flex items-center space-x-2 border-r pr-3">
                  <button onclick="quickAddOrgUnit()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex items-center">
                    <span class="mr-1">üè¢</span> Add Org Unit
                  </button>
                  <button onclick="quickAddPosition()" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 flex items-center">
                    <span class="mr-1">üë§</span> Add Position
                  </button>
                </div>
                
                <!-- Templates -->
                <div class="flex items-center space-x-2 border-r pr-3">
                  <select id="org-templates" onchange="applyOrgTemplate()" class="px-2 py-1 border rounded text-sm">
                    <option value="">üìã Templates</option>
                    <option value="corporate">Corporate Structure</option>
                    <option value="functional">Functional Org</option>
                    <option value="divisional">Divisional Structure</option>
                    <option value="matrix">Matrix Organization</option>
                  </select>
                </div>
                
                <!-- Tools -->
                <div class="flex items-center space-x-2 border-r pr-3">
                  <button onclick="undo()" id="undo-btn" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Nothing to undo">
                    ‚Ü∂ Undo
                  </button>
                  <button onclick="redo()" id="redo-btn" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Nothing to redo">
                    ‚Ü∑ Redo
                  </button>
                  <button onclick="toggleConnectionMode()" id="connection-mode-btn" class="bg-indigo-600 text-white px-2 py-1 rounded text-sm hover:bg-indigo-700">
                    üîó Connect Mode
                  </button>
                  <button onclick="autoLayout()" class="bg-purple-600 text-white px-2 py-1 rounded text-sm hover:bg-purple-700">
                    ‚ú® Auto Layout
                  </button>
                  <button onclick="createNewPage()" class="bg-orange-600 text-white px-2 py-1 rounded text-sm hover:bg-orange-700">
                    üìÑ New Page
                  </button>
                </div>
                
                <!-- Line Style Selector -->
                <div class="flex items-center space-x-2">
                  <span class="text-sm text-gray-600">Line Style:</span>
                  <div class="line-style-selector">
                    <div class="line-style-option active" onclick="setLineStyle('solid')" data-style="solid">
                      ‚îÅ‚îÅ‚îÅ Solid
                    </div>
                    <div class="line-style-option" onclick="setLineStyle('dotted')" data-style="dotted">
                      ‚îÖ‚îÖ‚îÖ Dotted
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="flex items-center space-x-2">
                <button onclick="zoomOrgChart('in')" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700">üîç+</button>
                <span id="zoom-level" class="text-sm text-gray-600">100%</span>
                <button onclick="zoomOrgChart('out')" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700">üîç-</button>
                <button onclick="resetOrgView()" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700">üéØ</button>
              </div>
            </div>
            
            <!-- Chart Canvas -->
            <div id="org-chart" class="org-canvas relative" style="height: 800px; width: 100%; min-width: 1200px;">
              <!-- Dynamic org chart will be generated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div id="admin" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="admin-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Admin Panel</h2>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- User Management Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="text-blue-600 mr-2">üë•</span>
              User Management
            </h3>
            
            <!-- Password Reset Requests -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-800 mb-3 flex items-center justify-between">
                <span>üîë Password Reset Requests</span>
                <span id="reset-count" class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">0</span>
              </h4>
              <div id="admin-reset-requests" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-gray-500 text-sm">No pending reset requests</p>
              </div>
            </div>

            <!-- Access Requests -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-800 mb-3 flex items-center justify-between">
                <span>üìù New Access Requests</span>
                <span id="access-count" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">0</span>
              </h4>
              <div id="admin-access-requests" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-gray-500 text-sm">No pending access requests</p>
              </div>
            </div>
          </div>

          <!-- Approved Users Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
              <span class="flex items-center">
                <span class="text-green-600 mr-2">‚úÖ</span>
                Approved Users
              </span>
              <span id="approved-count" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            
            <div id="admin-approved-users" class="space-y-2 max-h-80 overflow-y-auto">
              <p class="text-gray-500 text-sm">No approved users</p>
            </div>
          </div>
        </div>
      </div>

      <!-- JD Database -->
      <div id="jd" class="hidden">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="jd-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Job Descriptions</h2>
          </div>
        </div>
        
        <div id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Categories will be dynamically generated here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let userLevel = null;
    let isPreviewMode = false;
    
    // User Management System with multi-level admin support
    let userManagement = {
      resetRequests: JSON.parse(localStorage.getItem('resetRequests') || '[]'),
      accessRequests: JSON.parse(localStorage.getItem('accessRequests') || '[]'),
      approvedUsers: JSON.parse(localStorage.getItem('approvedUsers') || '{}'),
      level1Password: localStorage.getItem('level1Password') || 'Hunter542639',
      level2Password: localStorage.getItem('level2Password') || 'PLDT_L2_Admin'
    };
    
    // Formal Org Chart System
    let orgChartData = {
      nodes: [
        { 
          id: 'board', 
          title: 'Board of Directors', 
          parent: null, 
          type: 'org-unit', 
          color: 'white', 
          size: 'large',
          level: 0,
          x: 400, 
          y: 50,
          hasChildren: true
        },
        { 
          id: 'audit', 
          title: 'Internal Audit', 
          parent: 'board', 
          type: 'org-unit', 
          color: 'red', 
          size: 'medium',
          level: 0.5,
          x: 200, 
          y: 150,
          hasChildren: false
        },
        { 
          id: 'governance', 
          title: 'Corporate Governance', 
          parent: 'board', 
          type: 'org-unit', 
          color: 'red', 
          size: 'medium',
          level: 0.5,
          x: 600, 
          y: 150,
          hasChildren: false
        },
        { 
          id: 'ceo', 
          title: 'President and CEO', 
          parent: 'board', 
          type: 'org-unit', 
          color: 'white', 
          size: 'large',
          level: 1,
          x: 400, 
          y: 250,
          hasChildren: true
        },
        { 
          id: 'cfo', 
          title: 'Chief Financial Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 150, 
          y: 380,
          hasChildren: true
        },
        { 
          id: 'coo', 
          title: 'Chief Operating Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 350, 
          y: 380,
          hasChildren: true
        },
        { 
          id: 'cto', 
          title: 'Chief Technology Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 550, 
          y: 380,
          hasChildren: true
        },
        { 
          id: 'chro', 
          title: 'Chief Human Resources Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 750, 
          y: 380,
          hasChildren: true
        }
      ],
      pages: {
        'main': {
          title: 'Main Structure',
          nodes: ['board', 'audit', 'governance', 'ceo', 'cfo', 'coo', 'cto', 'chro']
        }
      }
    };
    
    let currentOrgPage = 'main';
    let selectedNode = null;
    let orgEditMode = false;
    let orgZoomLevel = 1;
    let nodeIdCounter = 1000;
    let connectionMode = false;
    let connectionStart = null;
    let customConnections = []; // Store custom connections separate from hierarchy
    let currentLineStyle = 'solid'; // Track current line style
    
    // Undo/Redo System
    let undoStack = [];
    let redoStack = [];
    let maxUndoSteps = 50;
    
    function saveState(action = 'Unknown Action') {
      const state = {
        action: action,
        timestamp: Date.now(),
        orgChartData: JSON.parse(JSON.stringify(orgChartData)),
        customConnections: JSON.parse(JSON.stringify(customConnections)),
        currentOrgPage: currentOrgPage
      };
      
      undoStack.push(state);
      
      // Limit undo stack size
      if (undoStack.length > maxUndoSteps) {
        undoStack.shift();
      }
      
      // Clear redo stack when new action is performed
      redoStack = [];
      
      updateUndoRedoButtons();
    }
    
    function undo() {
      if (undoStack.length === 0) return;
      
      // Save current state to redo stack
      const currentState = {
        action: 'Current State',
        timestamp: Date.now(),
        orgChartData: JSON.parse(JSON.stringify(orgChartData)),
        customConnections: JSON.parse(JSON.stringify(customConnections)),
        currentOrgPage: currentOrgPage
      };
      redoStack.push(currentState);
      
      // Restore previous state
      const previousState = undoStack.pop();
      orgChartData = JSON.parse(JSON.stringify(previousState.orgChartData));
      customConnections = JSON.parse(JSON.stringify(previousState.customConnections));
      currentOrgPage = previousState.currentOrgPage;
      
      // Update UI
      updateOrgTabs();
      renderOrgChart();
      updateUndoRedoButtons();
      
      // Show action feedback
      showActionFeedback(`‚Ü∂ Undid: ${previousState.action}`);
    }
    
    function redo() {
      if (redoStack.length === 0) return;
      
      // Save current state to undo stack
      const currentState = {
        action: 'Redo Point',
        timestamp: Date.now(),
        orgChartData: JSON.parse(JSON.stringify(orgChartData)),
        customConnections: JSON.parse(JSON.stringify(customConnections)),
        currentOrgPage: currentOrgPage
      };
      undoStack.push(currentState);
      
      // Restore next state
      const nextState = redoStack.pop();
      orgChartData = JSON.parse(JSON.stringify(nextState.orgChartData));
      customConnections = JSON.parse(JSON.stringify(nextState.customConnections));
      currentOrgPage = nextState.currentOrgPage;
      
      // Update UI
      updateOrgTabs();
      renderOrgChart();
      updateUndoRedoButtons();
      
      // Show action feedback
      showActionFeedback(`‚Ü∑ Redid: ${nextState.action}`);
    }
    
    function updateUndoRedoButtons() {
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');
      
      if (undoBtn) {
        undoBtn.disabled = undoStack.length === 0;
        undoBtn.title = undoStack.length > 0 ? `Undo: ${undoStack[undoStack.length - 1].action}` : 'Nothing to undo';
      }
      
      if (redoBtn) {
        redoBtn.disabled = redoStack.length === 0;
        redoBtn.title = redoStack.length > 0 ? `Redo: ${redoStack[redoStack.length - 1].action}` : 'Nothing to redo';
      }
    }
    
    function showActionFeedback(message) {
      // Create or update feedback element
      let feedback = document.getElementById('action-feedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.id = 'action-feedback';
        feedback.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
        document.body.appendChild(feedback);
      }
      
      feedback.textContent = message;
      feedback.style.opacity = '1';
      feedback.style.transform = 'translateY(0)';
      
      // Auto-hide after 2 seconds
      setTimeout(() => {
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateY(-20px)';
      }, 2000);
    }

    // Line Style Management
    function setLineStyle(style) {
      currentLineStyle = style;
      
      // Update UI
      document.querySelectorAll('.line-style-option').forEach(option => {
        option.classList.remove('active');
      });
      document.querySelector(`[data-style="${style}"]`).classList.add('active');
      
      // Re-render connections with new style
      clearConnections();
      drawOrgConnections();
      
      showActionFeedback(`üìè Line style: ${style === 'solid' ? 'Solid' : 'Dotted'}`);
    }

    // Password visibility toggle
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('password');
      const eyeIcon = document.getElementById('eye-icon');
      const eyeOffIcon = document.getElementById('eye-off-icon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.add('hidden');
        eyeOffIcon.classList.remove('hidden');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('hidden');
        eyeOffIcon.classList.add('hidden');
      }
    }

    // Real-time access level detection based on username
    document.addEventListener('DOMContentLoaded', function() {
      const usernameInput = document.getElementById('username');
      
      usernameInput.addEventListener('input', function() {
        const username = this.value.trim();
        const accessIndicator = document.getElementById('access-indicator');
        const adminIndicator = document.getElementById('admin-indicator');
        const viewerIndicator = document.getElementById('viewer-indicator');
        
        if (username === 'ntbernal_ADMIN') {
          accessIndicator.classList.remove('hidden');
          adminIndicator.classList.remove('hidden');
          adminIndicator.textContent = 'üîë Administrator Access Detected';
          viewerIndicator.classList.add('hidden');
        } else if (username === 'ntbernal') {
          accessIndicator.classList.remove('hidden');
          adminIndicator.classList.add('hidden');
          viewerIndicator.classList.remove('hidden');
          viewerIndicator.textContent = 'üë§ Viewer Access Detected';
        } else if (username.length > 0) {
          accessIndicator.classList.remove('hidden');
          adminIndicator.classList.add('hidden');
          viewerIndicator.classList.remove('hidden');
          viewerIndicator.textContent = 'üë§ Viewer Access';
        } else {
          accessIndicator.classList.add('hidden');
          adminIndicator.classList.add('hidden');
          viewerIndicator.classList.add('hidden');
        }
      });
    });

    // Simple Working Login System
    function login(event) {
      event.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const errorDiv = document.getElementById('login-error');

      // Direct credential check - simple and reliable
      if ((username === 'ntbernal_ADMIN' && password === 'Hunter542639') ||
          (username === 'ntbernal' && password === 'PLDT_HR_OD')) {
        
        // Set user level
        if (username === 'ntbernal_ADMIN') {
          currentUser = 'admin';
          userLevel = 'level1';
        } else {
          currentUser = 'viewer';
          userLevel = 'viewer';
        }
        
        isPreviewMode = false;
        
        // Hide login, show app
        errorDiv.classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        setupUserInterface();
        navigate('home');
        
      } else {
        // Show error
        errorDiv.classList.remove('hidden');
        document.getElementById('password').value = '';
      }
    }

    // Setup user interface based on access level
    function setupUserInterface() {
      const roleText = isPreviewMode ? 'Preview Mode' : 
                      (userLevel === 'level1' ? 'Level 1 Admin' : 
                       userLevel === 'level2' ? 'Level 2 Admin' : 'Viewer');
      
      document.getElementById('user-role').textContent = roleText;
      
      // Show/hide controls based on user level and preview mode
      const isLevel1 = userLevel === 'level1' && !isPreviewMode;
      const isLevel2 = (userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode;
      const isAdmin = (userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode;
      
      // Level 1 only controls
      document.getElementById('org-admin-controls').classList.toggle('hidden', !isLevel1);
      document.getElementById('nav-admin').classList.toggle('hidden', !isLevel1);
      document.getElementById('org-toolbar').classList.toggle('hidden', !isLevel1);
    }

    // Password Reset Functions
    function showPasswordReset() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('reset-form').classList.remove('hidden');
    }

    function toggleRequestFields() {
      const requestType = document.getElementById('request-type').value;
      const resetFields = document.getElementById('reset-fields');
      const accessFields = document.getElementById('access-fields');
      
      if (requestType === 'access') {
        resetFields.classList.add('hidden');
        accessFields.classList.remove('hidden');
      } else {
        resetFields.classList.remove('hidden');
        accessFields.classList.add('hidden');
      }
    }

    function showLoginForm() {
      document.getElementById('reset-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('login-success').classList.add('hidden');
    }

    function requestPasswordReset(event) {
      event.preventDefault();
      document.getElementById('login-success').classList.remove('hidden');
      
      setTimeout(() => {
        showLoginForm();
      }, 2000);
    }

    function logout() {
      currentUser = null;
      userLevel = null;
      isPreviewMode = false;
      
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('password').value = '';
      document.getElementById('username').value = '';
      document.getElementById('login-error').classList.add('hidden');
      
      // Hide admin controls
      document.getElementById('org-admin-controls').classList.add('hidden');
      document.getElementById('nav-admin').classList.add('hidden');
      document.getElementById('org-toolbar').classList.add('hidden');
    }

    // Navigation
    function navigate(section) {
      const sections = ['home', 'org', 'jd', 'admin'];
      const navButtons = ['nav-home', 'nav-org', 'nav-jd', 'nav-admin'];

      sections.forEach(s => {
        document.getElementById(s).classList.add('hidden');
      });

      navButtons.forEach(btn => {
        document.getElementById(btn).classList.remove('active');
      });

      document.getElementById(section).classList.remove('hidden');
      document.getElementById('nav-' + section).classList.add('active');
      
      if (section === 'org') {
        renderOrgChart();
      } else if (section === 'jd') {
        initializeJDSystem();
      }
    }

    // Job Description Categories
    const jobCategories = [
      {
        id: 'executive',
        name: 'Executive Leadership',
        icon: 'üëî',
        color: 'from-purple-400 to-purple-600',
        positions: [
          { title: 'Chief Executive Officer', level: 'C-Suite', department: 'Executive', code: 'CEO-001' },
          { title: 'Chief Operating Officer', level: 'C-Suite', department: 'Operations', code: 'COO-001' },
          { title: 'Chief Financial Officer', level: 'C-Suite', department: 'Finance', code: 'CFO-001' },
          { title: 'Chief Technology Officer', level: 'C-Suite', department: 'Technology', code: 'CTO-001' },
          { title: 'Chief Human Resources Officer', level: 'C-Suite', department: 'Human Resources', code: 'CHRO-001' },
          { title: 'Chief Marketing Officer', level: 'C-Suite', department: 'Marketing', code: 'CMO-001' }
        ]
      },
      {
        id: 'management',
        name: 'Management',
        icon: 'üìä',
        color: 'from-blue-400 to-blue-600',
        positions: [
          { title: 'Vice President - Operations', level: 'VP', department: 'Operations', code: 'VP-OPS-001' },
          { title: 'Vice President - Sales', level: 'VP', department: 'Sales', code: 'VP-SAL-001' },
          { title: 'Vice President - Engineering', level: 'VP', department: 'Engineering', code: 'VP-ENG-001' },
          { title: 'Director of Finance', level: 'Director', department: 'Finance', code: 'DIR-FIN-001' },
          { title: 'Director of Human Resources', level: 'Director', department: 'Human Resources', code: 'DIR-HR-001' },
          { title: 'Director of Marketing', level: 'Director', department: 'Marketing', code: 'DIR-MKT-001' },
          { title: 'Regional Manager', level: 'Manager', department: 'Operations', code: 'MGR-REG-001' },
          { title: 'Product Manager', level: 'Manager', department: 'Product', code: 'MGR-PRD-001' }
        ]
      },
      {
        id: 'technology',
        name: 'Technology & Engineering',
        icon: 'üíª',
        color: 'from-green-400 to-green-600',
        positions: [
          { title: 'Senior Software Engineer', level: 'Senior', department: 'Engineering', code: 'ENG-SR-001' },
          { title: 'Software Engineer', level: 'Mid-Level', department: 'Engineering', code: 'ENG-MID-001' },
          { title: 'Junior Software Engineer', level: 'Junior', department: 'Engineering', code: 'ENG-JR-001' },
          { title: 'DevOps Engineer', level: 'Mid-Level', department: 'Engineering', code: 'DEV-OPS-001' },
          { title: 'Data Scientist', level: 'Senior', department: 'Data', code: 'DATA-SR-001' },
          { title: 'System Administrator', level: 'Mid-Level', department: 'IT', code: 'SYS-ADM-001' },
          { title: 'Network Engineer', level: 'Mid-Level', department: 'IT', code: 'NET-ENG-001' },
          { title: 'Cybersecurity Specialist', level: 'Senior', department: 'Security', code: 'SEC-SP-001' }
        ]
      },
      {
        id: 'sales',
        name: 'Sales & Marketing',
        icon: 'üìà',
        color: 'from-orange-400 to-orange-600',
        positions: [
          { title: 'Sales Director', level: 'Director', department: 'Sales', code: 'SAL-DIR-001' },
          { title: 'Senior Sales Manager', level: 'Senior Manager', department: 'Sales', code: 'SAL-MGR-001' },
          { title: 'Account Executive', level: 'Mid-Level', department: 'Sales', code: 'ACC-EXE-001' },
          { title: 'Sales Representative', level: 'Entry-Level', department: 'Sales', code: 'SAL-REP-001' },
          { title: 'Marketing Manager', level: 'Manager', department: 'Marketing', code: 'MKT-MGR-001' },
          { title: 'Digital Marketing Specialist', level: 'Mid-Level', department: 'Marketing', code: 'DIG-MKT-001' },
          { title: 'Content Marketing Manager', level: 'Manager', department: 'Marketing', code: 'CON-MKT-001' },
          { title: 'Brand Manager', level: 'Manager', department: 'Marketing', code: 'BRD-MGR-001' }
        ]
      },
      {
        id: 'operations',
        name: 'Operations & Support',
        icon: '‚öôÔ∏è',
        color: 'from-teal-400 to-teal-600',
        positions: [
          { title: 'Operations Manager', level: 'Manager', department: 'Operations', code: 'OPS-MGR-001' },
          { title: 'Supply Chain Manager', level: 'Manager', department: 'Supply Chain', code: 'SCM-MGR-001' },
          { title: 'Quality Assurance Manager', level: 'Manager', department: 'Quality', code: 'QA-MGR-001' },
          { title: 'Customer Success Manager', level: 'Manager', department: 'Customer Success', code: 'CS-MGR-001' },
          { title: 'Project Coordinator', level: 'Mid-Level', department: 'Operations', code: 'PRJ-CRD-001' },
          { title: 'Business Analyst', level: 'Mid-Level', department: 'Operations', code: 'BUS-ANL-001' },
          { title: 'Administrative Assistant', level: 'Entry-Level', department: 'Administration', code: 'ADM-AST-001' }
        ]
      },
      {
        id: 'finance',
        name: 'Finance & Accounting',
        icon: 'üí∞',
        color: 'from-indigo-400 to-indigo-600',
        positions: [
          { title: 'Finance Manager', level: 'Manager', department: 'Finance', code: 'FIN-MGR-001' },
          { title: 'Senior Accountant', level: 'Senior', department: 'Accounting', code: 'ACC-SR-001' },
          { title: 'Staff Accountant', level: 'Mid-Level', department: 'Accounting', code: 'ACC-STF-001' },
          { title: 'Financial Analyst', level: 'Mid-Level', department: 'Finance', code: 'FIN-ANL-001' },
          { title: 'Budget Analyst', level: 'Mid-Level', department: 'Finance', code: 'BUD-ANL-001' },
          { title: 'Accounts Payable Specialist', level: 'Entry-Level', department: 'Accounting', code: 'AP-SP-001' },
          { title: 'Accounts Receivable Specialist', level: 'Entry-Level', department: 'Accounting', code: 'AR-SP-001' },
          { title: 'Payroll Specialist', level: 'Mid-Level', department: 'Finance', code: 'PAY-SP-001' }
        ]
      },
      {
        id: 'hr',
        name: 'Human Resources',
        icon: 'üë•',
        color: 'from-pink-400 to-pink-600',
        positions: [
          { title: 'HR Manager', level: 'Manager', department: 'Human Resources', code: 'HR-MGR-001' },
          { title: 'Talent Acquisition Specialist', level: 'Mid-Level', department: 'Human Resources', code: 'TA-SP-001' },
          { title: 'HR Business Partner', level: 'Senior', department: 'Human Resources', code: 'HR-BP-001' },
          { title: 'Compensation & Benefits Analyst', level: 'Mid-Level', department: 'Human Resources', code: 'CB-ANL-001' },
          { title: 'Training & Development Coordinator', level: 'Mid-Level', department: 'Human Resources', code: 'TD-CRD-001' },
          { title: 'HR Generalist', level: 'Mid-Level', department: 'Human Resources', code: 'HR-GEN-001' },
          { title: 'Organizational Development Specialist', level: 'Senior', department: 'Human Resources', code: 'OD-SP-001' }
        ]
      },
      {
        id: 'legal',
        name: 'Legal & Compliance',
        icon: '‚öñÔ∏è',
        color: 'from-gray-400 to-gray-600',
        positions: [
          { title: 'General Counsel', level: 'C-Suite', department: 'Legal', code: 'GC-001' },
          { title: 'Senior Legal Counsel', level: 'Senior', department: 'Legal', code: 'LEG-SR-001' },
          { title: 'Corporate Lawyer', level: 'Mid-Level', department: 'Legal', code: 'LEG-CRP-001' },
          { title: 'Compliance Manager', level: 'Manager', department: 'Compliance', code: 'COM-MGR-001' },
          { title: 'Compliance Specialist', level: 'Mid-Level', department: 'Compliance', code: 'COM-SP-001' },
          { title: 'Contract Administrator', level: 'Mid-Level', department: 'Legal', code: 'CON-ADM-001' },
          { title: 'Legal Assistant', level: 'Entry-Level', department: 'Legal', code: 'LEG-AST-001' }
        ]
      }
    ];

    // Job Description Templates
    const jobDescriptionTemplates = {
      'CEO-001': {
        title: 'Chief Executive Officer',
        department: 'Executive',
        level: 'C-Suite',
        reportsTo: 'Board of Directors',
        summary: 'The Chief Executive Officer (CEO) is responsible for the overall strategic direction, management, and success of the organization. The CEO provides leadership and vision to ensure the company achieves its mission and objectives while maintaining the highest standards of corporate governance.',
        responsibilities: [
          'Develop and implement comprehensive business strategies to promote company growth and profitability',
          'Provide strategic leadership and direction to all departments and business units',
          'Build and maintain relationships with key stakeholders, investors, and board members',
          'Oversee financial performance and ensure fiscal responsibility',
          'Foster a positive corporate culture that promotes innovation, collaboration, and excellence',
          'Represent the company in public forums, industry events, and media interactions',
          'Ensure compliance with all legal and regulatory requirements',
          'Lead organizational change initiatives and digital transformation efforts'
        ],
        qualifications: [
          'Master\'s degree in Business Administration, Management, or related field',
          'Minimum 15 years of progressive leadership experience in senior executive roles',
          'Proven track record of successful business growth and transformation',
          'Strong financial acumen and strategic planning capabilities',
          'Excellent communication, negotiation, and interpersonal skills',
          'Experience in mergers, acquisitions, and corporate restructuring',
          'Deep understanding of industry trends and competitive landscape'
        ],
        skills: [
          'Strategic Planning & Execution',
          'Leadership & Team Building',
          'Financial Management',
          'Stakeholder Management',
          'Corporate Governance',
          'Change Management',
          'Public Speaking',
          'Crisis Management'
        ]
      },
      'CTO-001': {
        title: 'Chief Technology Officer',
        department: 'Technology',
        level: 'C-Suite',
        reportsTo: 'Chief Executive Officer',
        summary: 'The Chief Technology Officer (CTO) is responsible for overseeing the technological direction of the company, driving innovation, and ensuring that technology strategies align with business objectives. The CTO leads the technology organization and plays a key role in digital transformation initiatives.',
        responsibilities: [
          'Develop and execute comprehensive technology strategy aligned with business goals',
          'Lead digital transformation initiatives and emerging technology adoption',
          'Oversee software development, infrastructure, and technology operations',
          'Build and manage high-performing technology teams',
          'Ensure cybersecurity, data privacy, and regulatory compliance',
          'Drive innovation through research and development initiatives',
          'Manage technology budgets and vendor relationships',
          'Collaborate with other executives on technology-enabled business solutions'
        ],
        qualifications: [
          'Master\'s degree in Computer Science, Engineering, or related technical field',
          'Minimum 12 years of progressive technology leadership experience',
          'Proven experience in enterprise software development and architecture',
          'Strong background in cloud computing, AI/ML, and emerging technologies',
          'Experience leading large-scale digital transformation projects',
          'Excellent leadership and team management skills',
          'Strong business acumen and strategic thinking abilities'
        ],
        skills: [
          'Technology Strategy',
          'Software Architecture',
          'Cloud Computing',
          'Artificial Intelligence',
          'Cybersecurity',
          'Team Leadership',
          'Project Management',
          'Vendor Management'
        ]
      }
    };

    // Initialize JD system
    function initializeJDSystem() {
      renderJobCategories();
    }

    function renderJobCategories() {
      const container = document.getElementById('categories-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      jobCategories.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = `bg-gradient-to-br ${category.color} rounded-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl`;
        categoryCard.onclick = () => openCategoryModal(category);
        
        categoryCard.innerHTML = `
          <div class="text-4xl mb-4">${category.icon}</div>
          <h3 class="text-xl font-bold mb-2">${category.name}</h3>
          <p class="text-sm opacity-90 mb-4">${category.positions.length} positions available</p>
          <div class="flex justify-between items-center">
            <span class="text-sm font-medium">View Positions ‚Üí</span>
            <div class="bg-white bg-opacity-20 rounded-full px-3 py-1 text-xs font-bold">
              ${category.positions.length}
            </div>
          </div>
        `;
        
        container.appendChild(categoryCard);
      });
    }

    function openCategoryModal(category) {
      // Create modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.onclick = (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      };
      
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col';
      
      modalContent.innerHTML = `
        <div class="bg-gradient-to-r ${category.color} text-white p-6">
          <div class="flex justify-between items-center">
            <div class="flex items-center space-x-4">
              <div class="text-3xl">${category.icon}</div>
              <div>
                <h2 class="text-2xl font-bold">${category.name}</h2>
                <p class="opacity-90">${category.positions.length} positions in this category</p>
              </div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200 text-2xl font-bold">√ó</button>
          </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
          <div class="grid gap-4">
            ${category.positions.map(position => `
              <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="openJobDescription('${position.code}')">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <h3 class="font-bold text-lg text-gray-900">${position.title}</h3>
                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                      <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${position.level}</span>
                      <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">${position.department}</span>
                      <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full">${position.code}</span>
                    </div>
                  </div>
                  <div class="text-blue-600 hover:text-blue-800">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }

    function openJobDescription(jobCode) {
      const jobTemplate = jobDescriptionTemplates[jobCode];
      
      if (!jobTemplate) {
        // Create a generic template for positions without detailed descriptions
        const position = findPositionByCode(jobCode);
        if (!position) return;
        
        showGenericJobDescription(position);
        return;
      }
      
      // Create detailed job description modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.onclick = (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      };
      
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col';
      
      modalContent.innerHTML = `
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl font-bold mb-2">${jobTemplate.title}</h2>
              <div class="flex items-center space-x-4 text-sm">
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">${jobTemplate.department}</span>
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">${jobTemplate.level}</span>
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">Reports to: ${jobTemplate.reportsTo}</span>
              </div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200 text-2xl font-bold">√ó</button>
          </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
          <!-- Job Summary -->
          <div>
            <h3 class="text-lg font-bold text-gray-900 mb-3">Position Summary</h3>
            <p class="text-gray-700 leading-relaxed">${jobTemplate.summary}</p>
          </div>
          
          <!-- Key Responsibilities -->
          <div>
            <h3 class="text-lg font-bold text-gray-900 mb-3">Key Responsibilities</h3>
            <ul class="space-y-2">
              ${jobTemplate.responsibilities.map(resp => `
                <li class="flex items-start space-x-2">
                  <span class="text-blue-600 mt-1">‚Ä¢</span>
                  <span class="text-gray-700">${resp}</span>
                </li>
              `).join('')}
            </ul>
          </div>
          
          <!-- Qualifications -->
          <div>
            <h3 class="text-lg font-bold text-gray-900 mb-3">Required Qualifications</h3>
            <ul class="space-y-2">
              ${jobTemplate.qualifications.map(qual => `
                <li class="flex items-start space-x-2">
                  <span class="text-green-600 mt-1">‚úì</span>
                  <span class="text-gray-700">${qual}</span>
                </li>
              `).join('')}
            </ul>
          </div>
          
          <!-- Key Skills -->
          <div>
            <h3 class="text-lg font-bold text-gray-900 mb-3">Key Skills & Competencies</h3>
            <div class="flex flex-wrap gap-2">
              ${jobTemplate.skills.map(skill => `
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">${skill}</span>
              `).join('')}
            </div>
          </div>
        </div>
        
        <div class="border-t bg-gray-50 p-4 flex justify-end space-x-3">
          <button onclick="exportJobDescription('${jobCode}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            üìÑ Export PDF
          </button>
          <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            Close
          </button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }

    function findPositionByCode(code) {
      for (const category of jobCategories) {
        const position = category.positions.find(p => p.code === code);
        if (position) return position;
      }
      return null;
    }

    function showGenericJobDescription(position) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
      modal.onclick = (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      };
      
      const modalContent = document.createElement('div');
      modalContent.className = 'bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col';
      
      modalContent.innerHTML = `
        <div class="bg-gradient-to-r from-gray-600 to-gray-800 text-white p-6">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl font-bold mb-2">${position.title}</h2>
              <div class="flex items-center space-x-4 text-sm">
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">${position.department}</span>
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">${position.level}</span>
                <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full">${position.code}</span>
              </div>
            </div>
            <button onclick="this.closest('.fixed').remove()" class="text-white hover:text-gray-200 text-2xl font-bold">√ó</button>
          </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 text-center">
          <div class="text-6xl mb-4">üìã</div>
          <h3 class="text-xl font-bold text-gray-900 mb-4">Job Description Template</h3>
          <p class="text-gray-600 mb-6">Detailed job description for ${position.title} is currently being developed.</p>
          <p class="text-sm text-gray-500">This position is available in the ${position.department} department at the ${position.level} level.</p>
        </div>
        
        <div class="border-t bg-gray-50 p-4 flex justify-center">
          <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
            Close
          </button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
    }

    function exportJobDescription(jobCode) {
      const jobTemplate = jobDescriptionTemplates[jobCode];
      if (!jobTemplate) return;
      
      // Create a simple text export (in a real app, this would generate a PDF)
      let content = `JOB DESCRIPTION\n\n`;
      content += `Position: ${jobTemplate.title}\n`;
      content += `Department: ${jobTemplate.department}\n`;
      content += `Level: ${jobTemplate.level}\n`;
      content += `Reports To: ${jobTemplate.reportsTo}\n\n`;
      content += `POSITION SUMMARY\n${jobTemplate.summary}\n\n`;
      content += `KEY RESPONSIBILITIES\n`;
      jobTemplate.responsibilities.forEach((resp, index) => {
        content += `${index + 1}. ${resp}\n`;
      });
      content += `\nREQUIRED QUALIFICATIONS\n`;
      jobTemplate.qualifications.forEach((qual, index) => {
        content += `${index + 1}. ${qual}\n`;
      });
      content += `\nKEY SKILLS\n`;
      content += jobTemplate.skills.join(', ');
      
      // Create and download file
      const blob = new Blob([content], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${jobTemplate.title.replace(/\s+/g, '_')}_Job_Description.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showActionFeedback(`üìÑ Exported: ${jobTemplate.title} Job Description`);
    }

    // Formal Org Chart Rendering System
    function renderOrgChart() {
      const chartContainer = document.getElementById('org-chart');
      chartContainer.innerHTML = '';
      
      // Clear existing connections
      clearConnections();
      
      // Render nodes for current page
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      currentPageNodes.forEach(nodeId => {
        const node = orgChartData.nodes.find(n => n.id === nodeId);
        if (node) {
          renderOrgNode(node);
        }
      });
      
      // Draw connections after a short delay
      setTimeout(() => {
        drawOrgConnections();
      }, 100);
    }

    function renderOrgNode(node) {
      const chartContainer = document.getElementById('org-chart');
      
      const nodeElement = document.createElement('div');
      nodeElement.className = `org-node ${node.type === 'org-unit' ? 'org-unit-box' : 'position-box'} color-${node.color} size-${node.size}`;
      nodeElement.id = `org-node-${node.id}`;
      nodeElement.style.left = `${node.x}px`;
      nodeElement.style.top = `${node.y}px`;
      
      // Make draggable in edit mode
      if (orgEditMode) {
        nodeElement.draggable = true;
        nodeElement.style.cursor = 'move';
      }
      
      // Only show title, no level display
      nodeElement.innerHTML = `
        <div class="text-center h-full flex flex-col justify-center">
          <div class="font-semibold leading-tight">${node.title}</div>
        </div>
        ${node.hasChildren ? '<div class="expandable-indicator" onclick="expandNode(\'' + node.id + '\')">+</div>' : ''}
        <div class="connection-anchor top" data-anchor="top" onclick="handleAnchorClick(event, '${node.id}', 'top')"></div>
        <div class="connection-anchor bottom" data-anchor="bottom" onclick="handleAnchorClick(event, '${node.id}', 'bottom')"></div>
        <div class="connection-anchor left" data-anchor="left" onclick="handleAnchorClick(event, '${node.id}', 'left')"></div>
        <div class="connection-anchor right" data-anchor="right" onclick="handleAnchorClick(event, '${node.id}', 'right')"></div>
      `;
      
      // Add click handler
      nodeElement.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (connectionMode) {
          handleConnectionClick(node);
        } else {
          selectOrgNode(node);
        }
      });
      
      // Add double-click handler for properties
      nodeElement.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        if (orgEditMode) {
          openNodePropertiesModal(node);
        }
      });
      
      // Add drag handlers - always enabled for maximum freedom
      let isDragging = false;
      let startX, startY, initialX, initialY;
      
      nodeElement.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('expandable-indicator')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialX = node.x;
        initialY = node.y;
        nodeElement.style.zIndex = '1000';
        nodeElement.style.cursor = 'grabbing';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        const newX = Math.max(0, initialX + deltaX);
        const newY = Math.max(0, initialY + deltaY);
        
        nodeElement.style.left = `${newX}px`;
        nodeElement.style.top = `${newY}px`;
        
        // Update node data immediately
        node.x = newX;
        node.y = newY;
        
        // Real-time connection updates
        clearConnections();
        drawOrgConnections();
      });
      
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          nodeElement.style.zIndex = '';
          nodeElement.style.cursor = orgEditMode ? 'move' : 'pointer';
          
          // Save state after drag operation
          saveState(`Move ${node.title}`);
        }
      });
      
      // Always show move cursor when hovering
      nodeElement.style.cursor = orgEditMode ? 'move' : 'pointer';
      nodeElement.addEventListener('mouseenter', () => {
        if (!isDragging) {
          nodeElement.style.cursor = 'grab';
        }
      });
      
      nodeElement.addEventListener('mouseleave', () => {
        if (!isDragging) {
          nodeElement.style.cursor = orgEditMode ? 'move' : 'pointer';
        }
      });
      
      chartContainer.appendChild(nodeElement);
    }

    function drawOrgConnections() {
      const chartContainer = document.getElementById('org-chart');
      
      // Get current page nodes
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      
      // Draw hierarchy connections
      currentPageNodes.forEach(nodeId => {
        const node = orgChartData.nodes.find(n => n.id === nodeId);
        if (node && node.parent) {
          // Check if parent is also on current page
          if (currentPageNodes.includes(node.parent)) {
            drawFormalConnection(node.id, node.parent, 'hierarchy');
          }
        }
      });
      
      // Draw custom connections
      customConnections.forEach(connection => {
        if (currentPageNodes.includes(connection.from) && currentPageNodes.includes(connection.to)) {
          drawFormalConnection(connection.from, connection.to, 'custom');
        }
      });
    }

    function drawFormalConnection(fromId, toId, connectionType = 'hierarchy') {
      // For hierarchy connections, fromId is child, toId is parent
      // For custom connections, fromId and toId are just endpoints
      const childId = connectionType === 'hierarchy' ? fromId : fromId;
      const parentId = connectionType === 'hierarchy' ? toId : toId;
      const childElement = document.getElementById(`org-node-${childId}`);
      const parentElement = document.getElementById(`org-node-${parentId}`);
      
      if (!childElement || !parentElement) return;
      
      const chartContainer = document.getElementById('org-chart');
      const chartRect = chartContainer.getBoundingClientRect();
      
      // Get positions relative to chart container
      const childRect = childElement.getBoundingClientRect();
      const parentRect = parentElement.getBoundingClientRect();
      
      const childX = childRect.left - chartRect.left + childRect.width / 2;
      const childY = childRect.top - chartRect.top;
      const parentX = parentRect.left - chartRect.left + parentRect.width / 2;
      const parentY = parentRect.top - chartRect.top + parentRect.height;
      
      // Style connections differently based on type
      const connectionClass = connectionType === 'custom' ? 'org-connection-custom' : 'org-connection-line';
      const pointClass = connectionType === 'custom' ? 'org-connection-custom-point' : 'org-connection-point';
      
      // Add dotted style if selected
      const dottedClass = currentLineStyle === 'dotted' ? ' org-connection-dotted' : '';
      
      // For board level connections, use different approach to avoid overlap
      const parentNode = orgChartData.nodes.find(n => n.id === parentId);
      const childNode = orgChartData.nodes.find(n => n.id === childId);
      
      if (parentNode && parentNode.level === 0 && connectionType === 'hierarchy') {
        // Special handling for board connections - proper T-junction routing
        
        // For IA and CorpGov (level 0.5), connect directly to board center
        if (childNode && childNode.level === 0.5) {
          // Create a T-junction below the board
          const junctionY = parentY + 30; // Junction point below board
          
          // Vertical line from board down to junction level
          const boardVertical = document.createElement('div');
          boardVertical.className = `${connectionClass} org-connection-vertical${dottedClass}`;
          boardVertical.style.left = `${parentX - 1}px`;
          boardVertical.style.top = `${parentY}px`;
          boardVertical.style.height = `${junctionY - parentY}px`;
          boardVertical.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Horizontal line from board center to child position
          const horizontalConnector = document.createElement('div');
          horizontalConnector.className = `${connectionClass} org-connection-horizontal${dottedClass}`;
          horizontalConnector.style.left = `${Math.min(parentX, childX)}px`;
          horizontalConnector.style.top = `${junctionY - 1}px`;
          horizontalConnector.style.width = `${Math.abs(childX - parentX) + 2}px`;
          horizontalConnector.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Vertical line from junction down to child
          const childVertical = document.createElement('div');
          childVertical.className = `${connectionClass} org-connection-vertical${dottedClass}`;
          childVertical.style.left = `${childX - 1}px`;
          childVertical.style.top = `${junctionY}px`;
          childVertical.style.height = `${childY - junctionY}px`;
          childVertical.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Connection points
          const parentPoint = document.createElement('div');
          parentPoint.className = pointClass;
          parentPoint.style.left = `${parentX}px`;
          parentPoint.style.top = `${parentY}px`;
          parentPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const junctionPoint = document.createElement('div');
          junctionPoint.className = pointClass;
          junctionPoint.style.left = `${parentX}px`;
          junctionPoint.style.top = `${junctionY}px`;
          junctionPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const childJunctionPoint = document.createElement('div');
          childJunctionPoint.className = pointClass;
          childJunctionPoint.style.left = `${childX}px`;
          childJunctionPoint.style.top = `${junctionY}px`;
          childJunctionPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const childPoint = document.createElement('div');
          childPoint.className = pointClass;
          childPoint.style.left = `${childX}px`;
          childPoint.style.top = `${childY}px`;
          childPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          chartContainer.appendChild(boardVertical);
          chartContainer.appendChild(horizontalConnector);
          chartContainer.appendChild(childVertical);
          chartContainer.appendChild(parentPoint);
          chartContainer.appendChild(junctionPoint);
          chartContainer.appendChild(childJunctionPoint);
          chartContainer.appendChild(childPoint);
        } else {
          // For CEO and other direct board reports
          const junctionY = parentY + 50; // Lower junction for CEO
          
          // Vertical line from board down to junction
          const boardVertical = document.createElement('div');
          boardVertical.className = `${connectionClass} org-connection-vertical${dottedClass}`;
          boardVertical.style.left = `${parentX - 1}px`;
          boardVertical.style.top = `${parentY}px`;
          boardVertical.style.height = `${junctionY - parentY}px`;
          boardVertical.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Horizontal line (if needed)
          if (Math.abs(childX - parentX) > 5) {
            const horizontalConnector = document.createElement('div');
            horizontalConnector.className = `${connectionClass} org-connection-horizontal${dottedClass}`;
            horizontalConnector.style.left = `${Math.min(parentX, childX)}px`;
            horizontalConnector.style.top = `${junctionY - 1}px`;
            horizontalConnector.style.width = `${Math.abs(childX - parentX) + 2}px`;
            horizontalConnector.onclick = () => handleLineClick(fromId, toId, connectionType);
            chartContainer.appendChild(horizontalConnector);
          }
          
          // Vertical line to child
          const childVertical = document.createElement('div');
          childVertical.className = `${connectionClass} org-connection-vertical${dottedClass}`;
          childVertical.style.left = `${childX - 1}px`;
          childVertical.style.top = `${junctionY}px`;
          childVertical.style.height = `${childY - junctionY}px`;
          childVertical.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Connection points
          const parentPoint = document.createElement('div');
          parentPoint.className = pointClass;
          parentPoint.style.left = `${parentX}px`;
          parentPoint.style.top = `${parentY}px`;
          parentPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const junctionPoint = document.createElement('div');
          junctionPoint.className = pointClass;
          junctionPoint.style.left = `${parentX}px`;
          junctionPoint.style.top = `${junctionY}px`;
          junctionPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          if (Math.abs(childX - parentX) > 5) {
            const childJunctionPoint = document.createElement('div');
            childJunctionPoint.className = pointClass;
            childJunctionPoint.style.left = `${childX}px`;
            childJunctionPoint.style.top = `${junctionY}px`;
            childJunctionPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
            chartContainer.appendChild(childJunctionPoint);
          }
          
          const childPoint = document.createElement('div');
          childPoint.className = pointClass;
          childPoint.style.left = `${childX}px`;
          childPoint.style.top = `${childY}px`;
          childPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          chartContainer.appendChild(boardVertical);
          chartContainer.appendChild(childVertical);
          chartContainer.appendChild(parentPoint);
          chartContainer.appendChild(junctionPoint);
          chartContainer.appendChild(childPoint);
        }
      } else {
        // Standard connection for other levels
        const midY = parentY + (childY - parentY) / 2;
        
        // For custom connections, use direct line approach
        if (connectionType === 'custom') {
          // Simple direct line for custom connections
          const directLine = document.createElement('div');
          directLine.className = `${connectionClass} org-connection-horizontal${dottedClass}`;
          
          const angle = Math.atan2(childY - parentY, childX - parentX) * 180 / Math.PI;
          const length = Math.sqrt(Math.pow(childX - parentX, 2) + Math.pow(childY - parentY, 2));
          
          directLine.style.left = `${parentX}px`;
          directLine.style.top = `${parentY - 1}px`;
          directLine.style.width = `${length}px`;
          directLine.style.transformOrigin = '0 50%';
          directLine.style.transform = `rotate(${angle}deg)`;
          directLine.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Connection points for custom connections
          const startPoint = document.createElement('div');
          startPoint.className = pointClass;
          startPoint.style.left = `${parentX}px`;
          startPoint.style.top = `${parentY}px`;
          startPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const endPoint = document.createElement('div');
          endPoint.className = pointClass;
          endPoint.style.left = `${childX}px`;
          endPoint.style.top = `${childY}px`;
          endPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          chartContainer.appendChild(directLine);
          chartContainer.appendChild(startPoint);
          chartContainer.appendChild(endPoint);
        } else {
          // Standard T-junction for hierarchy connections
          const midY = parentY + (childY - parentY) / 2;
          
          // Create vertical line from parent (downward)
          const verticalLine1 = document.createElement('div');
          verticalLine1.className = `${connectionClass} org-connection-vertical${dottedClass}`;
          verticalLine1.style.left = `${parentX - 1}px`;
          verticalLine1.style.top = `${parentY}px`;
          verticalLine1.style.height = `${midY - parentY}px`;
          verticalLine1.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Create horizontal line (connecting line)
          const horizontalLine = document.createElement('div');
          horizontalLine.className = `${connectionClass} org-connection-horizontal${dottedClass}`;
          horizontalLine.style.left = `${Math.min(parentX, childX)}px`;
          horizontalLine.style.top = `${midY - 1}px`;
          horizontalLine.style.width = `${Math.abs(childX - parentX) + 2}px`;
          horizontalLine.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Create vertical line to child (downward)
          const verticalLine2 = document.createElement('div');
          verticalLine2.className = `${connectionClass} org-connection-vertical${dottedClass}`;
          verticalLine2.style.left = `${childX - 1}px`;
          verticalLine2.style.top = `${midY}px`;
          verticalLine2.style.height = `${childY - midY}px`;
          verticalLine2.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Create formal connection points
          const parentPoint = document.createElement('div');
          parentPoint.className = pointClass;
          parentPoint.style.left = `${parentX}px`;
          parentPoint.style.top = `${parentY}px`;
          parentPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const junctionPoint = document.createElement('div');
          junctionPoint.className = pointClass;
          junctionPoint.style.left = `${parentX}px`;
          junctionPoint.style.top = `${midY}px`;
          junctionPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const childJunctionPoint = document.createElement('div');
          childJunctionPoint.className = pointClass;
          childJunctionPoint.style.left = `${childX}px`;
          childJunctionPoint.style.top = `${midY}px`;
          childJunctionPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          const childPoint = document.createElement('div');
          childPoint.className = pointClass;
          childPoint.style.left = `${childX}px`;
          childPoint.style.top = `${childY}px`;
          childPoint.onclick = () => handleLineClick(fromId, toId, connectionType);
          
          // Add to container
          chartContainer.appendChild(verticalLine1);
          chartContainer.appendChild(horizontalLine);
          chartContainer.appendChild(verticalLine2);
          chartContainer.appendChild(parentPoint);
          chartContainer.appendChild(junctionPoint);
          chartContainer.appendChild(childJunctionPoint);
          chartContainer.appendChild(childPoint);
        }

      }
    }

    // Handle line clicks for deletion
    function handleLineClick(fromId, toId, connectionType) {
      if (!orgEditMode) return;
      
      const fromNode = orgChartData.nodes.find(n => n.id === fromId);
      const toNode = orgChartData.nodes.find(n => n.id === toId);
      
      if (connectionType === 'hierarchy') {
        // For hierarchy connections, ask for confirmation
        if (confirm(`Remove hierarchy connection between "${fromNode.title}" and "${toNode.title}"?\n\nThis will make "${fromNode.title}" a top-level node.`)) {
          saveState('Remove Hierarchy Connection');
          
          // Remove parent relationship
          fromNode.parent = null;
          
          // Re-render chart
          renderOrgChart();
          showActionFeedback(`üóëÔ∏è Removed hierarchy: ${fromNode.title} ‚Üî ${toNode.title}`);
        }
      } else {
        // For custom connections, remove directly
        saveState('Remove Custom Connection');
        
        customConnections = customConnections.filter(conn => 
          !((conn.from === fromId && conn.to === toId) || 
            (conn.from === toId && conn.to === fromId))
        );
        
        // Re-render chart
        renderOrgChart();
        showActionFeedback(`üóëÔ∏è Removed connection: ${fromNode.title} ‚Üî ${toNode.title}`);
      }
    }

    function clearConnections() {
      const chartContainer = document.getElementById('org-chart');
      const connections = chartContainer.querySelectorAll('.org-connection-line, .org-connection-point, .org-connection-custom, .org-connection-custom-point');
      connections.forEach(conn => conn.remove());
    }

    function selectOrgNode(node) {
      // Clear previous selection
      document.querySelectorAll('.org-node-selected').forEach(el => {
        el.classList.remove('org-node-selected');
      });
      
      // Select new node
      const nodeElement = document.getElementById(`org-node-${node.id}`);
      nodeElement.classList.add('org-node-selected');
      
      selectedNode = node;
    }

    function expandNode(nodeId) {
      const node = orgChartData.nodes.find(n => n.id === nodeId);
      if (!node || !node.hasChildren) return;
      
      // Create new page for this node's children
      const newPageId = `${nodeId}-details`;
      
      // Check if page already exists
      if (!orgChartData.pages[newPageId]) {
        // Create sample children for demonstration with proper spacing
        const childNodes = [
          {
            id: `${nodeId}-dept1`,
            title: `${node.title.replace('Chief ', '').replace(' Officer', '')} - Department A`,
            parent: `${nodeId}-parent`,
            type: 'org-unit',
            color: 'white',
            size: 'medium',
            level: 2,
            x: 150,
            y: 250,
            hasChildren: false
          },
          {
            id: `${nodeId}-dept2`,
            title: `${node.title.replace('Chief ', '').replace(' Officer', '')} - Department B`,
            parent: `${nodeId}-parent`,
            type: 'org-unit',
            color: 'white',
            size: 'medium',
            level: 2,
            x: 400,
            y: 250,
            hasChildren: false
          },
          {
            id: `${nodeId}-dept3`,
            title: `${node.title.replace('Chief ', '').replace(' Officer', '')} - Department C`,
            parent: `${nodeId}-parent`,
            type: 'org-unit',
            color: 'white',
            size: 'medium',
            level: 2,
            x: 650,
            y: 250,
            hasChildren: false
          }
        ];
        
        // Add parent node to new page (copy of the expanded node)
        const parentNode = {
          id: `${nodeId}-parent`,
          title: node.title,
          parent: null,
          type: node.type,
          color: node.color,
          size: node.size,
          level: 1,
          x: 400,
          y: 80,
          hasChildren: false
        };
        
        // Add nodes to main data
        orgChartData.nodes.push(parentNode);
        orgChartData.nodes.push(...childNodes);
        
        // Create new page
        orgChartData.pages[newPageId] = {
          title: `${node.title} Structure`,
          nodes: [parentNode.id, ...childNodes.map(n => n.id)]
        };
      }
      
      // Switch to new page
      switchOrgTab(newPageId);
    }

    function switchOrgTab(pageId) {
      currentOrgPage = pageId;
      
      // Update tab UI
      updateOrgTabs();
      
      // Render chart for new page with smooth transition
      const chartContainer = document.getElementById('org-chart');
      chartContainer.classList.add('org-page-transition');
      
      setTimeout(() => {
        renderOrgChart();
        chartContainer.classList.add('active');
      }, 50);
      
      setTimeout(() => {
        chartContainer.classList.remove('org-page-transition');
      }, 450);
    }

    function updateOrgTabs() {
      const tabsContainer = document.getElementById('org-tabs');
      tabsContainer.innerHTML = '';
      
      Object.keys(orgChartData.pages).forEach(pageId => {
        const page = orgChartData.pages[pageId];
        const tab = document.createElement('div');
        tab.className = `org-tab ${pageId === currentOrgPage ? 'active' : ''}`;
        tab.onclick = () => switchOrgTab(pageId);
        
        const titleSpan = document.createElement('span');
        titleSpan.textContent = page.title;
        tab.appendChild(titleSpan);
        
        // Add close button for non-main tabs
        if (pageId !== 'main') {
          const closeBtn = document.createElement('span');
          closeBtn.innerHTML = '√ó';
          closeBtn.className = 'tab-close';
          closeBtn.onclick = (e) => {
            e.stopPropagation();
            closeOrgTab(pageId);
          };
          tab.appendChild(closeBtn);
        }
        
        tabsContainer.appendChild(tab);
      });
    }

    function closeOrgTab(pageId) {
      if (pageId === 'main') return; // Can't close main tab
      
      // Get page nodes before deletion
      const pageNodes = orgChartData.pages[pageId]?.nodes || [];
      
      // Remove page
      delete orgChartData.pages[pageId];
      
      // Remove associated nodes
      orgChartData.nodes = orgChartData.nodes.filter(node => !pageNodes.includes(node.id));
      
      // Switch to main tab if current tab is being closed
      if (currentOrgPage === pageId) {
        switchOrgTab('main');
      } else {
        updateOrgTabs();
      }
    }

    function handleAnchorClick(event, nodeId, anchor) {
      event.stopPropagation();
      
      if (!connectionMode) return;
      
      const node = orgChartData.nodes.find(n => n.id === nodeId);
      if (!node) return;
      
      if (!connectionStart) {
        // First click - select start node and anchor
        connectionStart = { nodeId: nodeId, anchor: anchor };
        
        // Visual feedback - highlight selected anchor
        document.querySelectorAll('.connection-anchor.active').forEach(el => {
          el.classList.remove('active');
        });
        
        event.target.classList.add('active');
        
        // Show feedback
        showActionFeedback(`üìç Selected ${node.title} (${anchor})`);
        
      } else if (connectionStart.nodeId === nodeId) {
        // Clicked same node - deselect
        connectionStart = null;
        document.querySelectorAll('.connection-anchor.active').forEach(el => {
          el.classList.remove('active');
        });
        showActionFeedback('‚ùå Connection cancelled');
        
      } else {
        // Second click - create connection
        const startNode = orgChartData.nodes.find(n => n.id === connectionStart.nodeId);
        const endNode = orgChartData.nodes.find(n => n.id === nodeId);
        
        const existingConnection = customConnections.find(conn => 
          (conn.from === connectionStart.nodeId && conn.to === nodeId) ||
          (conn.from === nodeId && conn.to === connectionStart.nodeId)
        );
        
        if (existingConnection) {
          // Remove existing connection
          saveState('Remove Custom Connection');
          customConnections = customConnections.filter(conn => conn !== existingConnection);
          showActionFeedback(`üóëÔ∏è Removed connection: ${startNode.title} ‚Üî ${endNode.title}`);
        } else {
          // Add new connection with anchor information
          saveState('Add Custom Connection');
          customConnections.push({
            from: connectionStart.nodeId,
            fromAnchor: connectionStart.anchor,
            to: nodeId,
            toAnchor: anchor,
            type: 'custom'
          });
          showActionFeedback(`üîó Connected: ${startNode.title} ‚Üí ${endNode.title}`);
        }
        
        // Reset selection
        connectionStart = null;
        document.querySelectorAll('.connection-anchor.active').forEach(el => {
          el.classList.remove('active');
        });
        
        // Redraw connections
        clearConnections();
        drawOrgConnections();
      }
    }
    
    function createNewPage() {
      const pageName = prompt('Enter page name:');
      if (!pageName || pageName.trim() === '') return;
      
      saveState('Create New Page');
      
      const pageId = `custom-${Date.now()}`;
      
      orgChartData.pages[pageId] = {
        title: pageName.trim(),
        nodes: []
      };
      
      // Update tabs and switch to new page
      updateOrgTabs();
      switchOrgTab(pageId);
      
      showActionFeedback(`üìÑ Created page: ${pageName}`);
    }

    // Edit Mode Functions
    function toggleEditMode() {
      orgEditMode = !orgEditMode;
      const btn = document.getElementById('edit-mode-btn');
      
      if (orgEditMode) {
        btn.textContent = '‚úÖ Exit Edit Mode';
        btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
      } else {
        btn.textContent = '‚úèÔ∏è Edit Mode';
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        
        // Clear selection
        document.querySelectorAll('.org-node-selected').forEach(el => {
          el.classList.remove('org-node-selected');
        });
        selectedNode = null;
      }
    }

    // Modal Functions
    function openAddNodeModal() {
      // Populate parent options
      const parentSelect = document.getElementById('new-node-parent');
      parentSelect.innerHTML = '<option value="">-- Top Level --</option>';
      
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      currentPageNodes.forEach(nodeId => {
        const node = orgChartData.nodes.find(n => n.id === nodeId);
        if (node) {
          const option = document.createElement('option');
          option.value = node.id;
          option.textContent = node.title;
          parentSelect.appendChild(option);
        }
      });
      
      document.getElementById('add-node-modal').classList.remove('hidden');
    }

    function closeAddNodeModal() {
      document.getElementById('add-node-modal').classList.add('hidden');
      // Reset form
      document.getElementById('new-node-title').value = '';
      document.getElementById('new-node-parent').value = '';
      document.getElementById('new-node-level').value = '1';
      document.getElementById('new-node-type').value = 'org-unit';
      document.getElementById('new-node-color').value = 'white';
      document.getElementById('new-node-size').value = 'medium';
    }

    function createNewOrgNode(event) {
      event.preventDefault();
      
      saveState('Add New Node');
      
      const title = document.getElementById('new-node-title').value;
      const parent = document.getElementById('new-node-parent').value || null;
      const level = parseFloat(document.getElementById('new-node-level').value);
      const type = document.getElementById('new-node-type').value;
      const color = document.getElementById('new-node-color').value;
      const size = document.getElementById('new-node-size').value;
      
      // Smart positioning based on parent and siblings
      let x, y;
      
      if (parent) {
        // Find parent node
        const parentNode = orgChartData.nodes.find(n => n.id === parent);
        if (parentNode) {
          // Find siblings (nodes with same parent)
          const siblings = orgChartData.nodes.filter(n => n.parent === parent && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
          
          // Position based on parent and siblings
          const siblingCount = siblings.length;
          const spacing = 200; // Space between siblings
          
          if (siblingCount === 0) {
            // First child - position directly below parent
            x = parentNode.x;
            y = parentNode.y + 150;
          } else {
            // Additional children - spread horizontally
            const totalWidth = (siblingCount + 1) * spacing;
            const startX = parentNode.x - (totalWidth / 2) + (spacing / 2);
            x = startX + (siblingCount * spacing);
            y = parentNode.y + 150;
          }
        } else {
          // Fallback if parent not found
          const levelNodes = orgChartData.nodes.filter(n => n.level === level && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
          x = 150 + (levelNodes.length * 200);
          y = 50 + (level * 150);
        }
      } else {
        // Top level node
        const levelNodes = orgChartData.nodes.filter(n => n.level === level && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
        x = 150 + (levelNodes.length * 200);
        y = 50 + (level * 150);
      }
      
      const newNode = {
        id: `node-${nodeIdCounter++}`,
        title: title,
        parent: parent,
        type: type,
        color: color,
        size: size,
        level: level,
        x: x,
        y: y,
        hasChildren: false
      };
      
      // Add to nodes
      orgChartData.nodes.push(newNode);
      
      // Add to current page
      orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      
      // Re-render chart
      renderOrgChart();
      
      closeAddNodeModal();
      showActionFeedback(`‚ûï Added: ${title}`);
    }

    function openNodePropertiesModal(node) {
      selectedNode = node;
      
      // Populate form
      document.getElementById('prop-node-title').value = node.title;
      document.getElementById('prop-node-parent').value = node.parent || '';
      document.getElementById('prop-node-level').value = node.level;
      document.getElementById('prop-node-type').value = node.type;
      document.getElementById('prop-node-color').value = node.color;
      document.getElementById('prop-node-size').value = node.size;
      
      // Populate parent options
      const parentSelect = document.getElementById('prop-node-parent');
      parentSelect.innerHTML = '<option value="">-- Top Level --</option>';
      
      orgChartData.nodes.forEach(n => {
        if (n.id !== node.id) { // Don't allow self-parenting
          const option = document.createElement('option');
          option.value = n.id;
          option.textContent = n.title;
          if (n.id === node.parent) option.selected = true;
          parentSelect.appendChild(option);
        }
      });
      
      document.getElementById('node-properties-modal').classList.remove('hidden');
    }

    function closeNodePropertiesModal() {
      document.getElementById('node-properties-modal').classList.add('hidden');
      selectedNode = null;
    }

    function updateNodeProperties(event) {
      event.preventDefault();
      
      if (!selectedNode) return;
      
      saveState('Update Node Properties');
      
      const title = document.getElementById('prop-node-title').value;
      const parent = document.getElementById('prop-node-parent').value || null;
      const level = parseInt(document.getElementById('prop-node-level').value);
      const type = document.getElementById('prop-node-type').value;
      const color = document.getElementById('prop-node-color').value;
      const size = document.getElementById('prop-node-size').value;
      
      // Find and update node
      const nodeIndex = orgChartData.nodes.findIndex(n => n.id === selectedNode.id);
      if (nodeIndex !== -1) {
        orgChartData.nodes[nodeIndex] = {
          ...orgChartData.nodes[nodeIndex],
          title: title,
          parent: parent,
          level: level,
          type: type,
          color: color,
          size: size
        };
      }
      
      // Re-render chart
      renderOrgChart();
      
      closeNodePropertiesModal();
      showActionFeedback(`‚úèÔ∏è Updated: ${title}`);
    }

    function deleteSelectedNode() {
      if (!selectedNode) return;
      
      if (confirm(`Are you sure you want to delete "${selectedNode.title}"?`)) {
        saveState('Delete Node');
        
        const nodeName = selectedNode.title;
        
        // Remove from nodes
        orgChartData.nodes = orgChartData.nodes.filter(n => n.id !== selectedNode.id);
        
        // Remove from all pages
        Object.keys(orgChartData.pages).forEach(pageId => {
          orgChartData.pages[pageId].nodes = orgChartData.pages[pageId].nodes.filter(nodeId => nodeId !== selectedNode.id);
        });
        
        // Remove any custom connections involving this node
        customConnections = customConnections.filter(conn => 
          conn.from !== selectedNode.id && conn.to !== selectedNode.id
        );
        
        // Re-render chart
        renderOrgChart();
        
        closeNodePropertiesModal();
        showActionFeedback(`üóëÔ∏è Deleted: ${nodeName}`);
      }
    }

    // Zoom functions
    function zoomOrgChart(direction) {
      if (direction === 'in') {
        orgZoomLevel = Math.min(orgZoomLevel + 0.1, 2);
      } else {
        orgZoomLevel = Math.max(orgZoomLevel - 0.1, 0.5);
      }
      
      const chartContainer = document.getElementById('org-chart');
      chartContainer.style.transform = `scale(${orgZoomLevel})`;
      chartContainer.style.transformOrigin = 'top left';
      
      document.getElementById('zoom-level').textContent = `${Math.round(orgZoomLevel * 100)}%`;
    }

    function resetOrgView() {
      orgZoomLevel = 1;
      const chartContainer = document.getElementById('org-chart');
      chartContainer.style.transform = 'scale(1)';
      document.getElementById('zoom-level').textContent = '100%';
    }

    // Quick Add Functions - Version 43 Style Easy Addition
    function quickAddOrgUnit() {
      saveState('Quick Add Org Unit');
      
      // Simple one-click addition under CEO with smart positioning
      const ceoNode = orgChartData.nodes.find(n => n.id === 'ceo');
      if (!ceoNode) return;
      
      // Count existing children under CEO
      const ceoChildren = orgChartData.nodes.filter(n => n.parent === 'ceo' && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
      const childIndex = ceoChildren.length;
      
      // Smart positioning - spread evenly under CEO
      const spacing = 200;
      const totalChildren = childIndex + 1;
      const totalWidth = totalChildren * spacing;
      const startX = ceoNode.x - (totalWidth / 2) + (spacing / 2);
      const x = startX + (childIndex * spacing);
      const y = ceoNode.y + 130; // Consistent spacing below CEO
      
      const newNode = {
        id: `unit-${nodeIdCounter++}`,
        title: `New Unit ${childIndex + 1}`,
        parent: 'ceo',
        type: 'org-unit',
        color: 'green',
        size: 'medium',
        level: 2,
        x: x,
        y: y,
        hasChildren: true
      };
      
      orgChartData.nodes.push(newNode);
      orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      
      renderOrgChart();
      showActionFeedback(`üè¢ Added: ${newNode.title}`);
      
      // Auto-select for immediate editing
      setTimeout(() => {
        selectOrgNode(newNode);
        if (confirm('Edit this unit now?')) {
          openNodePropertiesModal(newNode);
        }
      }, 100);
    }

    function quickAddPosition() {
      saveState('Quick Add Position');
      
      // Simple one-click addition under CEO with smart positioning
      const ceoNode = orgChartData.nodes.find(n => n.id === 'ceo');
      if (!ceoNode) return;
      
      // Count existing children under CEO
      const ceoChildren = orgChartData.nodes.filter(n => n.parent === 'ceo' && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
      const childIndex = ceoChildren.length;
      
      // Smart positioning - spread evenly under CEO
      const spacing = 200;
      const totalChildren = childIndex + 1;
      const totalWidth = totalChildren * spacing;
      const startX = ceoNode.x - (totalWidth / 2) + (spacing / 2);
      const x = startX + (childIndex * spacing);
      const y = ceoNode.y + 130; // Consistent spacing below CEO
      
      const newNode = {
        id: `pos-${nodeIdCounter++}`,
        title: `New Position ${childIndex + 1}`,
        parent: 'ceo',
        type: 'position',
        color: 'green',
        size: 'medium',
        level: 2,
        x: x,
        y: y,
        hasChildren: false
      };
      
      orgChartData.nodes.push(newNode);
      orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      
      renderOrgChart();
      showActionFeedback(`üë§ Added: ${newNode.title}`);
      
      // Auto-select for immediate editing
      setTimeout(() => {
        selectOrgNode(newNode);
        if (confirm('Edit this position now?')) {
          openNodePropertiesModal(newNode);
        }
      }, 100);
    }

    // Organization Templates
    const orgTemplates = {
      corporate: {
        name: 'Corporate Structure',
        nodes: [
          { id: 'board', title: 'Board of Directors', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'ceo', title: 'Chief Executive Officer', parent: 'board', type: 'org-unit', color: 'white', size: 'large', level: 2, x: 400, y: 180, hasChildren: true },
          { id: 'cfo', title: 'Chief Financial Officer', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 3, x: 200, y: 320, hasChildren: false },
          { id: 'coo', title: 'Chief Operating Officer', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 3, x: 400, y: 320, hasChildren: false },
          { id: 'cto', title: 'Chief Technology Officer', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 3, x: 600, y: 320, hasChildren: false }
        ]
      },
      functional: {
        name: 'Functional Organization',
        nodes: [
          { id: 'ceo', title: 'Chief Executive Officer', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'hr', title: 'Human Resources', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 150, y: 180, hasChildren: false },
          { id: 'finance', title: 'Finance', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 300, y: 180, hasChildren: false },
          { id: 'operations', title: 'Operations', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 450, y: 180, hasChildren: false },
          { id: 'marketing', title: 'Marketing', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 600, y: 180, hasChildren: false },
          { id: 'it', title: 'Information Technology', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 750, y: 180, hasChildren: false }
        ]
      },
      divisional: {
        name: 'Divisional Structure',
        nodes: [
          { id: 'ceo', title: 'Chief Executive Officer', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'div1', title: 'Consumer Division', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 2, x: 200, y: 180, hasChildren: true },
          { id: 'div2', title: 'Enterprise Division', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 2, x: 400, y: 180, hasChildren: true },
          { id: 'div3', title: 'International Division', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 2, x: 600, y: 180, hasChildren: true },
          { id: 'support', title: 'Corporate Support', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 800, y: 180, hasChildren: false }
        ]
      },
      matrix: {
        name: 'Matrix Organization',
        nodes: [
          { id: 'ceo', title: 'Chief Executive Officer', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'proj1', title: 'Project Alpha', parent: 'ceo', type: 'position', color: 'red', size: 'medium', level: 2, x: 200, y: 180, hasChildren: false },
          { id: 'proj2', title: 'Project Beta', parent: 'ceo', type: 'position', color: 'red', size: 'medium', level: 2, x: 400, y: 180, hasChildren: false },
          { id: 'proj3', title: 'Project Gamma', parent: 'ceo', type: 'position', color: 'red', size: 'medium', level: 2, x: 600, y: 180, hasChildren: false },
          { id: 'eng', title: 'Engineering', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 3, x: 150, y: 320, hasChildren: false },
          { id: 'design', title: 'Design', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 3, x: 350, y: 320, hasChildren: false },
          { id: 'qa', title: 'Quality Assurance', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 3, x: 550, y: 320, hasChildren: false }
        ]
      }
    };

    function applyOrgTemplate() {
      const templateSelect = document.getElementById('org-templates');
      const templateKey = templateSelect.value;
      
      if (!templateKey || !orgTemplates[templateKey]) {
        templateSelect.value = '';
        return;
      }
      
      if (!confirm(`Apply ${orgTemplates[templateKey].name} template? This will replace the current structure.`)) {
        templateSelect.value = '';
        return;
      }
      
      saveState('Apply Template');
      
      // Clear current nodes for main page
      orgChartData.pages[currentOrgPage].nodes = [];
      
      // Remove old nodes that were on main page
      orgChartData.nodes = orgChartData.nodes.filter(node => 
        !['board', 'ceo', 'audit', 'governance'].includes(node.id)
      );
      
      // Add template nodes
      const template = orgTemplates[templateKey];
      template.nodes.forEach(nodeTemplate => {
        const newNode = {
          ...nodeTemplate,
          id: nodeTemplate.id + '-' + Date.now() // Make unique
        };
        
        // Update parent references
        if (newNode.parent) {
          newNode.parent = newNode.parent + '-' + Date.now();
        }
        
        orgChartData.nodes.push(newNode);
        orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      });
      
      // Fix parent references
      orgChartData.nodes.forEach(node => {
        if (node.parent) {
          const parentNode = orgChartData.nodes.find(n => n.id.startsWith(node.parent.split('-')[0]));
          if (parentNode) {
            node.parent = parentNode.id;
          }
        }
      });
      
      // Re-render chart
      renderOrgChart();
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9717c80ff35d0399',t:'MTc1NTU4NjkwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
