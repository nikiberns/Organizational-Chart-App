<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PLDT Smart Org Design</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
          }
        }
      }
    }
  </script>
  <style>
    .active {
      background-color: #e0f2fe;
    }
    .active img {
      filter: brightness(0) saturate(100%) invert(59%) sepia(98%) saturate(1175%) hue-rotate(184deg) brightness(103%) contrast(101%);
    }
    
    /* Formal Org Chart Styles */
    .org-node {
      position: absolute;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      user-select: none;
      border-radius: 4px;
    }
    
    .org-node:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .org-node-selected {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5) !important;
      z-index: 100;
    }
    
    /* Box Types */
    .org-unit-box {
      border: 2px solid #374151;
      background: white;
    }
    
    .position-box {
      border: 2px dashed #374151;
      background: white;
    }
    
    /* Colors */
    .color-white { background: white; border-color: #374151; }
    .color-red { background: #fef2f2; border-color: #dc2626; }
    .color-green { background: #f0fdf4; border-color: #16a34a; }
    
    /* Box Sizes */
    .size-small { width: 120px; height: 60px; font-size: 11px; padding: 8px; }
    .size-medium { width: 160px; height: 80px; font-size: 12px; padding: 12px; }
    .size-large { width: 200px; height: 100px; font-size: 14px; padding: 16px; }
    
    /* Formal Connection Lines */
    .org-connection-line {
      position: absolute;
      background: #374151;
      z-index: 1;
    }
    
    .org-connection-vertical {
      width: 2px;
    }
    
    .org-connection-horizontal {
      height: 2px;
    }
    
    .org-connection-point {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #374151;
      border-radius: 50%;
      z-index: 2;
      transform: translate(-50%, -50%);
      border: 2px solid white;
    }
    
    /* Custom Connection Lines */
    .org-connection-custom {
      position: absolute;
      background: #dc2626;
      z-index: 1;
      opacity: 0.8;
    }
    
    .org-connection-custom.org-connection-vertical {
      width: 3px;
    }
    
    .org-connection-custom.org-connection-horizontal {
      height: 3px;
    }
    
    .org-connection-custom-point {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #dc2626;
      border-radius: 50%;
      z-index: 2;
      transform: translate(-50%, -50%);
      border: 2px solid white;
      cursor: pointer;
    }
    
    .org-connection-custom-point:hover {
      background: #b91c1c;
      transform: translate(-50%, -50%) scale(1.2);
    }
    
    /* Connection Mode Styles */
    .connection-mode-active {
      border: 3px dashed #3b82f6 !important;
      animation: pulse 2s infinite;
    }
    
    .connection-start-selected {
      border: 3px solid #10b981 !important;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3) !important;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Connection Anchor Points */
    .connection-anchor {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #3b82f6;
      border: 2px solid white;
      border-radius: 50%;
      cursor: crosshair;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .connection-anchor:hover {
      background: #2563eb;
      transform: scale(1.3);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .connection-anchor.active {
      background: #10b981;
      opacity: 1;
      animation: pulse-anchor 1.5s infinite;
    }
    
    .org-node:hover .connection-anchor,
    .connection-mode-active .connection-anchor {
      opacity: 1;
    }
    
    .connection-anchor.top { top: -6px; left: 50%; transform: translateX(-50%); }
    .connection-anchor.bottom { bottom: -6px; left: 50%; transform: translateX(-50%); }
    .connection-anchor.left { left: -6px; top: 50%; transform: translateY(-50%); }
    .connection-anchor.right { right: -6px; top: 50%; transform: translateY(-50%); }
    
    @keyframes pulse-anchor {
      0%, 100% { 
        opacity: 1; 
        transform: scale(1.3);
      }
      50% { 
        opacity: 0.7; 
        transform: scale(1.1);
      }
    }
    
    /* Org Chart Canvas */
    .org-canvas {
      position: relative;
      background: #f9fafb;
      background-image: 
        linear-gradient(rgba(0,0,0,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,.05) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 800px;
      overflow: auto;
    }
    
    /* Tab Navigation */
    .org-tab {
      padding: 12px 20px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: none;
      font-weight: 500;
      position: relative;
    }
    
    .org-tab:hover {
      background: #f3f4f6;
    }
    
    .org-tab.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .org-tab:first-child {
      border-top-left-radius: 8px;
    }
    
    .org-tab:last-child {
      border-top-right-radius: 8px;
    }
    
    /* Smooth Transitions */
    .org-page-transition {
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.4s ease;
    }
    
    .org-page-transition.active {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Expandable Node Indicator */
    .expandable-indicator {
      position: absolute;
      bottom: -10px;
      right: -10px;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.2s ease;
    }
    
    .expandable-indicator:hover {
      background: #2563eb;
      transform: scale(1.1);
    }
    
    /* Tab close button */
    .tab-close {
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    
    .tab-close:hover {
      background: rgba(239, 68, 68, 0.8);
      color: white;
    }
  </style>
</head>
<body class="bg-white text-gray-800 font-sans">
  <!-- Login Screen -->
  <div id="login-screen" class="min-h-screen bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
    <div class="bg-white p-8 rounded-xl shadow-lg w-80 border border-blue-200">
      <div class="text-center mb-8">
        <img id="login-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-10 sm:h-12 mx-auto mb-4 max-w-full object-contain" alt="Company Logo" />
        <h2 class="text-xl sm:text-2xl font-bold text-blue-900 mb-2">Organization Design Portal</h2>
        <p class="text-blue-600 text-sm">Please enter your credentials to continue</p>
      </div>
      
      <!-- Regular Login Form -->
      <div id="login-form">
        <form onsubmit="login(event)">
          <div class="mb-4">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Username</label>
            <input type="text" id="username" class="w-full px-3 py-2 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
            <div id="access-indicator" class="mt-2 text-sm font-medium hidden">
              <span id="admin-indicator" class="text-purple-600 hidden">üîë Administrator Access Detected</span>
              <span id="viewer-indicator" class="text-blue-600 hidden">üë§ Viewer Access</span>
            </div>
          </div>
          <div class="mb-6">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Password</label>
            <div class="relative">
              <input type="password" id="password" class="w-full px-3 py-2 pr-10 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
              <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-blue-600 hover:text-blue-800">
                <svg id="eye-icon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <svg id="eye-off-icon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                </svg>
              </button>
            </div>
          </div>
          <button type="submit" class="w-full bg-blue-900 text-white py-2 px-4 rounded-lg hover:bg-blue-800 transition duration-200 font-semibold shadow-md">
            Log In
          </button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="showPasswordReset()" class="text-blue-600 text-sm hover:text-blue-800 underline">
            Reset Password / Request Access
          </button>
        </div>
      </div>

      <!-- Password Reset Form -->
      <div id="reset-form" class="hidden">
        <div class="mb-6">
          <h3 class="text-xl font-bold text-blue-900 mb-2">Reset Password / Request Access</h3>
          <p class="text-blue-600 text-sm">Enter your username to reset password or request viewer access</p>
        </div>
        <form onsubmit="requestPasswordReset(event)">
          <div class="mb-5">
            <label class="block text-blue-900 text-sm font-semibold mb-2">Request Type</label>
            <select id="request-type" onchange="toggleRequestFields()" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50">
              <option value="reset">Reset Existing Password</option>
              <option value="access">Request New Viewer Access</option>
            </select>
          </div>
          
          <!-- Reset Password Fields -->
          <div id="reset-fields">
            <div class="mb-5">
              <label class="block text-blue-900 text-sm font-semibold mb-2">ID Number</label>
              <input type="text" id="reset-username" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" required>
            </div>
          </div>
          
          <!-- New Access Fields -->
          <div id="access-fields" class="hidden">
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Company Email</label>
              <input type="email" id="company-email" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="your.name@pldt.com.ph">
            </div>
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">ID Number</label>
              <input type="text" id="access-id-number" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Enter your employee ID">
            </div>
            <div class="mb-4">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Preferred Password</label>
              <input type="password" id="preferred-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Minimum 8 characters" minlength="8">
            </div>
            <div class="mb-5">
              <label class="block text-blue-900 text-sm font-semibold mb-2">Confirm Password</label>
              <input type="password" id="confirm-preferred-password" class="w-full px-4 py-3 border border-blue-200 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-blue-50" placeholder="Confirm your password" minlength="8">
            </div>
          </div>
          
          <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 font-semibold">
            Submit Request
          </button>
        </form>
        <div class="mt-4 text-center">
          <button onclick="showLoginForm()" class="text-blue-600 text-sm hover:text-blue-800 underline">
            ‚Üê Back to Login
          </button>
        </div>
      </div>

      <div id="login-error" class="mt-4 text-red-600 text-sm text-center hidden bg-red-50 p-3 rounded-lg border border-red-200">
        Invalid credentials. Please try again.
      </div>
      <div id="login-success" class="mt-4 text-green-600 text-sm text-center hidden bg-green-50 p-3 rounded-lg border border-green-200">
        Request submitted successfully!
      </div>
    </div>
  </div>

  <!-- Add Node Modal -->
  <div id="add-node-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Add New Node</h3>
        <button onclick="closeAddNodeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <form onsubmit="createNewOrgNode(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text" id="new-node-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reports To</label>
            <select id="new-node-parent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">-- Top Level --</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Level (for positioning only)</label>
            <select id="new-node-level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="0">Level 0 (Board)</option>
              <option value="0.5">Level 0.5 (Board Support)</option>
              <option value="1">Level 1 (CEO)</option>
              <option value="2" selected>Level 2 (C-Suite)</option>
              <option value="3">Level 3 (Directors)</option>
              <option value="4">Level 4 (Managers)</option>
              <option value="5">Level 5 (Supervisors)</option>
              <option value="6">Level 6 (Team Leads)</option>
              <option value="7">Level 7 (Senior Staff)</option>
              <option value="8">Level 8 (Staff)</option>
              <option value="9">Level 9 (Associates)</option>
              <option value="10">Level 10 (Entry Level)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="new-node-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="org-unit">Organization Unit (Solid Box)</option>
              <option value="position">Position (Dotted Box)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
            <select id="new-node-color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="white">White</option>
              <option value="red">Red</option>
              <option value="green">Green</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
            <select id="new-node-size" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeAddNodeModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Add Node
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Node Properties Modal -->
  <div id="node-properties-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Node Properties</h3>
        <button onclick="closeNodePropertiesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
      
      <form onsubmit="updateNodeProperties(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text" id="prop-node-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reports To</label>
            <select id="prop-node-parent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">-- Top Level --</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Level (for positioning only)</label>
            <select id="prop-node-level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="0">Level 0 (Board)</option>
              <option value="0.5">Level 0.5 (Board Support)</option>
              <option value="1">Level 1 (CEO)</option>
              <option value="2">Level 2 (C-Suite)</option>
              <option value="3">Level 3 (Directors)</option>
              <option value="4">Level 4 (Managers)</option>
              <option value="5">Level 5 (Supervisors)</option>
              <option value="6">Level 6 (Team Leads)</option>
              <option value="7">Level 7 (Senior Staff)</option>
              <option value="8">Level 8 (Staff)</option>
              <option value="9">Level 9 (Associates)</option>
              <option value="10">Level 10 (Entry Level)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
            <select id="prop-node-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="org-unit">Organization Unit (Solid Box)</option>
              <option value="position">Position (Dotted Box)</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
            <select id="prop-node-color" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="white">White</option>
              <option value="red">Red</option>
              <option value="green">Green</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
            <select id="prop-node-size" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="small">Small</option>
              <option value="medium">Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="deleteSelectedNode()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
            Delete
          </button>
          <button type="button" onclick="closeNodePropertiesModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Update
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Application -->
  <div id="main-app" class="flex h-screen hidden">
    <!-- Sidebar -->
    <div class="w-20 bg-white border-r flex flex-col items-center py-6 space-y-8 shadow-md h-full">
      <button onclick="navigate('home')" id="nav-home" class="p-3 rounded hover:bg-blue-100">
        <img id="home-icon" src="https://img.icons8.com/ios-filled/28/000000/home.png" alt="Home" />
      </button>
      <button onclick="navigate('org')" id="nav-org" class="p-3 rounded hover:bg-blue-100">
        <img id="org-icon" src="https://img.icons8.com/ios-filled/28/000000/organization.png" alt="Org Chart" />
      </button>
      <button onclick="navigate('jd')" id="nav-jd" class="p-3 rounded hover:bg-blue-100">
        <img id="jd-icon" src="https://img.icons8.com/ios-filled/28/000000/resume.png" alt="Job Description" />
      </button>
      <button onclick="navigate('admin')" id="nav-admin" class="p-3 rounded hover:bg-blue-100 hidden">
        <img id="admin-icon" src="https://img.icons8.com/ios-filled/28/000000/admin-settings-male.png" alt="Admin Panel" />
      </button>
      <div class="flex-1"></div>
      <div class="text-center">
        <div class="text-xs text-gray-500 mb-3" id="user-role">Admin</div>
        <button onclick="logout()" class="p-3 rounded hover:bg-red-100">
          <img id="logout-icon" src="https://img.icons8.com/ios-filled/28/000000/logout-rounded.png" alt="Logout" />
        </button>
      </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 p-6 overflow-y-auto">
      <!-- Home -->
      <div id="home" class="space-y-8 h-full flex flex-col">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <img id="company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-12 sm:h-16 max-w-full object-contain" alt="Company Logo" />
        </div>
        <h1 class="text-4xl font-bold text-blue-900 text-center mb-6">Organizational Design Portal</h1>
        <div class="flex flex-col space-y-4 max-w-2xl mx-auto w-full">
          <button onclick="navigate('org')" class="block w-full text-left px-6 py-6 rounded-lg bg-gradient-to-r from-red-200 to-orange-200 shadow-md hover:shadow-lg transition-shadow">
            <p class="text-xs uppercase font-medium text-gray-700">Converged View</p>
            <p class="text-xl font-bold text-gray-900 mt-1">Organizational Charts</p>
            <p class="text-gray-600 mt-1 text-sm">View and manage organizational hierarchy with formal chart structure</p>
          </button>
          <button onclick="navigate('jd')" class="block w-full text-left px-6 py-6 rounded-lg bg-gradient-to-r from-teal-200 to-green-200 shadow-md hover:shadow-lg transition-shadow">
            <p class="text-xs uppercase font-medium text-gray-700">Database</p>
            <p class="text-xl font-bold text-gray-900 mt-1">Job Description</p>
            <p class="text-gray-600 mt-1 text-sm">Browse positions by category and manage job descriptions</p>
          </button>
        </div>
      </div>

      <!-- Org Chart -->
      <div id="org" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="org-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Organizational Chart</h2>
          </div>
          <div class="flex items-center space-x-2">
            <div id="org-admin-controls" class="space-x-2 hidden">
              <button onclick="toggleEditMode()" id="edit-mode-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700">
                ‚úèÔ∏è Edit Mode
              </button>
            </div>
          </div>
        </div>
        
        <!-- Org Chart Tabs -->
        <div class="mb-4">
          <div class="flex border-b overflow-x-auto" id="org-tabs">
            <div class="org-tab active" onclick="switchOrgTab('main')">Main Structure</div>
          </div>
        </div>
        
        <!-- Org Chart Container -->
        <div class="w-full">
          <div id="org-chart-container" class="bg-white border rounded-lg overflow-hidden">
            <!-- Toolbar -->
            <div id="org-toolbar" class="bg-gray-50 border-b p-3 flex items-center justify-between hidden">
              <div class="flex items-center space-x-2 flex-wrap">
                <!-- Quick Add Buttons -->
                <div class="flex items-center space-x-2 border-r pr-3">
                  <button onclick="quickAddOrgUnit()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 flex items-center">
                    <span class="mr-1">üè¢</span> Add Org Unit
                  </button>
                  <button onclick="quickAddPosition()" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 flex items-center">
                    <span class="mr-1">üë§</span> Add Position
                  </button>
                </div>
                
                <!-- Templates -->
                <div class="flex items-center space-x-2 border-r pr-3">
                  <select id="org-templates" onchange="applyOrgTemplate()" class="px-2 py-1 border rounded text-sm">
                    <option value="">üìã Templates</option>
                    <option value="corporate">Corporate Structure</option>
                    <option value="functional">Functional Org</option>
                    <option value="divisional">Divisional Structure</option>
                    <option value="matrix">Matrix Organization</option>
                  </select>
                </div>
                
                <!-- Tools -->
                <div class="flex items-center space-x-2">
                  <button onclick="undo()" id="undo-btn" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Nothing to undo">
                    ‚Ü∂ Undo
                  </button>
                  <button onclick="redo()" id="redo-btn" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled title="Nothing to redo">
                    ‚Ü∑ Redo
                  </button>
                  <button onclick="toggleConnectionMode()" id="connection-mode-btn" class="bg-indigo-600 text-white px-2 py-1 rounded text-sm hover:bg-indigo-700">
                    üîó Connect Mode
                  </button>
                  <button onclick="autoLayout()" class="bg-purple-600 text-white px-2 py-1 rounded text-sm hover:bg-purple-700">
                    ‚ú® Auto Layout
                  </button>
                  <button onclick="createNewPage()" class="bg-orange-600 text-white px-2 py-1 rounded text-sm hover:bg-orange-700">
                    üìÑ New Page
                  </button>
                </div>
              </div>
              
              <div class="flex items-center space-x-2">
                <button onclick="zoomOrgChart('in')" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700">üîç+</button>
                <span id="zoom-level" class="text-sm text-gray-600">100%</span>
                <button onclick="zoomOrgChart('out')" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700">üîç-</button>
                <button onclick="resetOrgView()" class="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700">üéØ</button>
              </div>
            </div>
            
            <!-- Chart Canvas -->
            <div id="org-chart" class="org-canvas relative" style="height: 800px; width: 100%; min-width: 1200px;">
              <!-- Dynamic org chart will be generated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div id="admin" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="admin-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Admin Panel</h2>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- User Management Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <span class="text-blue-600 mr-2">üë•</span>
              User Management
            </h3>
            
            <!-- Password Reset Requests -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-800 mb-3 flex items-center justify-between">
                <span>üîë Password Reset Requests</span>
                <span id="reset-count" class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">0</span>
              </h4>
              <div id="admin-reset-requests" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-gray-500 text-sm">No pending reset requests</p>
              </div>
            </div>

            <!-- Access Requests -->
            <div class="mb-6">
              <h4 class="font-medium text-gray-800 mb-3 flex items-center justify-between">
                <span>üìù New Access Requests</span>
                <span id="access-count" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">0</span>
              </h4>
              <div id="admin-access-requests" class="space-y-2 max-h-40 overflow-y-auto">
                <p class="text-gray-500 text-sm">No pending access requests</p>
              </div>
            </div>
          </div>

          <!-- Approved Users Section -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
              <span class="flex items-center">
                <span class="text-green-600 mr-2">‚úÖ</span>
                Approved Users
              </span>
              <span id="approved-count" class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">0</span>
            </h3>
            
            <div id="admin-approved-users" class="space-y-2 max-h-80 overflow-y-auto">
              <p class="text-gray-500 text-sm">No approved users</p>
            </div>
          </div>
        </div>
      </div>

      <!-- JD Database -->
      <div id="jd" class="hidden">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
          <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap">
            <img id="jd-company-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/PLDT_Logo_2016.svg/2560px-PLDT_Logo_2016.svg.png" class="h-6 sm:h-8 max-w-full object-contain" alt="Company Logo" />
            <h2 class="text-lg sm:text-xl font-bold">Job Descriptions</h2>
          </div>
        </div>
        
        <div id="categories-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Categories will be dynamically generated here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let userLevel = null;
    let isPreviewMode = false;
    
    // User Management System with multi-level admin support
    let userManagement = {
      resetRequests: JSON.parse(localStorage.getItem('resetRequests') || '[]'),
      accessRequests: JSON.parse(localStorage.getItem('accessRequests') || '[]'),
      approvedUsers: JSON.parse(localStorage.getItem('approvedUsers') || '{}'),
      level1Password: localStorage.getItem('level1Password') || 'Hunter542639',
      level2Password: localStorage.getItem('level2Password') || 'PLDT_L2_Admin'
    };
    
    // Formal Org Chart System
    let orgChartData = {
      nodes: [
        { 
          id: 'board', 
          title: 'Board of Directors', 
          parent: null, 
          type: 'org-unit', 
          color: 'white', 
          size: 'large',
          level: 0,
          x: 400, 
          y: 50,
          hasChildren: true
        },
        { 
          id: 'audit', 
          title: 'Internal Audit', 
          parent: 'board', 
          type: 'org-unit', 
          color: 'red', 
          size: 'medium',
          level: 0.5,
          x: 200, 
          y: 150,
          hasChildren: false
        },
        { 
          id: 'governance', 
          title: 'Corporate Governance', 
          parent: 'board', 
          type: 'org-unit', 
          color: 'red', 
          size: 'medium',
          level: 0.5,
          x: 600, 
          y: 150,
          hasChildren: false
        },
        { 
          id: 'ceo', 
          title: 'President and CEO', 
          parent: 'board', 
          type: 'org-unit', 
          color: 'white', 
          size: 'large',
          level: 1,
          x: 400, 
          y: 250,
          hasChildren: true
        },
        { 
          id: 'cfo', 
          title: 'Chief Financial Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 150, 
          y: 380,
          hasChildren: true
        },
        { 
          id: 'coo', 
          title: 'Chief Operating Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 350, 
          y: 380,
          hasChildren: true
        },
        { 
          id: 'cto', 
          title: 'Chief Technology Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 550, 
          y: 380,
          hasChildren: true
        },
        { 
          id: 'chro', 
          title: 'Chief Human Resources Officer', 
          parent: 'ceo', 
          type: 'org-unit', 
          color: 'green', 
          size: 'medium',
          level: 2,
          x: 750, 
          y: 380,
          hasChildren: true
        }
      ],
      pages: {
        'main': {
          title: 'Main Structure',
          nodes: ['board', 'audit', 'governance', 'ceo', 'cfo', 'coo', 'cto', 'chro']
        }
      }
    };
    
    let currentOrgPage = 'main';
    let selectedNode = null;
    let orgEditMode = false;
    let orgZoomLevel = 1;
    let nodeIdCounter = 1000;
    let connectionMode = false;
    let connectionStart = null;
    let customConnections = []; // Store custom connections separate from hierarchy
    
    // Undo/Redo System
    let undoStack = [];
    let redoStack = [];
    let maxUndoSteps = 50;
    
    function saveState(action = 'Unknown Action') {
      const state = {
        action: action,
        timestamp: Date.now(),
        orgChartData: JSON.parse(JSON.stringify(orgChartData)),
        customConnections: JSON.parse(JSON.stringify(customConnections)),
        currentOrgPage: currentOrgPage
      };
      
      undoStack.push(state);
      
      // Limit undo stack size
      if (undoStack.length > maxUndoSteps) {
        undoStack.shift();
      }
      
      // Clear redo stack when new action is performed
      redoStack = [];
      
      updateUndoRedoButtons();
    }
    
    function undo() {
      if (undoStack.length === 0) return;
      
      // Save current state to redo stack
      const currentState = {
        action: 'Current State',
        timestamp: Date.now(),
        orgChartData: JSON.parse(JSON.stringify(orgChartData)),
        customConnections: JSON.parse(JSON.stringify(customConnections)),
        currentOrgPage: currentOrgPage
      };
      redoStack.push(currentState);
      
      // Restore previous state
      const previousState = undoStack.pop();
      orgChartData = JSON.parse(JSON.stringify(previousState.orgChartData));
      customConnections = JSON.parse(JSON.stringify(previousState.customConnections));
      currentOrgPage = previousState.currentOrgPage;
      
      // Update UI
      updateOrgTabs();
      renderOrgChart();
      updateUndoRedoButtons();
      
      // Show action feedback
      showActionFeedback(`‚Ü∂ Undid: ${previousState.action}`);
    }
    
    function redo() {
      if (redoStack.length === 0) return;
      
      // Save current state to undo stack
      const currentState = {
        action: 'Redo Point',
        timestamp: Date.now(),
        orgChartData: JSON.parse(JSON.stringify(orgChartData)),
        customConnections: JSON.parse(JSON.stringify(customConnections)),
        currentOrgPage: currentOrgPage
      };
      undoStack.push(currentState);
      
      // Restore next state
      const nextState = redoStack.pop();
      orgChartData = JSON.parse(JSON.stringify(nextState.orgChartData));
      customConnections = JSON.parse(JSON.stringify(nextState.customConnections));
      currentOrgPage = nextState.currentOrgPage;
      
      // Update UI
      updateOrgTabs();
      renderOrgChart();
      updateUndoRedoButtons();
      
      // Show action feedback
      showActionFeedback(`‚Ü∑ Redid: ${nextState.action}`);
    }
    
    function updateUndoRedoButtons() {
      const undoBtn = document.getElementById('undo-btn');
      const redoBtn = document.getElementById('redo-btn');
      
      if (undoBtn) {
        undoBtn.disabled = undoStack.length === 0;
        undoBtn.title = undoStack.length > 0 ? `Undo: ${undoStack[undoStack.length - 1].action}` : 'Nothing to undo';
      }
      
      if (redoBtn) {
        redoBtn.disabled = redoStack.length === 0;
        redoBtn.title = redoStack.length > 0 ? `Redo: ${redoStack[redoStack.length - 1].action}` : 'Nothing to redo';
      }
    }
    
    function showActionFeedback(message) {
      // Create or update feedback element
      let feedback = document.getElementById('action-feedback');
      if (!feedback) {
        feedback = document.createElement('div');
        feedback.id = 'action-feedback';
        feedback.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
        document.body.appendChild(feedback);
      }
      
      feedback.textContent = message;
      feedback.style.opacity = '1';
      feedback.style.transform = 'translateY(0)';
      
      // Auto-hide after 2 seconds
      setTimeout(() => {
        feedback.style.opacity = '0';
        feedback.style.transform = 'translateY(-20px)';
      }, 2000);
    }

    // Password visibility toggle
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById('password');
      const eyeIcon = document.getElementById('eye-icon');
      const eyeOffIcon = document.getElementById('eye-off-icon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.add('hidden');
        eyeOffIcon.classList.remove('hidden');
      } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('hidden');
        eyeOffIcon.classList.add('hidden');
      }
    }

    // Authentication with multi-level admin support
    function login(event) {
      event.preventDefault();
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value;
      const errorDiv = document.getElementById('login-error');

      let isValid = false;
      let accessLevel = 'viewer';
      let level = null;

      // Check Level 1 Admin (Full Access)
      if (username === 'ntbernal_ADMIN') {
        accessLevel = 'admin';
        level = 'level1';
        isValid = password === userManagement.level1Password;
      } 
      // Check Level 2 Admin (Limited Access)
      else if (username === 'ntbernal_LEVEL2') {
        accessLevel = 'admin';
        level = 'level2';
        isValid = password === userManagement.level2Password;
      } 
      // Check your viewer account
      else if (username === 'ntbernal') {
        accessLevel = 'viewer';
        level = 'viewer';
        isValid = password === 'PLDT_HR_OD';
      } 
      // Check approved users
      else if (username && userManagement.approvedUsers[username]) {
        accessLevel = 'viewer';
        level = 'viewer';
        isValid = password === userManagement.approvedUsers[username].password;
      }

      if (isValid) {
        currentUser = accessLevel;
        userLevel = level;
        isPreviewMode = false;
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        
        setupUserInterface();
        navigate('home');
        errorDiv.classList.add('hidden');
      } else {
        errorDiv.classList.remove('hidden');
        document.getElementById('password').value = '';
      }
    }

    // Setup user interface based on access level
    function setupUserInterface() {
      const roleText = isPreviewMode ? 'Preview Mode' : 
                      (userLevel === 'level1' ? 'Level 1 Admin' : 
                       userLevel === 'level2' ? 'Level 2 Admin' : 'Viewer');
      
      document.getElementById('user-role').textContent = roleText;
      
      // Show/hide controls based on user level and preview mode
      const isLevel1 = userLevel === 'level1' && !isPreviewMode;
      const isLevel2 = (userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode;
      const isAdmin = (userLevel === 'level1' || userLevel === 'level2') && !isPreviewMode;
      
      // Level 1 only controls
      document.getElementById('org-admin-controls').classList.toggle('hidden', !isLevel1);
      document.getElementById('nav-admin').classList.toggle('hidden', !isLevel1);
      document.getElementById('org-toolbar').classList.toggle('hidden', !isLevel1);
    }

    // Real-time access level detection based on username
    document.getElementById('username').addEventListener('input', function() {
      const username = this.value;
      const accessIndicator = document.getElementById('access-indicator');
      const adminIndicator = document.getElementById('admin-indicator');
      const viewerIndicator = document.getElementById('viewer-indicator');
      
      if (username === 'ntbernal_ADMIN') {
        accessIndicator.classList.remove('hidden');
        adminIndicator.classList.remove('hidden');
        adminIndicator.textContent = 'üîë Level 1 Administrator Access Detected';
        viewerIndicator.classList.add('hidden');
      } else if (username === 'ntbernal_LEVEL2') {
        accessIndicator.classList.remove('hidden');
        adminIndicator.classList.remove('hidden');
        adminIndicator.textContent = 'üîë Level 2 Administrator Access Detected';
        viewerIndicator.classList.add('hidden');
      } else if (username.length > 0) {
        accessIndicator.classList.remove('hidden');
        adminIndicator.classList.add('hidden');
        viewerIndicator.classList.remove('hidden');
      } else {
        accessIndicator.classList.add('hidden');
        adminIndicator.classList.add('hidden');
        viewerIndicator.classList.add('hidden');
      }
    });

    // Password Reset Functions
    function showPasswordReset() {
      document.getElementById('login-form').classList.add('hidden');
      document.getElementById('reset-form').classList.remove('hidden');
    }

    function toggleRequestFields() {
      const requestType = document.getElementById('request-type').value;
      const resetFields = document.getElementById('reset-fields');
      const accessFields = document.getElementById('access-fields');
      
      if (requestType === 'access') {
        resetFields.classList.add('hidden');
        accessFields.classList.remove('hidden');
      } else {
        resetFields.classList.remove('hidden');
        accessFields.classList.add('hidden');
      }
    }

    function showLoginForm() {
      document.getElementById('reset-form').classList.add('hidden');
      document.getElementById('login-form').classList.remove('hidden');
      document.getElementById('login-success').classList.add('hidden');
    }

    function requestPasswordReset(event) {
      event.preventDefault();
      document.getElementById('login-success').classList.remove('hidden');
      
      setTimeout(() => {
        showLoginForm();
      }, 2000);
    }

    function logout() {
      currentUser = null;
      userLevel = null;
      isPreviewMode = false;
      
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('password').value = '';
      document.getElementById('username').value = '';
      document.getElementById('login-error').classList.add('hidden');
      
      // Hide admin controls
      document.getElementById('org-admin-controls').classList.add('hidden');
      document.getElementById('nav-admin').classList.add('hidden');
      document.getElementById('org-toolbar').classList.add('hidden');
    }

    // Navigation
    function navigate(section) {
      const sections = ['home', 'org', 'jd', 'admin'];
      const navButtons = ['nav-home', 'nav-org', 'nav-jd', 'nav-admin'];

      sections.forEach(s => {
        document.getElementById(s).classList.add('hidden');
      });

      navButtons.forEach(btn => {
        document.getElementById(btn).classList.remove('active');
      });

      document.getElementById(section).classList.remove('hidden');
      document.getElementById('nav-' + section).classList.add('active');
      
      if (section === 'org') {
        renderOrgChart();
      }
    }

    // Formal Org Chart Rendering System
    function renderOrgChart() {
      const chartContainer = document.getElementById('org-chart');
      chartContainer.innerHTML = '';
      
      // Clear existing connections
      clearConnections();
      
      // Render nodes for current page
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      currentPageNodes.forEach(nodeId => {
        const node = orgChartData.nodes.find(n => n.id === nodeId);
        if (node) {
          renderOrgNode(node);
        }
      });
      
      // Draw connections after a short delay
      setTimeout(() => {
        drawOrgConnections();
      }, 100);
    }

    function renderOrgNode(node) {
      const chartContainer = document.getElementById('org-chart');
      
      const nodeElement = document.createElement('div');
      nodeElement.className = `org-node ${node.type === 'org-unit' ? 'org-unit-box' : 'position-box'} color-${node.color} size-${node.size}`;
      nodeElement.id = `org-node-${node.id}`;
      nodeElement.style.left = `${node.x}px`;
      nodeElement.style.top = `${node.y}px`;
      
      // Make draggable in edit mode
      if (orgEditMode) {
        nodeElement.draggable = true;
        nodeElement.style.cursor = 'move';
      }
      
      // Only show title, no level display
      nodeElement.innerHTML = `
        <div class="text-center h-full flex flex-col justify-center">
          <div class="font-semibold leading-tight">${node.title}</div>
        </div>
        ${node.hasChildren ? '<div class="expandable-indicator" onclick="expandNode(\'' + node.id + '\')">+</div>' : ''}
        <div class="connection-anchor top" data-anchor="top" onclick="handleAnchorClick(event, '${node.id}', 'top')"></div>
        <div class="connection-anchor bottom" data-anchor="bottom" onclick="handleAnchorClick(event, '${node.id}', 'bottom')"></div>
        <div class="connection-anchor left" data-anchor="left" onclick="handleAnchorClick(event, '${node.id}', 'left')"></div>
        <div class="connection-anchor right" data-anchor="right" onclick="handleAnchorClick(event, '${node.id}', 'right')"></div>
      `;
      
      // Add click handler
      nodeElement.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (connectionMode) {
          handleConnectionClick(node);
        } else {
          selectOrgNode(node);
        }
      });
      
      // Add double-click handler for properties
      nodeElement.addEventListener('dblclick', (e) => {
        e.stopPropagation();
        if (orgEditMode) {
          openNodePropertiesModal(node);
        }
      });
      
      // Add drag handlers - always enabled for maximum freedom
      let isDragging = false;
      let startX, startY, initialX, initialY;
      
      nodeElement.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('expandable-indicator')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialX = node.x;
        initialY = node.y;
        nodeElement.style.zIndex = '1000';
        nodeElement.style.cursor = 'grabbing';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        const newX = Math.max(0, initialX + deltaX);
        const newY = Math.max(0, initialY + deltaY);
        
        nodeElement.style.left = `${newX}px`;
        nodeElement.style.top = `${newY}px`;
        
        // Update node data immediately
        node.x = newX;
        node.y = newY;
        
        // Real-time connection updates
        clearConnections();
        drawOrgConnections();
      });
      
      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          nodeElement.style.zIndex = '';
          nodeElement.style.cursor = orgEditMode ? 'move' : 'pointer';
          
          // Save state after drag operation
          saveState(`Move ${node.title}`);
        }
      });
      
      // Always show move cursor when hovering
      nodeElement.style.cursor = orgEditMode ? 'move' : 'pointer';
      nodeElement.addEventListener('mouseenter', () => {
        if (!isDragging) {
          nodeElement.style.cursor = 'grab';
        }
      });
      
      nodeElement.addEventListener('mouseleave', () => {
        if (!isDragging) {
          nodeElement.style.cursor = orgEditMode ? 'move' : 'pointer';
        }
      });
      
      chartContainer.appendChild(nodeElement);
    }

    function drawOrgConnections() {
      const chartContainer = document.getElementById('org-chart');
      
      // Get current page nodes
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      
      // Draw hierarchy connections
      currentPageNodes.forEach(nodeId => {
        const node = orgChartData.nodes.find(n => n.id === nodeId);
        if (node && node.parent) {
          // Check if parent is also on current page
          if (currentPageNodes.includes(node.parent)) {
            drawFormalConnection(node.id, node.parent, 'hierarchy');
          }
        }
      });
      
      // Draw custom connections
      customConnections.forEach(connection => {
        if (currentPageNodes.includes(connection.from) && currentPageNodes.includes(connection.to)) {
          drawFormalConnection(connection.from, connection.to, 'custom');
        }
      });
    }

    function drawFormalConnection(fromId, toId, connectionType = 'hierarchy') {
      // For hierarchy connections, fromId is child, toId is parent
      // For custom connections, fromId and toId are just endpoints
      const childId = connectionType === 'hierarchy' ? fromId : fromId;
      const parentId = connectionType === 'hierarchy' ? toId : toId;
      const childElement = document.getElementById(`org-node-${childId}`);
      const parentElement = document.getElementById(`org-node-${parentId}`);
      
      if (!childElement || !parentElement) return;
      
      const chartContainer = document.getElementById('org-chart');
      const chartRect = chartContainer.getBoundingClientRect();
      
      // Get positions relative to chart container
      const childRect = childElement.getBoundingClientRect();
      const parentRect = parentElement.getBoundingClientRect();
      
      const childX = childRect.left - chartRect.left + childRect.width / 2;
      const childY = childRect.top - chartRect.top;
      const parentX = parentRect.left - chartRect.left + parentRect.width / 2;
      const parentY = parentRect.top - chartRect.top + parentRect.height;
      
      // Style connections differently based on type
      const connectionClass = connectionType === 'custom' ? 'org-connection-custom' : 'org-connection-line';
      const pointClass = connectionType === 'custom' ? 'org-connection-custom-point' : 'org-connection-point';
      
      // For board level connections, use different approach to avoid overlap
      const parentNode = orgChartData.nodes.find(n => n.id === parentId);
      const childNode = orgChartData.nodes.find(n => n.id === childId);
      
      if (parentNode && parentNode.level === 0 && connectionType === 'hierarchy') {
        // Special handling for board connections - proper T-junction routing
        
        // For IA and CorpGov (level 0.5), connect directly to board center
        if (childNode && childNode.level === 0.5) {
          // Create a T-junction below the board
          const junctionY = parentY + 30; // Junction point below board
          
          // Vertical line from board down to junction level
          const boardVertical = document.createElement('div');
          boardVertical.className = `${connectionClass} org-connection-vertical`;
          boardVertical.style.left = `${parentX - 1}px`;
          boardVertical.style.top = `${parentY}px`;
          boardVertical.style.height = `${junctionY - parentY}px`;
          
          // Horizontal line from board center to child position
          const horizontalConnector = document.createElement('div');
          horizontalConnector.className = `${connectionClass} org-connection-horizontal`;
          horizontalConnector.style.left = `${Math.min(parentX, childX)}px`;
          horizontalConnector.style.top = `${junctionY - 1}px`;
          horizontalConnector.style.width = `${Math.abs(childX - parentX) + 2}px`;
          
          // Vertical line from junction down to child
          const childVertical = document.createElement('div');
          childVertical.className = `${connectionClass} org-connection-vertical`;
          childVertical.style.left = `${childX - 1}px`;
          childVertical.style.top = `${junctionY}px`;
          childVertical.style.height = `${childY - junctionY}px`;
          
          // Connection points
          const parentPoint = document.createElement('div');
          parentPoint.className = pointClass;
          parentPoint.style.left = `${parentX}px`;
          parentPoint.style.top = `${parentY}px`;
          
          const junctionPoint = document.createElement('div');
          junctionPoint.className = pointClass;
          junctionPoint.style.left = `${parentX}px`;
          junctionPoint.style.top = `${junctionY}px`;
          
          const childJunctionPoint = document.createElement('div');
          childJunctionPoint.className = pointClass;
          childJunctionPoint.style.left = `${childX}px`;
          childJunctionPoint.style.top = `${junctionY}px`;
          
          const childPoint = document.createElement('div');
          childPoint.className = pointClass;
          childPoint.style.left = `${childX}px`;
          childPoint.style.top = `${childY}px`;
          
          chartContainer.appendChild(boardVertical);
          chartContainer.appendChild(horizontalConnector);
          chartContainer.appendChild(childVertical);
          chartContainer.appendChild(parentPoint);
          chartContainer.appendChild(junctionPoint);
          chartContainer.appendChild(childJunctionPoint);
          chartContainer.appendChild(childPoint);
        } else {
          // For CEO and other direct board reports
          const junctionY = parentY + 50; // Lower junction for CEO
          
          // Vertical line from board down to junction
          const boardVertical = document.createElement('div');
          boardVertical.className = `${connectionClass} org-connection-vertical`;
          boardVertical.style.left = `${parentX - 1}px`;
          boardVertical.style.top = `${parentY}px`;
          boardVertical.style.height = `${junctionY - parentY}px`;
          
          // Horizontal line (if needed)
          if (Math.abs(childX - parentX) > 5) {
            const horizontalConnector = document.createElement('div');
            horizontalConnector.className = `${connectionClass} org-connection-horizontal`;
            horizontalConnector.style.left = `${Math.min(parentX, childX)}px`;
            horizontalConnector.style.top = `${junctionY - 1}px`;
            horizontalConnector.style.width = `${Math.abs(childX - parentX) + 2}px`;
            chartContainer.appendChild(horizontalConnector);
          }
          
          // Vertical line to child
          const childVertical = document.createElement('div');
          childVertical.className = `${connectionClass} org-connection-vertical`;
          childVertical.style.left = `${childX - 1}px`;
          childVertical.style.top = `${junctionY}px`;
          childVertical.style.height = `${childY - junctionY}px`;
          
          // Connection points
          const parentPoint = document.createElement('div');
          parentPoint.className = pointClass;
          parentPoint.style.left = `${parentX}px`;
          parentPoint.style.top = `${parentY}px`;
          
          const junctionPoint = document.createElement('div');
          junctionPoint.className = pointClass;
          junctionPoint.style.left = `${parentX}px`;
          junctionPoint.style.top = `${junctionY}px`;
          
          if (Math.abs(childX - parentX) > 5) {
            const childJunctionPoint = document.createElement('div');
            childJunctionPoint.className = pointClass;
            childJunctionPoint.style.left = `${childX}px`;
            childJunctionPoint.style.top = `${junctionY}px`;
            chartContainer.appendChild(childJunctionPoint);
          }
          
          const childPoint = document.createElement('div');
          childPoint.className = pointClass;
          childPoint.style.left = `${childX}px`;
          childPoint.style.top = `${childY}px`;
          
          chartContainer.appendChild(boardVertical);
          chartContainer.appendChild(childVertical);
          chartContainer.appendChild(parentPoint);
          chartContainer.appendChild(junctionPoint);
          chartContainer.appendChild(childPoint);
        }
      } else {
        // Standard connection for other levels
        const midY = parentY + (childY - parentY) / 2;
        
        // For custom connections, use direct line approach
        if (connectionType === 'custom') {
          // Simple direct line for custom connections
          const directLine = document.createElement('div');
          directLine.className = `${connectionClass} org-connection-horizontal`;
          
          const angle = Math.atan2(childY - parentY, childX - parentX) * 180 / Math.PI;
          const length = Math.sqrt(Math.pow(childX - parentX, 2) + Math.pow(childY - parentY, 2));
          
          directLine.style.left = `${parentX}px`;
          directLine.style.top = `${parentY - 1}px`;
          directLine.style.width = `${length}px`;
          directLine.style.transformOrigin = '0 50%';
          directLine.style.transform = `rotate(${angle}deg)`;
          
          // Connection points for custom connections
          const startPoint = document.createElement('div');
          startPoint.className = pointClass;
          startPoint.style.left = `${parentX}px`;
          startPoint.style.top = `${parentY}px`;
          
          const endPoint = document.createElement('div');
          endPoint.className = pointClass;
          endPoint.style.left = `${childX}px`;
          endPoint.style.top = `${childY}px`;
          
          chartContainer.appendChild(directLine);
          chartContainer.appendChild(startPoint);
          chartContainer.appendChild(endPoint);
        } else {
          // Standard T-junction for hierarchy connections
          const midY = parentY + (childY - parentY) / 2;
          
          // Create vertical line from parent (downward)
          const verticalLine1 = document.createElement('div');
          verticalLine1.className = `${connectionClass} org-connection-vertical`;
          verticalLine1.style.left = `${parentX - 1}px`;
          verticalLine1.style.top = `${parentY}px`;
          verticalLine1.style.height = `${midY - parentY}px`;
          
          // Create horizontal line (connecting line)
          const horizontalLine = document.createElement('div');
          horizontalLine.className = `${connectionClass} org-connection-horizontal`;
          horizontalLine.style.left = `${Math.min(parentX, childX)}px`;
          horizontalLine.style.top = `${midY - 1}px`;
          horizontalLine.style.width = `${Math.abs(childX - parentX) + 2}px`;
          
          // Create vertical line to child (downward)
          const verticalLine2 = document.createElement('div');
          verticalLine2.className = `${connectionClass} org-connection-vertical`;
          verticalLine2.style.left = `${childX - 1}px`;
          verticalLine2.style.top = `${midY}px`;
          verticalLine2.style.height = `${childY - midY}px`;
          
          // Create formal connection points
          const parentPoint = document.createElement('div');
          parentPoint.className = pointClass;
          parentPoint.style.left = `${parentX}px`;
          parentPoint.style.top = `${parentY}px`;
          
          const junctionPoint = document.createElement('div');
          junctionPoint.className = pointClass;
          junctionPoint.style.left = `${parentX}px`;
          junctionPoint.style.top = `${midY}px`;
          
          const childJunctionPoint = document.createElement('div');
          childJunctionPoint.className = pointClass;
          childJunctionPoint.style.left = `${childX}px`;
          childJunctionPoint.style.top = `${midY}px`;
          
          const childPoint = document.createElement('div');
          childPoint.className = pointClass;
          childPoint.style.left = `${childX}px`;
          childPoint.style.top = `${childY}px`;
          
          // Add to container
          chartContainer.appendChild(verticalLine1);
          chartContainer.appendChild(horizontalLine);
          chartContainer.appendChild(verticalLine2);
          chartContainer.appendChild(parentPoint);
          chartContainer.appendChild(junctionPoint);
          chartContainer.appendChild(childJunctionPoint);
          chartContainer.appendChild(childPoint);
        }

      }
    }

    function clearConnections() {
      const chartContainer = document.getElementById('org-chart');
      const connections = chartContainer.querySelectorAll('.org-connection-line, .org-connection-point');
      connections.forEach(conn => conn.remove());
    }

    function selectOrgNode(node) {
      // Clear previous selection
      document.querySelectorAll('.org-node-selected').forEach(el => {
        el.classList.remove('org-node-selected');
      });
      
      // Select new node
      const nodeElement = document.getElementById(`org-node-${node.id}`);
      nodeElement.classList.add('org-node-selected');
      
      selectedNode = node;
    }

    function expandNode(nodeId) {
      const node = orgChartData.nodes.find(n => n.id === nodeId);
      if (!node || !node.hasChildren) return;
      
      // Create new page for this node's children
      const newPageId = `${nodeId}-details`;
      
      // Check if page already exists
      if (!orgChartData.pages[newPageId]) {
        // Create sample children for demonstration with proper spacing
        const childNodes = [
          {
            id: `${nodeId}-dept1`,
            title: `${node.title.replace('Chief ', '').replace(' Officer', '')} - Department A`,
            parent: `${nodeId}-parent`,
            type: 'org-unit',
            color: 'white',
            size: 'medium',
            level: 2,
            x: 150,
            y: 250,
            hasChildren: false
          },
          {
            id: `${nodeId}-dept2`,
            title: `${node.title.replace('Chief ', '').replace(' Officer', '')} - Department B`,
            parent: `${nodeId}-parent`,
            type: 'org-unit',
            color: 'white',
            size: 'medium',
            level: 2,
            x: 400,
            y: 250,
            hasChildren: false
          },
          {
            id: `${nodeId}-dept3`,
            title: `${node.title.replace('Chief ', '').replace(' Officer', '')} - Department C`,
            parent: `${nodeId}-parent`,
            type: 'org-unit',
            color: 'white',
            size: 'medium',
            level: 2,
            x: 650,
            y: 250,
            hasChildren: false
          }
        ];
        
        // Add parent node to new page (copy of the expanded node)
        const parentNode = {
          id: `${nodeId}-parent`,
          title: node.title,
          parent: null,
          type: node.type,
          color: node.color,
          size: node.size,
          level: 1,
          x: 400,
          y: 80,
          hasChildren: false
        };
        
        // Add nodes to main data
        orgChartData.nodes.push(parentNode);
        orgChartData.nodes.push(...childNodes);
        
        // Create new page
        orgChartData.pages[newPageId] = {
          title: `${node.title} Structure`,
          nodes: [parentNode.id, ...childNodes.map(n => n.id)]
        };
      }
      
      // Switch to new page
      switchOrgTab(newPageId);
    }

    function switchOrgTab(pageId) {
      currentOrgPage = pageId;
      
      // Update tab UI
      updateOrgTabs();
      
      // Render chart for new page with smooth transition
      const chartContainer = document.getElementById('org-chart');
      chartContainer.classList.add('org-page-transition');
      
      setTimeout(() => {
        renderOrgChart();
        chartContainer.classList.add('active');
      }, 50);
      
      setTimeout(() => {
        chartContainer.classList.remove('org-page-transition');
      }, 450);
    }

    function updateOrgTabs() {
      const tabsContainer = document.getElementById('org-tabs');
      tabsContainer.innerHTML = '';
      
      Object.keys(orgChartData.pages).forEach(pageId => {
        const page = orgChartData.pages[pageId];
        const tab = document.createElement('div');
        tab.className = `org-tab ${pageId === currentOrgPage ? 'active' : ''}`;
        tab.onclick = () => switchOrgTab(pageId);
        
        const titleSpan = document.createElement('span');
        titleSpan.textContent = page.title;
        tab.appendChild(titleSpan);
        
        // Add close button for non-main tabs
        if (pageId !== 'main') {
          const closeBtn = document.createElement('span');
          closeBtn.innerHTML = '√ó';
          closeBtn.className = 'tab-close';
          closeBtn.onclick = (e) => {
            e.stopPropagation();
            closeOrgTab(pageId);
          };
          tab.appendChild(closeBtn);
        }
        
        tabsContainer.appendChild(tab);
      });
    }

    function closeOrgTab(pageId) {
      if (pageId === 'main') return; // Can't close main tab
      
      // Get page nodes before deletion
      const pageNodes = orgChartData.pages[pageId]?.nodes || [];
      
      // Remove page
      delete orgChartData.pages[pageId];
      
      // Remove associated nodes
      orgChartData.nodes = orgChartData.nodes.filter(node => !pageNodes.includes(node.id));
      
      // Switch to main tab if current tab is being closed
      if (currentOrgPage === pageId) {
        switchOrgTab('main');
      } else {
        updateOrgTabs();
      }
    }

    function handleAnchorClick(event, nodeId, anchor) {
      event.stopPropagation();
      
      if (!connectionMode) return;
      
      const node = orgChartData.nodes.find(n => n.id === nodeId);
      if (!node) return;
      
      if (!connectionStart) {
        // First click - select start node and anchor
        connectionStart = { nodeId: nodeId, anchor: anchor };
        
        // Visual feedback - highlight selected anchor
        document.querySelectorAll('.connection-anchor.active').forEach(el => {
          el.classList.remove('active');
        });
        
        event.target.classList.add('active');
        
        // Show feedback
        showActionFeedback(`üìç Selected ${node.title} (${anchor})`);
        
      } else if (connectionStart.nodeId === nodeId) {
        // Clicked same node - deselect
        connectionStart = null;
        document.querySelectorAll('.connection-anchor.active').forEach(el => {
          el.classList.remove('active');
        });
        showActionFeedback('‚ùå Connection cancelled');
        
      } else {
        // Second click - create connection
        const startNode = orgChartData.nodes.find(n => n.id === connectionStart.nodeId);
        const endNode = orgChartData.nodes.find(n => n.id === nodeId);
        
        const existingConnection = customConnections.find(conn => 
          (conn.from === connectionStart.nodeId && conn.to === nodeId) ||
          (conn.from === nodeId && conn.to === connectionStart.nodeId)
        );
        
        if (existingConnection) {
          // Remove existing connection
          saveState('Remove Custom Connection');
          customConnections = customConnections.filter(conn => conn !== existingConnection);
          showActionFeedback(`üóëÔ∏è Removed connection: ${startNode.title} ‚Üî ${endNode.title}`);
        } else {
          // Add new connection with anchor information
          saveState('Add Custom Connection');
          customConnections.push({
            from: connectionStart.nodeId,
            fromAnchor: connectionStart.anchor,
            to: nodeId,
            toAnchor: anchor,
            type: 'custom'
          });
          showActionFeedback(`üîó Connected: ${startNode.title} ‚Üí ${endNode.title}`);
        }
        
        // Reset selection
        connectionStart = null;
        document.querySelectorAll('.connection-anchor.active').forEach(el => {
          el.classList.remove('active');
        });
        
        // Redraw connections
        clearConnections();
        drawOrgConnections();
      }
    }
    
    function createNewPage() {
      const pageName = prompt('Enter page name:');
      if (!pageName || pageName.trim() === '') return;
      
      saveState('Create New Page');
      
      const pageId = `custom-${Date.now()}`;
      
      orgChartData.pages[pageId] = {
        title: pageName.trim(),
        nodes: []
      };
      
      // Update tabs and switch to new page
      updateOrgTabs();
      switchOrgTab(pageId);
      
      showActionFeedback(`üìÑ Created page: ${pageName}`);
    }

    // Edit Mode Functions
    function toggleEditMode() {
      orgEditMode = !orgEditMode;
      const btn = document.getElementById('edit-mode-btn');
      
      if (orgEditMode) {
        btn.textContent = '‚úÖ Exit Edit Mode';
        btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
      } else {
        btn.textContent = '‚úèÔ∏è Edit Mode';
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        
        // Clear selection
        document.querySelectorAll('.org-node-selected').forEach(el => {
          el.classList.remove('org-node-selected');
        });
        selectedNode = null;
      }
    }

    // Modal Functions
    function openAddNodeModal() {
      // Populate parent options
      const parentSelect = document.getElementById('new-node-parent');
      parentSelect.innerHTML = '<option value="">-- Top Level --</option>';
      
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      currentPageNodes.forEach(nodeId => {
        const node = orgChartData.nodes.find(n => n.id === nodeId);
        if (node) {
          const option = document.createElement('option');
          option.value = node.id;
          option.textContent = node.title;
          parentSelect.appendChild(option);
        }
      });
      
      document.getElementById('add-node-modal').classList.remove('hidden');
    }

    function closeAddNodeModal() {
      document.getElementById('add-node-modal').classList.add('hidden');
      // Reset form
      document.getElementById('new-node-title').value = '';
      document.getElementById('new-node-parent').value = '';
      document.getElementById('new-node-level').value = '1';
      document.getElementById('new-node-type').value = 'org-unit';
      document.getElementById('new-node-color').value = 'white';
      document.getElementById('new-node-size').value = 'medium';
    }

    function createNewOrgNode(event) {
      event.preventDefault();
      
      saveState('Add New Node');
      
      const title = document.getElementById('new-node-title').value;
      const parent = document.getElementById('new-node-parent').value || null;
      const level = parseFloat(document.getElementById('new-node-level').value);
      const type = document.getElementById('new-node-type').value;
      const color = document.getElementById('new-node-color').value;
      const size = document.getElementById('new-node-size').value;
      
      // Smart positioning based on parent and siblings
      let x, y;
      
      if (parent) {
        // Find parent node
        const parentNode = orgChartData.nodes.find(n => n.id === parent);
        if (parentNode) {
          // Find siblings (nodes with same parent)
          const siblings = orgChartData.nodes.filter(n => n.parent === parent && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
          
          // Position based on parent and siblings
          const siblingCount = siblings.length;
          const spacing = 200; // Space between siblings
          
          if (siblingCount === 0) {
            // First child - position directly below parent
            x = parentNode.x;
            y = parentNode.y + 150;
          } else {
            // Additional children - spread horizontally
            const totalWidth = (siblingCount + 1) * spacing;
            const startX = parentNode.x - (totalWidth / 2) + (spacing / 2);
            x = startX + (siblingCount * spacing);
            y = parentNode.y + 150;
          }
        } else {
          // Fallback if parent not found
          const levelNodes = orgChartData.nodes.filter(n => n.level === level && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
          x = 150 + (levelNodes.length * 200);
          y = 50 + (level * 150);
        }
      } else {
        // Top level node
        const levelNodes = orgChartData.nodes.filter(n => n.level === level && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
        x = 150 + (levelNodes.length * 200);
        y = 50 + (level * 150);
      }
      
      const newNode = {
        id: `node-${nodeIdCounter++}`,
        title: title,
        parent: parent,
        type: type,
        color: color,
        size: size,
        level: level,
        x: x,
        y: y,
        hasChildren: false
      };
      
      // Add to nodes
      orgChartData.nodes.push(newNode);
      
      // Add to current page
      orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      
      // Re-render chart
      renderOrgChart();
      
      closeAddNodeModal();
      showActionFeedback(`‚ûï Added: ${title}`);
    }

    function openNodePropertiesModal(node) {
      selectedNode = node;
      
      // Populate form
      document.getElementById('prop-node-title').value = node.title;
      document.getElementById('prop-node-parent').value = node.parent || '';
      document.getElementById('prop-node-level').value = node.level;
      document.getElementById('prop-node-type').value = node.type;
      document.getElementById('prop-node-color').value = node.color;
      document.getElementById('prop-node-size').value = node.size;
      
      // Populate parent options
      const parentSelect = document.getElementById('prop-node-parent');
      parentSelect.innerHTML = '<option value="">-- Top Level --</option>';
      
      orgChartData.nodes.forEach(n => {
        if (n.id !== node.id) { // Don't allow self-parenting
          const option = document.createElement('option');
          option.value = n.id;
          option.textContent = n.title;
          if (n.id === node.parent) option.selected = true;
          parentSelect.appendChild(option);
        }
      });
      
      document.getElementById('node-properties-modal').classList.remove('hidden');
    }

    function closeNodePropertiesModal() {
      document.getElementById('node-properties-modal').classList.add('hidden');
      selectedNode = null;
    }

    function updateNodeProperties(event) {
      event.preventDefault();
      
      if (!selectedNode) return;
      
      saveState('Update Node Properties');
      
      const title = document.getElementById('prop-node-title').value;
      const parent = document.getElementById('prop-node-parent').value || null;
      const level = parseInt(document.getElementById('prop-node-level').value);
      const type = document.getElementById('prop-node-type').value;
      const color = document.getElementById('prop-node-color').value;
      const size = document.getElementById('prop-node-size').value;
      
      // Find and update node
      const nodeIndex = orgChartData.nodes.findIndex(n => n.id === selectedNode.id);
      if (nodeIndex !== -1) {
        orgChartData.nodes[nodeIndex] = {
          ...orgChartData.nodes[nodeIndex],
          title: title,
          parent: parent,
          level: level,
          type: type,
          color: color,
          size: size
        };
      }
      
      // Re-render chart
      renderOrgChart();
      
      closeNodePropertiesModal();
      showActionFeedback(`‚úèÔ∏è Updated: ${title}`);
    }

    function deleteSelectedNode() {
      if (!selectedNode) return;
      
      if (confirm(`Are you sure you want to delete "${selectedNode.title}"?`)) {
        saveState('Delete Node');
        
        const nodeName = selectedNode.title;
        
        // Remove from nodes
        orgChartData.nodes = orgChartData.nodes.filter(n => n.id !== selectedNode.id);
        
        // Remove from all pages
        Object.keys(orgChartData.pages).forEach(pageId => {
          orgChartData.pages[pageId].nodes = orgChartData.pages[pageId].nodes.filter(nodeId => nodeId !== selectedNode.id);
        });
        
        // Remove any custom connections involving this node
        customConnections = customConnections.filter(conn => 
          conn.from !== selectedNode.id && conn.to !== selectedNode.id
        );
        
        // Re-render chart
        renderOrgChart();
        
        closeNodePropertiesModal();
        showActionFeedback(`üóëÔ∏è Deleted: ${nodeName}`);
      }
    }

    // Zoom functions
    function zoomOrgChart(direction) {
      if (direction === 'in') {
        orgZoomLevel = Math.min(orgZoomLevel + 0.1, 2);
      } else {
        orgZoomLevel = Math.max(orgZoomLevel - 0.1, 0.5);
      }
      
      const chartContainer = document.getElementById('org-chart');
      chartContainer.style.transform = `scale(${orgZoomLevel})`;
      chartContainer.style.transformOrigin = 'top left';
      
      document.getElementById('zoom-level').textContent = `${Math.round(orgZoomLevel * 100)}%`;
    }

    function resetOrgView() {
      orgZoomLevel = 1;
      const chartContainer = document.getElementById('org-chart');
      chartContainer.style.transform = 'scale(1)';
      document.getElementById('zoom-level').textContent = '100%';
    }

    // Quick Add Functions - Version 43 Style Easy Addition
    function quickAddOrgUnit() {
      saveState('Quick Add Org Unit');
      
      // Simple one-click addition under CEO with smart positioning
      const ceoNode = orgChartData.nodes.find(n => n.id === 'ceo');
      if (!ceoNode) return;
      
      // Count existing children under CEO
      const ceoChildren = orgChartData.nodes.filter(n => n.parent === 'ceo' && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
      const childIndex = ceoChildren.length;
      
      // Smart positioning - spread evenly under CEO
      const spacing = 200;
      const totalChildren = childIndex + 1;
      const totalWidth = totalChildren * spacing;
      const startX = ceoNode.x - (totalWidth / 2) + (spacing / 2);
      const x = startX + (childIndex * spacing);
      const y = ceoNode.y + 130; // Consistent spacing below CEO
      
      const newNode = {
        id: `unit-${nodeIdCounter++}`,
        title: `New Unit ${childIndex + 1}`,
        parent: 'ceo',
        type: 'org-unit',
        color: 'green',
        size: 'medium',
        level: 2,
        x: x,
        y: y,
        hasChildren: true
      };
      
      orgChartData.nodes.push(newNode);
      orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      
      renderOrgChart();
      showActionFeedback(`üè¢ Added: ${newNode.title}`);
      
      // Auto-select for immediate editing
      setTimeout(() => {
        selectOrgNode(newNode);
        if (confirm('Edit this unit now?')) {
          openNodePropertiesModal(newNode);
        }
      }, 100);
    }

    function quickAddPosition() {
      saveState('Quick Add Position');
      
      // Simple one-click addition under CEO with smart positioning
      const ceoNode = orgChartData.nodes.find(n => n.id === 'ceo');
      if (!ceoNode) return;
      
      // Count existing children under CEO
      const ceoChildren = orgChartData.nodes.filter(n => n.parent === 'ceo' && orgChartData.pages[currentOrgPage].nodes.includes(n.id));
      const childIndex = ceoChildren.length;
      
      // Smart positioning - spread evenly under CEO
      const spacing = 200;
      const totalChildren = childIndex + 1;
      const totalWidth = totalChildren * spacing;
      const startX = ceoNode.x - (totalWidth / 2) + (spacing / 2);
      const x = startX + (childIndex * spacing);
      const y = ceoNode.y + 130; // Consistent spacing below CEO
      
      const newNode = {
        id: `pos-${nodeIdCounter++}`,
        title: `New Position ${childIndex + 1}`,
        parent: 'ceo',
        type: 'position',
        color: 'green',
        size: 'medium',
        level: 2,
        x: x,
        y: y,
        hasChildren: false
      };
      
      orgChartData.nodes.push(newNode);
      orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      
      renderOrgChart();
      showActionFeedback(`üë§ Added: ${newNode.title}`);
      
      // Auto-select for immediate editing
      setTimeout(() => {
        selectOrgNode(newNode);
        if (confirm('Edit this position now?')) {
          openNodePropertiesModal(newNode);
        }
      }, 100);
    }

    // Organization Templates
    const orgTemplates = {
      corporate: {
        name: 'Corporate Structure',
        nodes: [
          { id: 'board', title: 'Board of Directors', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'ceo', title: 'Chief Executive Officer', parent: 'board', type: 'org-unit', color: 'white', size: 'large', level: 2, x: 400, y: 180, hasChildren: true },
          { id: 'cfo', title: 'Chief Financial Officer', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 3, x: 200, y: 320, hasChildren: false },
          { id: 'coo', title: 'Chief Operating Officer', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 3, x: 400, y: 320, hasChildren: false },
          { id: 'cto', title: 'Chief Technology Officer', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 3, x: 600, y: 320, hasChildren: false }
        ]
      },
      functional: {
        name: 'Functional Organization',
        nodes: [
          { id: 'ceo', title: 'Chief Executive Officer', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'hr', title: 'Human Resources', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 150, y: 180, hasChildren: false },
          { id: 'finance', title: 'Finance', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 300, y: 180, hasChildren: false },
          { id: 'operations', title: 'Operations', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 450, y: 180, hasChildren: false },
          { id: 'marketing', title: 'Marketing', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 600, y: 180, hasChildren: false },
          { id: 'it', title: 'Information Technology', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 750, y: 180, hasChildren: false }
        ]
      },
      divisional: {
        name: 'Divisional Structure',
        nodes: [
          { id: 'ceo', title: 'Chief Executive Officer', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'div1', title: 'Consumer Division', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 2, x: 200, y: 180, hasChildren: true },
          { id: 'div2', title: 'Enterprise Division', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 2, x: 400, y: 180, hasChildren: true },
          { id: 'div3', title: 'International Division', parent: 'ceo', type: 'org-unit', color: 'red', size: 'medium', level: 2, x: 600, y: 180, hasChildren: true },
          { id: 'support', title: 'Corporate Support', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 2, x: 800, y: 180, hasChildren: false }
        ]
      },
      matrix: {
        name: 'Matrix Organization',
        nodes: [
          { id: 'ceo', title: 'Chief Executive Officer', parent: null, type: 'org-unit', color: 'white', size: 'large', level: 1, x: 400, y: 50, hasChildren: true },
          { id: 'proj1', title: 'Project Alpha', parent: 'ceo', type: 'position', color: 'red', size: 'medium', level: 2, x: 200, y: 180, hasChildren: false },
          { id: 'proj2', title: 'Project Beta', parent: 'ceo', type: 'position', color: 'red', size: 'medium', level: 2, x: 400, y: 180, hasChildren: false },
          { id: 'proj3', title: 'Project Gamma', parent: 'ceo', type: 'position', color: 'red', size: 'medium', level: 2, x: 600, y: 180, hasChildren: false },
          { id: 'eng', title: 'Engineering', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 3, x: 150, y: 320, hasChildren: false },
          { id: 'design', title: 'Design', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 3, x: 350, y: 320, hasChildren: false },
          { id: 'qa', title: 'Quality Assurance', parent: 'ceo', type: 'org-unit', color: 'green', size: 'medium', level: 3, x: 550, y: 320, hasChildren: false }
        ]
      }
    };

    function applyOrgTemplate() {
      const templateSelect = document.getElementById('org-templates');
      const templateKey = templateSelect.value;
      
      if (!templateKey || !orgTemplates[templateKey]) {
        templateSelect.value = '';
        return;
      }
      
      if (!confirm(`Apply ${orgTemplates[templateKey].name} template? This will replace the current structure.`)) {
        templateSelect.value = '';
        return;
      }
      
      // Clear current nodes for main page
      orgChartData.pages[currentOrgPage].nodes = [];
      
      // Remove old nodes that were on main page
      orgChartData.nodes = orgChartData.nodes.filter(node => 
        !['board', 'ceo', 'audit', 'governance'].includes(node.id)
      );
      
      // Add template nodes
      const template = orgTemplates[templateKey];
      template.nodes.forEach(nodeTemplate => {
        const newNode = {
          ...nodeTemplate,
          id: nodeTemplate.id + '-' + Date.now() // Make unique
        };
        
        // Update parent references
        if (newNode.parent) {
          newNode.parent = newNode.parent + '-' + Date.now();
        }
        
        orgChartData.nodes.push(newNode);
        orgChartData.pages[currentOrgPage].nodes.push(newNode.id);
      });
      
      // Fix parent references
      orgChartData.nodes.forEach(node => {
        if (node.parent) {
          const parentNode = orgChartData.nodes.find(n => 
            n.id.startsWith(node.parent.split('-')[0]) && n.id !== node.id
          );
          if (parentNode) {
            node.parent = parentNode.id;
          }
        }
      });
      
      renderOrgChart();
      templateSelect.value = '';
    }

    function autoLayout() {
      if (!confirm('Auto-arrange all nodes? This will reorganize the current layout.')) return;
      
      saveState('Auto Layout');
      
      const currentPageNodes = orgChartData.pages[currentOrgPage].nodes;
      const nodes = currentPageNodes.map(nodeId => 
        orgChartData.nodes.find(n => n.id === nodeId)
      ).filter(Boolean);
      
      // Group by level
      const levelGroups = {};
      nodes.forEach(node => {
        if (!levelGroups[node.level]) {
          levelGroups[node.level] = [];
        }
        levelGroups[node.level].push(node);
      });
      
      // Auto-arrange by level
      Object.keys(levelGroups).forEach(level => {
        const levelNodes = levelGroups[level];
        const levelNum = parseInt(level);
        const y = 50 + (levelNum - 1) * 150;
        
        levelNodes.forEach((node, index) => {
          const totalWidth = levelNodes.length * 200;
          const startX = Math.max(100, (800 - totalWidth) / 2);
          node.x = startX + (index * 200);
          node.y = y;
        });
      });
      
      renderOrgChart();
      showActionFeedback('‚ú® Auto-arranged all nodes');
    }

    // Connection Management Functions
    function toggleConnectionMode() {
      connectionMode = !connectionMode;
      const btn = document.getElementById('connection-mode-btn');
      
      if (connectionMode) {
        btn.textContent = '‚ùå Exit Connect';
        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        btn.classList.add('bg-red-600', 'hover:bg-red-700');
        
        // Add visual indicators to all nodes
        document.querySelectorAll('.org-node').forEach(node => {
          node.classList.add('connection-mode-active');
        });
        
        connectionStart = null;
      } else {
        btn.textContent = 'üîó Connect Mode';
        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        
        // Remove visual indicators
        document.querySelectorAll('.org-node').forEach(node => {
          node.classList.remove('connection-mode-active', 'connection-start-selected');
        });
        
        connectionStart = null;
      }
    }

    function handleConnectionClick(node) {
      if (!connectionStart) {
        // First click - select start node
        connectionStart = node;
        
        // Visual feedback
        document.querySelectorAll('.org-node').forEach(n => {
          n.classList.remove('connection-start-selected');
        });
        
        const nodeElement = document.getElementById(`org-node-${node.id}`);
        nodeElement.classList.add('connection-start-selected');
        
      } else if (connectionStart.id === node.id) {
        // Clicked same node - deselect
        connectionStart = null;
        document.querySelectorAll('.org-node').forEach(n => {
          n.classList.remove('connection-start-selected');
        });
        
      } else {
        // Second click - create connection
        const existingConnection = customConnections.find(conn => 
          (conn.from === connectionStart.id && conn.to === node.id) ||
          (conn.from === node.id && conn.to === connectionStart.id)
        );
        
        if (existingConnection) {
          // Remove existing connection
          customConnections = customConnections.filter(conn => conn !== existingConnection);
        } else {
          // Add new connection
          customConnections.push({
            from: connectionStart.id,
            to: node.id,
            type: 'custom'
          });
        }
        
        // Reset selection
        connectionStart = null;
        document.querySelectorAll('.org-node').forEach(n => {
          n.classList.remove('connection-start-selected');
        });
        
        // Redraw connections
        clearConnections();
        drawOrgConnections();
      }
    }

    function clearConnections() {
      const chartContainer = document.getElementById('org-chart');
      const connections = chartContainer.querySelectorAll('.org-connection-line, .org-connection-point, .org-connection-custom, .org-connection-custom-point');
      connections.forEach(conn => conn.remove());
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Only handle shortcuts when not in input fields
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        return;
      }
      
      // Ctrl+Z or Cmd+Z for Undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      }
      
      // Ctrl+Y or Cmd+Shift+Z for Redo
      if (((e.ctrlKey || e.metaKey) && e.key === 'y') || 
          ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z')) {
        e.preventDefault();
        redo();
      }
      
      // Escape to exit connection mode
      if (e.key === 'Escape' && connectionMode) {
        toggleConnectionMode();
      }
    });

    // Initialize on page load
    window.addEventListener('load', function() {
      // Set up initial org chart
      updateOrgTabs();
      updateUndoRedoButtons();
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96dc5c1ff083d007',t:'MTc1NDk2MzgyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
